<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0,viewport-fit=cover" name="viewport"/>
<title>Yes, Sire. - V10.4</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&amp;display=swap" rel="stylesheet"/>
<style>
  :root{
    /* Themed dropdown styling */
select.input {
  background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: var(--ui-radius);
  color: var(--fg);
  font-weight: 600;
  padding: 8px 10px;
  appearance: none;
  background-image: url('data:image/svg+xml;utf8,<svg fill="%23eaf4ff" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,7 15,7 10,12"/></svg>');
  background-repeat: no-repeat;
  background-position: right 8px center;
  background-size: 14px;
}
select.input:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--accent-a);
}
    --bg-dark-1:#071029; --bg-dark-2:#07182b;
    --fg:#eaf4ff; --muted:#9fb0c8;
    --accent-a:#ff7a18; --accent-b:#ffd166;
    --glass: rgba(255,255,255,0.03);
    --good:#64d368; --bad:#ff6b6b;
    --max-width:1180px;
    --ui-radius:14px;
  }

 /* Basic layout */
* { box-sizing: border-box; }

html, body {
  height: 100%;
  margin: 0;  
  font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
  background: transparent;   /* remove forced gradient */
  color: var(--fg);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}


.app {
  min-height: 100vh;
  display: flex;
  align-items: stretch;
  padding: 22px;
  justify-content: center;
}

.container {
  width: 100%;
  max-width: var(--max-width);
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 18px;
  position: relative;
  z-index: 2;
}

  /* Container cards */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--ui-radius); padding:14px; box-shadow:0 10px 40px rgba(0,0,0,0.6);backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,0.02)}
  /* Fixed height scenario card with fade-out and smart vertical alignment */



  /* Scenario card smart alignment */

  

  .header{display:flex;justify-content:space-between;align-items:center}
  .scene{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;padding:18px;border-radius:14px;background:transparent}
  .scene-card{
    width:100%;max-width:980px;padding:28px;border-radius:12px;box-shadow:0 18px 44px rgba(0,0,0,0.55);
    transition: transform .45s cubic-bezier(.2,.9,.2,1), box-shadow .28s;
    /* improved animated gradient for the card */
    position:relative; overflow:hidden; color: #fff; text-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  @keyframes sheenMove{ 0%{transform:translateX(-30%)} 50%{transform:translateX(30%)} 100%{transform:translateX(-30%)} }

  .choices{display:flex;gap:14px;margin-top:14px}
  .choice{
    flex:1;padding:16px;border-radius:12px;border:0;font-weight:800;cursor:pointer;
    background: linear-gradient(90deg,var(--accent-a),var(--accent-b));color:#081428; box-shadow: 0 8px 28px rgba(0,0,0,0.45);
    transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s, filter .18s;
    will-change: transform, filter;
  }
  .choice.secondary{ background: linear-gradient(90deg,var(--accent-a),var(--accent-b));color:#081428; }
  .choice:active{ transform: translateY(-2px) scale(0.995); }
  
.essence-bar {
  position: relative;8 
  overflow: hidden;
}

/* overlay element */
.essence-bar::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  opacity: 0;                      /* start hidden */
  transition: opacity 0.8s ease;   /* fade timing */
}

/* show overlay immediately on gain/loss */
.essence-bar.gain::after {
  background: rgba(0, 255, 0, 0.3);
  opacity: 1;
}
.essence-bar.loss::after {
  background: rgba(255, 0, 0, 0.3);
  opacity: 1;
}

/* then fade the overlay out (bar stays visible) */
.essence-bar.fadeout::after {
  opacity: 0;
}

/* optional: respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .essence-bar::after { transition: none !important; }
}

  /* Essence bars */
  .essences{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;margin-top:12px}
  .ess{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent); transition: transform .25s, box-shadow .25s; }
  .ess:hover{ transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .label{width:140px;font-size:14px;color:var(--muted);white-space:nowrap;display:flex;align-items:center;gap:8px;padding-left:6px}
  .bar{flex:1;height:14px;background:rgba(255,255,255,0.03);border-radius:12px;overflow:hidden;position:relative}
  .bar > i{height:100%;display:block;transition:width .6s cubic-bezier(.2,.9,.3,1), background .3s, box-shadow .3s}
  .value{width:44px;text-align:right;font-weight:800}

  .log{height:160px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01));font-size:13px;margin-top:10px}
  .traits{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
  .trait{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:12px}

  /* small responsive */
  @media(max-width:980px){ .container{grid-template-columns:1fr;gap:12px} .label{width:120px} .choice{font-size:18px} }

  /* subtle keyframe for slight scaling of important panels */
  @keyframes popIn{ from{transform:translateY(6px) scale(.995);opacity:0.0} to{transform:none;opacity:1} }


/* Modal overlay & persona floating window */
.overlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background: linear-gradient(180deg, rgba(2,6,12,0.45), rgba(2,6,12,0.6));
  backdrop-filter: blur(4px);
  z-index:50;
}

.overlay .card:focus{ box-shadow: 0 30px 90px rgba(2,6,23,0.9), 0 0 0 4px rgba(255,255,255,0.04); }
.overlay .choice{ min-height:44px; padding:12px; }
.overlay[aria-hidden="false"] { display:flex; }

#sceneCard {
  position: relative;
  height: 140px;
  overflow-y: auto;
  padding: 10px 14px;
  display: flex;
}

#sceneCard.centered {
  align-items: center;
  justify-content: center;
}
  align-items: center;
  justify-content: center;
}

#sceneCard.topAligned {
  align-items: flex-start;
}

.sceneText {
  text-align: center;
  max-width: 100%;
  display: inline-block;
  max-width: 100%;
  text-shadow: none;
}
  text-align: center;
  width: 100%;
}

#sceneCard::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 32px;
  background: linear-gradient(to bottom, rgba(7,16,41,0), var(--bg-dark-1));
  pointer-events: none;
}

.sceneWrapper {
  width: 100%;
  display: flex;
  justify-content: center;
}
  /* V9.8: Fade-in + slight pop for Mini Event announcements */
@keyframes fadeInPop {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.fade-in-pop {
  animation: fadeInPop 0.4s ease;
}

  /* V9.8: Highlight style for Mini Event log entries */
.mini-event-log {
  color: var(--accent-a);
  font-weight: 700;
}
/* V9.7.5: NPC Scenario styling */
.npc-scenario {
  border: 3px solid gold;
  box-shadow: 0 0 18px gold;
}

/* === Queen Arc Popup Themed Styling === */

/* Overlay with blur stays the same */
.queen-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(4px);
  opacity: 0;
  transition: opacity 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

.queen-popup-overlay.show {
  opacity: 1;
}

.queen-popup {
  border-radius: 12px;
  padding: 20px 25px;
  max-width: 80%;
  text-align: center;
  font-style: italic;
  font-weight: 300;
  font-size: 18px;
  transform: scale(0.9);
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
  z-index: 9999;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* Entrance animation */
.queen-popup.show {
  transform: scale(1);
  opacity: 1;
}

/* ðŸ”¹ Light mode */
body.light-mode .queen-popup {
  background: rgba(255, 255, 255, 0.95);
}
body.light-mode .queen-popup-text {
  color: #000;
}

/* ðŸ”¹ Dark mode */
body.dark-mode .queen-popup {
  background: rgba(30, 30, 30, 0.95);
}
body.dark-mode .queen-popup-text {
  color: #f1f1f1;
}

/* Ending color themes */
.queen-fail-early {
  background: rgba(200, 200, 200, 0.95); /* cold gray */
}

.queen-fail-mid {
  background: rgba(218, 165, 32, 0.9); /* faded gold */
}

.queen-fail-late {
  background: rgba(139, 0, 0, 0.9); /* deep crimson */
}

.queen-success {
  background: rgba(128, 0, 128, 0.9); /* royal purple */
  color: #fff;
}

/* Close button */
.queen-popup-close {
  margin-top: 15px;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  color: #000;
  cursor: pointer;
  transition: background 0.3s;
}

.queen-popup-close:hover {
  background: rgba(255, 255, 255, 1);
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}


.app {
  display: flex;
  justify-content: center;  /* center horizontally */
  width: 100%;
  min-height: 100%;
}

.container {
  width: calc(100vw);
  height: auto;
}

.toggle-btn {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s ease;
}

.toggle-btn:hover {
  background: rgba(255,255,255,0.15);
  color: var(--fg);
}

.toggle-btn.on {
  background: linear-gradient(90deg,var(--accent-a),var(--accent-b));
  color: #081428;
  font-weight: 600;
}

.footer-small {
  font-size: 0.75em;     /* smaller text */
  font-style: italic;    /* italicized */
  opacity: 0.5;          /* subtle */
  margin-top: 12px;      /* move it further down */
  pointer-events: none;  /* prevent blocking clicks */
}

.footer-small {
  pointer-events: none; /* prevents it from blocking clicks */
}

#startBtn {
  width: 100px;   /* adjust as needed */
  height: 50px;   /* adjust as needed */
  font-size: 1.1em; /* optional: scale text */
}
 
#difficulty,
#theme {
  width: 160px;
  height: 22px; /* Match Previews button height */
  font-size: 0.85em;
  font-family: inherit;
  font-weight: inherit;
  border-radius: 6px;
  padding: 0 6px;
}

#difficulty:hover {
  background: linear-gradient(180deg, #555, #333); /* Match hover effect */
}

/* General card styling already applies */
#logCard {
  margin-top: 12px; /* spacing from the first card */
}


@keyframes glowFade {
    0% { box-shadow: 0 0 18px rgba(50, 205, 50, 0.8); }
    100% { box-shadow: none; }
}

/* =====================
   LIGHT THEME (START)
   ===================== */ 
   
/* Light mode variant (matches other main cards) */
body.light-mode #logCard {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(12px) saturate(100%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  color: #1b4793;
  border: 1px solid rgba(15, 51, 107, 0.25);
}

/* Prevent dropdowns from turning dark when focused */
select.input:focus {
  outline: none !important;
  background: inherit !important; /* keep same background as normal */
  color: inherit !important;
}

/* Light mode - match glass style */
body.light-mode select.input:focus {
  background: rgba(255, 255, 255, 0.30) !important;
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  border: 1px solid rgba(15, 51, 107, 0.25) !important;
  color: #0f336b !important;
}
   
   /* Light mode overlay - much lighter backdrop so glass cards stay bright */
body.light-mode .overlay {
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.6)) !important;
}
 
/* Brighter light mode for Persona Selection & Mini Event popups */
body.light-mode #nameOverlay .card,
body.light-mode #miniEventOverlay .card {
  background: rgba(255, 255, 255, 0.01) !important; /* glass white */
  backdrop-filter: blur(5px) saturate(180%);
  -webkit-backdrop-filter: blur(5px) saturate(180%);
  color: #1b4793 !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important;
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.10) !important;
}

/* Mini Event header text brighter & themed */
body.light-mode #miniEventOverlay .card > div:first-child {
  color: #fac92c !important; /* bright yellow accent */
}

body.light-mode {
  background-color: #cfe5cc; /* main light background */
  color: #1b4793; /* default text color */
}

/* Override dark radial gradient background */
body.light-mode #bg {
  background: #cfe5cc !important;
}


/* Achievements text */
body.light-mode .achievement {
  color: #fac92c;
}

/* Logs text */
body.light-mode #log {
  color: #0f336b !important; /* deep navy blue for strong contrast */
  font-weight: 500;          /* make slightly bolder */
}

/* Optional: highlight important log entries */
body.light-mode .mini-event-log {
  color: #1d6fa5 !important; /* brighter blue highlight */
  font-weight: 700;
}

/* Light mode for pop-up cards and info cards - glass style */
body.light-mode .card,
body.light-mode .essence-card,
body-light-mode .info-card { 
  background: rgba(255, 255, 255, 0.30) !important; /* glass transparency */
  backdrop-filter: blur(16px) saturate(160%);
  -webkit-backdrop-filter: blur(16px) saturate(160%);
  color: #1b4793 !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* translucent navy border */
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.10) !important; /* softer shadow */
}

/* ensure the page background shorthand is overridden (not just background-color) */
html.light-mode,
body.light-mode {
  background: #cfe5cc !important;    /* full solid / base color */
  color: #1b4793 !important;
}

/* make the dark UI overlay much lighter in light mode (so it doesn't darken the page) */
body.light-mode .app::after {
  background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)) !important;
  /* if you prefer no overlay at all, use: background: none !important; */
}

/* As a safety fallback: remove any pseudo-element dark backgrounds on scene card */
body.light-mode .scene-card::before {
  background: none !important;
  opacity: 0 !important;
}


/* Light mode glass effect cards â€” cleaned */
body.light-mode .card,
body.light-mode .essence-card,
body.light-mode .info-card,
body.light-mode .popup,
body.light-mode #queenPopup,
body.light-mode .persona-popup,
body.light-mode .scene-card:not(.oneup) {
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.28) !important;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(6px);
}

/* One-Up scenario borders (light & dark mode) */
.scene-card.oneup {
  border: 3px solid #fff;
  box-shadow: 0 0 12px rgba(255, 255, 255, 0.6),
              0 0 24px rgba(255, 255, 255, 0.4);
}

body.light-mode .scene-card.oneup {
  border: 3px solid #000;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.6),
              0 0 24px rgba(0, 0, 0, 0.4);
}

/* Keep gold border & glow for NPC Scenario cards in light mode */
body.light-mode .npc-scenario {
  border: 3px solid gold !important;
  box-shadow: 0 0 18px gold !important;
}

/* Essence labels darker & more legible */
body.light-mode #sideCard .label {
  color: #0f336b !important; /* deeper blue */
  font-weight: 600;
}

/* Essence bars brighter & higher contrast */
body.light-mode #sideCard .bar {
  background: rgba(27, 71, 147, 0.15) !important; /* pale blue track */
}

body.light-mode #sideCard .bar > i {
  box-shadow: none !important; /* remove dark shadows */
  filter: brightness(1.1); /* make filled portion pop */
}

/* Values more readable */
body.light-mode #sideCard .value {
  color: #0f336b !important;
  font-weight: 700;
}

/* Light mode toggle buttons - transparent when off, blue when on */
body.light-mode .toggle-btn {
  background: rgba(255, 255, 255, 0.30) !important; /* glassy transparent */
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* translucent border */
  color: #0f336b !important;
}

/* ON state - blue background */
body.light-mode .toggle-btn.on {
  background: linear-gradient(180deg, #4a9ed4, #2f7bb5) !important;
  color: #fff !important;
  border: none !important;
}

/* Light mode buttons - glass effect */
body.light-mode .choice,
body.light-mode .card .choice,
body.light-mode .popup .choice,
body.light-mode .panel .choice {
  background: rgba(255, 255, 255, 0.10) !important; /* glass effect */
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  color: #0f336b !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* translucent navy border */
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  transition: background 0.2s ease, border-color 0.2s ease;
}

/* Hover state - slightly brighter & border more visible */
body.light-mode .choice:hover,
body.light-mode .toggle-btn:hover,
body.light-mode .card .choice:hover,
body.light-mode .popup .choice:hover,
body.light-mode .panel .choice:hover {
  background: rgba(255, 255, 255, 0.40) !important; /* slightly brighter glass */
  border-color: rgba(15, 51, 107, 0.35) !important; /* slightly stronger */
}

/* Light mode dropdown with pastel border */
body.light-mode select.input {
  appearance: none !important;
  -webkit-appearance: none !important;
  -moz-appearance: none !important;

  background: linear-gradient(180deg, #a7d8f0, #84c7b8) !important,
              url('data:image/svg+xml;utf8,<svg fill="%230f336b" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,7 15,7 10,12"/></svg>') no-repeat right 10px center !important;
  background-size: auto, 14px !important;

  color: #0f336b !important;
  border: 1px solid rgba(15, 51, 107, 0.25) !important; /* light translucent navy border */
  border-radius: 6px;
  padding-right: 30px !important;
}

/* Light mode Essence bars - blue with outline */
body.light-mode #sideCard .bar {
  background: rgba(120, 170, 210, 0.25) !important; /* soft blue track */
  border: 1px solid rgba(15, 51, 107, 0.20) !important; /* translucent navy outline */
  border-radius: 12px;
}

body.light-mode #sideCard .bar > i {
  background: linear-gradient(180deg, #4a9ed4, #2f7bb5) !important; /* deeper blue fill */
  filter: brightness(1.05);
}

/* Dark mode - match dark theme dropdown */
body:not(.light-mode) select.input:focus {
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
  color: #fff !important;
}

/* Ensure SPECIAL scenarios keep their green border in Light Mode */
body.light-mode .scene-card.special-scenario {
  border: 3px solid limegreen !important;
  box-shadow: 0 0 12px rgba(50,205,50,.7) !important;
}

/* (Optional) cover the older 'special' class name too */
body.light-mode .scene-card.special {
  border: 3px solid limegreen !important;
  box-shadow: 0 0 12px rgba(50,205,50,.7) !important;
}

/* --- Light Theme --- */
body.light-mode #playerName {
    background: linear-gradient(145deg, #fdf6e3, #f2e4c9);
    border: 2px solid #b88646;
    color: #4a2d15;
    box-shadow:
        0 0 6px rgba(184, 134, 70, 0.3),
        inset 0 0 3px rgba(255, 255, 255, 0.6);
}

body.light-mode #playerName::placeholder {
    color: rgba(74, 45, 21, 0.6);
}

body.light-mode #playerName:focus {
    border-color: #d9a860;
    box-shadow:
        0 0 10px rgba(217, 168, 96, 0.8),
        inset 0 0 4px rgba(255, 255, 255, 0.7);
}

body.light-mode #playerPlate {
    color: #4a2d15;
    text-shadow:
        0 0 3px rgba(255, 255, 255, 0.8),
        0 0 6px rgba(184, 134, 70, 0.3);
}

/* Remove text shadows in light mode for scenario text */
body.light-mode .scene-card {
  color: #0f336b;   /* dark navy for readability */
  text-shadow: none;
}
body.light-mode .scene-card * {
  text-shadow: none !important;
}

/* =====================
   LIGHT THEME (END)
   ===================== */
   
.fade-out {
    opacity: 0;
    transition: opacity 0.4s ease;
}

.fade-in {
    opacity: 1;
    transition: opacity 0.4s ease;
}

.scene-card.special-scenario {
    border: 3px solid #28a745; /* bright green */
    box-shadow: 0 0 12px rgba(40, 167, 69, 0.8);
}

#miniEventOverlay {
  opacity: 0;
  pointer-events: none;            /* ðŸ‘ˆ no clicks when hidden */
  transition: opacity 0.4s ease;   /* ðŸ‘ˆ smooth fade */
  display: none;                   /* ðŸ‘ˆ start fully hidden */
}

#miniEventOverlay.visible {
  display: flex;                   /* ðŸ‘ˆ layout when shown */
  opacity: 1;
  pointer-events: auto;            /* ðŸ‘ˆ clickable when visible */
}

#queenChoicesBox .choice {
    font-size: 15px;    /* smaller text */
    font-weight: 800;   /* lighter weight */
    padding: auto;  /* optional: make buttons smaller */
}

/* Align Logs and Achievements at the same top baseline */
#logCard, #achCard {
  margin-top: 0 !important;
  align-self: start;
}

/* Landscape: move Start button to the right */
@media (max-height: 600px) {
  #startBtn {
    margin-left: auto; /* pushes it right in its flex row */
    display: block;
  }
}

/* Scenario text size */
#sceneCard {
  font-size: 13px; /* default mobile size */
  line-height: 1.2em;
}

@media (max-height: 600px) {
  #sceneCard {
    line-height: 1.2em !important
  }
}

@media (min-width: 1024px) {
  #sceneCard {
    font-size: 20px;
  }
}

@keyframes redBorderPulse {
  0% {
    border-color: rgba(255, 0, 0, 0.7);
    outline: 0px solid rgba(255, 0, 0, 0);
    box-shadow: 0 0 12px rgba(255, 0, 0, 0.7);
  }
  50% {
    border-color: rgba(255, 0, 0, 1);
    outline: 3px solid rgba(255, 0, 0, 0.5); /* Fake border growth */
    box-shadow: 0 0 22px rgba(255, 0, 0, 1);
  }
  100% {
    border-color: rgba(255, 0, 0, 0.7);
    outline: 0px solid rgba(255, 0, 0, 0);
    box-shadow: 0 0 12px rgba(255, 0, 0, 0.7);
  }
}

.bizarre-scenario {
  border: 0px solid red;
  animation: redBorderPulse 1.2s ease-in-out infinite;
}

body.light-mode .bizarre-scenario {
  border: 0px solid red !important;
  animation: redBorderPulse 1.2s ease-in-out infinite;
} 

/* Themed name input bar */
#playerName {
    background: linear-gradient(145deg, #2e1b12, #4a3026);
    border: 2px solid #caa472;
    color: #fce8d5;
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow:
        0 0 8px rgba(202, 164, 114, 0.6),
        inset 0 0 4px rgba(0,0,0,0.4);
    transition: all 0.25s ease-in-out;
}

#playerName::placeholder {
    color: rgba(252, 232, 213, 0.7);
    font-style: italic;
}

#playerName:focus {
    outline: none;
    border-color: #ffd7a0;
    box-shadow:
        0 0 12px rgba(255, 215, 160, 0.9),
        inset 0 0 6px rgba(0,0,0,0.5);
}

/* Make the name input fill the full row like the persona dropdown */
#playerName {
  width: 100% !important;
  display: block;
  box-sizing: border-box; /* includes padding/border in the 100% width */
  margin: 8px 0 12px;     /* some breathing room above/below */
  text-align: left;       /* keep typing natural; "justify" isn't useful in single-line inputs */
}

/* Light mode keeps the same full-width behavior automatically */
body.light-mode #playerName {
  width: 100% !important;
  display: block;
  box-sizing: border-box;
}

#playerPlate {
    font-family: 'Cinzel', serif;
    font-size: 1.3rem;
    color: #fce8d5;
    text-shadow:
        0 0 4px rgba(0, 0, 0, 0.6),
        0 0 8px rgba(202, 164, 114, 0.4);
    letter-spacing: 0.5px;
}

.scene-card {
  display: flex;
  flex-direction: column;
  justify-content: center; /* default: center */
  align-items: center;
  text-align: center;
  height: 100%;
  overflow: hidden;
  position: relative;
  padding: 1rem;
}

.scene-card-content {
  max-height: 100%;
  overflow-y: auto;
  width: 100%;
}

.scene-card.topAligned {
  justify-content: flex-start; /* push to top if overflow */
}

.choice.fullwidth {
  flex: 0 0 auto;     /* donâ€™t force it to fill 100% */
  width: 97%;         /* or whatever you want */
  margin: 0 auto;     /* center horizontally */
  text-align: center; /* keep text centered */
}

/* Floating +10 years effect */
.year-float {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;            /* 1-liner small text */
  font-weight: 700;
  white-space: nowrap;        /* ðŸ‘ˆ force 1-line */
  color: #ffd700;             /* bright gold for dark mode */
  opacity: 0;
  z-index: 9999;
  pointer-events: none;
  animation: floatUp 1s ease forwards;
}

/* Light mode override */
body.light-mode .year-float {
  color: #1b1b1b;             /* dark text for visibility */
}

@keyframes floatUp {
  0%   { transform: translate(-50%, 0);   opacity: 1; }
  60%  { transform: translate(-50%, -20px); opacity: 1; }
  100% { transform: translate(-50%, -40px); opacity: 0; }
}

/* ============================
   ONEUP Card Styling
   ============================ */

/* ONEUP badge (top-left corner) */
.oneup-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  font-size: 14px;
  font-weight: 700;
  padding: 4px 8px;
  border-radius: 6px;
  opacity: 0.9;
  z-index: 5; /* stays above sparkles and background */
  
  /* Dark mode default */
  color: #000;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Light mode badge override */
body.light-mode .oneup-badge {
  color: #fff;
  background: #000;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
}

/* ONEUP card: border + glowing effect */
.scene-card.oneup {
  position: relative;
  border: 3px solid #fff;     /* white in dark mode */
  background: transparent;
  box-shadow:
    0 0 12px rgba(255, 255, 255, 0.6),
    0 0 24px rgba(255, 255, 255, 0.4);
  animation: oneup-borderGlow 1.8s infinite ease-in-out;

  overflow: hidden;           /* contain sparkles */
  overscroll-behavior: contain;
  touch-action: none;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Light mode card override: black border + black glow */
body.light-mode .scene-card.oneup {
  border: 3px solid #000;   /* solid black border */
  box-shadow:
    0 0 12px rgba(0, 0, 0, 0.6),
    0 0 24px rgba(0, 0, 0, 0.4);
  animation: oneup-borderGlowLight 1.8s infinite ease-in-out;
}

/* pulsing border glow (dark mode: white) */
@keyframes oneup-borderGlow {
  0%, 100% {
    box-shadow:
      0 0 8px rgba(255, 255, 255, 0.5),
      0 0 16px rgba(255, 255, 255, 0.3);
  }
  50% {
    box-shadow:
      0 0 20px rgba(255, 255, 255, 0.9),
      0 0 40px rgba(255, 255, 255, 0.6);
  }
}

/* pulsing border glow (light mode: black) */
@keyframes oneup-borderGlowLight {
  0%, 100% {
    box-shadow:
      0 0 8px rgba(0, 0, 0, 0.5),
      0 0 16px rgba(0, 0, 0, 0.3);
  }
  50% {
    box-shadow:
      0 0 20px rgba(0, 0, 0, 0.9),
      0 0 40px rgba(0, 0, 0, 0.6);
  }
}

/* Force content centered */
.scene-card.oneup .scene-card-content {
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  overflow: hidden; /* stop scroll */
}

/* sparkles (default: gold in dark mode) */
.scene-card.oneup .sparkle {
  position: absolute;
  width: 3px;
  height: 3px;
  background: #ffd700;        /* gold sparkles */
  transform: rotate(45deg) scale(0.2);
  opacity: 0;
  animation: sparkleBlink 1.6s infinite ease-in-out;
  pointer-events: none;
  z-index: 2;
}

/* Light mode sparkles override: dark silver */
body.light-mode .scene-card.oneup .sparkle {
  background: #555;           /* dark silver */
}

/* sparkle animation */
@keyframes sparkleBlink {
  0%, 100% {
    opacity: 0;
    transform: rotate(45deg) scale(0.2);
  }
  50% {
    opacity: 1;
    transform: rotate(45deg) scale(1);
  }
}

.theme-wrapper {
  display: inline-flex;
  align-items: center;
  position: relative;
}

#customBgPicker {
  width: 100%;
  height: 32px; /* match dropdown height */
  border: none;
  border-radius: 6px;
  cursor: pointer;
  padding: 0;
}

/* Default card background */
.card, .scene-card {
  background: var(--card-bg, var(--glass));
  color: var(--fg);
  border-radius: var(--ui-radius);
  border: 1px solid rgba(0,0,0,0.1);
}

/* Dark mode cards */
body.dark-mode {
  --card-bg: rgba(255,255,255,0.05); /* subtle glass look */
}

/* Light mode cards */
body.light-mode {
  --card-bg: #ffffff; /* solid white cards */
}

/* Custom white background */
body.custom-light-mode {
  --card-bg: #ffffff; /* keep them same as UI (clean white) */
}

/* Dark mode */
.scene-card.queen-scenario {
  border: 3px solid gold;
  box-shadow: 0 0 18px rgba(255, 215, 0, 0.8);
}

/* Light mode */
body.light-mode .scene-card.queen-scenario {
  border: 3px solid goldenrod !important;
  box-shadow: 0 0 18px rgba(218, 165, 32, 0.7) !important;
}

#hideEffectsBtn.oneup-active {
  /* inherit base dimensions */
  font-size: 12px;
  padding: 4px 8px;
  min-width: unset; /* allows it to follow the same width as original */
  border-radius: 8px;
  border: 1px solid #999;

  /* 1UP look */
  background: linear-gradient(135deg, #c0c0c0 0%, #e6e6e6 50%, #b0b0b0 100%);
  color: #000;
  font-weight: 600;

  /* layout stability */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 10px rgba(192, 192, 192, 0.6);
  cursor: default;
}

/* Base toggle button (Effects) */
.toggle-btn {
  display: block; /* ensures full width */
  width: 100%;    /* stretch across container */
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.08);
  color: var(--muted);
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.toggle-btn:hover {
  background: rgba(255,255,255,0.15);
  color: var(--fg);
}

/* Active state: 1UP Indicator */
#hideEffectsBtn.oneup-active {
  display: block; /* same as base */
  width: 100%;    /* same as base */
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid #999;
  background: linear-gradient(135deg, #c0c0c0 0%, #e6e6e6 50%, #b0b0b0 100%);
  color: #000;
  font-weight: 600; /* bold when active */
  text-align: center;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 10px rgba(192, 192, 192, 0.6);
  cursor: default;
}

/* Shine effect */
#hideEffectsBtn.oneup-active::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    120deg,
    rgba(255, 255, 255, 0) 30%,
    rgba(255, 255, 255, 0.6) 50%,
    rgba(255, 255, 255, 0) 70%
  );
  transform: rotate(25deg) translateX(-100%);
  animation: shine-slide 2.5s infinite linear;
  pointer-events: none;
}

@keyframes shine-slide {
  0% { transform: rotate(25deg) translateX(-100%); }
  100% { transform: rotate(25deg) translateX(100%); }
}

.choice {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    width: 120px;
    height: 48px;
    white-space: normal;
    word-break: break-word;
    font-size: clamp(15px, 2.5vw, 14px); /* shrinks text if needed */
}

.choice,
.toggle-btn,
button {
    user-select: none;
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none;     /* IE 10+ */
}

/* Remove blue focus outline */
button:focus {
  outline: none !important;
}

/* Remove tap highlight on mobile */
button {
  -webkit-tap-highlight-color: transparent;
}

/* Optional: prevent text selection while pressing */
button, button * {
  user-select: none;
}
  </style>
</head>
<body>
<!-- === Splash + Loading + Title Screens === -->
<div id="splash-overlay">
  <!-- (1) Developer Logo -->
  <div class="splash-screen fade" id="dev-screen">
    <div class="dev-container">
      <!-- White Fish Logo (SVG, open tails) -->
      <svg class="dev-logo" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Left loop -->
        <path d="M10 50 Q60 10, 120 50 Q60 90, 10 50" 
              fill="none" stroke="white" stroke-width="6" 
              stroke-linecap="round" stroke-linejoin="round"/>
        <!-- Right open tail -->
        <path d="M120 50 Q155 25, 160 20" 
              fill="none" stroke="white" stroke-width="6" 
              stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M120 50 Q155 75, 160 80" 
              fill="none" stroke="white" stroke-width="6" 
              stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <!-- (2) Loading Screen -->
  <div class="splash-screen fade hidden" id="loading-screen">
    <div class="loading-text">Loading...</div>
    <div class="loading-bar"><div class="loading-fill"></div></div>
  </div>

  <!-- (3) Title Screen -->
<div class="splash-screen fade hidden" id="title-screen">
  <!-- Crown + Shield Logo (improved) -->
  <svg class="title-logo" xmlns="http://www.w3.org/2000/svg" 
     viewBox="0 0 120 150" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
  <defs>
    <linearGradient id="gold" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#e6c76f"/>
      <stop offset="100%" stop-color="#d4af37"/>
    </linearGradient>
  </defs>

  <!-- Crown peaks (3 triangles, middle taller) -->
  <polygon points="20,40 35,15 50,40" fill="url(#gold)"/>
  <polygon points="45,40 60,15 75,40" fill="url(#gold)"/>
  <polygon points="70,40 85,15 100,40" fill="url(#gold)"/>

  <!-- Diamonds aligned exactly on tips -->
  <rect x="31" y="7"  width="8" height="8" transform="rotate(45 35 11)"  fill="url(#gold)"/>
  <rect x="56" y="7" width="10" height="10" transform="rotate(45 65 9)" fill="url(#gold)"/>
  <rect x="81" y="7"  width="8" height="8" transform="rotate(45 85 11)"  fill="url(#gold)"/>
  
  <!-- Gap between crown and shield -->
  <rect x="20" y="46" width="80" height="8" fill="transparent"/>

  <!-- Shield outline (shorter height) -->
  <path d="M20 54 V100 Q20 130 60 140 Q100 130 100 100 V54 Z"
        fill="none" stroke="url(#gold)" stroke-width="3" stroke-linejoin="round"/>

  <!-- Left filled half of shield -->
  <path d="M20 54 V100 Q20 130 60 140 V54 Z" fill="url(#gold)"/>
</svg>

  <h1 class="game-title">Yes, Sire.</h1>
  <p class="subtitle"><i>ps. this is an ongoing project and you might encounter bugs along the way.</i></p>
  <p class="tap-to-start">Tap anywhere to begin</p>
</div>
</div>
</div>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&display=swap');

  /* Overlay container */
  #splash-overlay {
    position: fixed;
    inset: 0;
    background: #0a0a15;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    flex-direction: column;
    --tap-x: 50%;
    --tap-y: 50%;
  }

  .splash-screen { 
    text-align: center; 
    opacity: 0; 
    transition: opacity 1s ease; 
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .splash-screen.show { opacity: 1; }
  .splash-screen.hidden { display: none; }

  /* Dev screen */
  .dev-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .dev-logo {
    width: 80px; 
    height: auto;
    display: block;
  }

  /* Loading */
  /* Loading */
.loading-text { 
  font-size: 1.3em; 
  margin-bottom: 1em; 
  color: #d4af37; /* gold text */
}

.loading-bar { 
  width: 220px; 
  height: 14px; 
  border: 2px solid #d4af37; /* gold border */
  border-radius: 8px; 
  overflow: hidden; 
}

.loading-fill { 
  height: 100%; 
  width: 0; 
  background: linear-gradient(90deg, #e6c76f, #d4af37); /* gold gradient */
  transition: width 0.3s; 
}

  /* Title screen styling */
#title-screen {
  background: radial-gradient(circle at center, #3b1e00 0%, #0d0b0b 100%);
  color: #d4af37;
  font-family: serif;
  text-align: center;
  padding: 2vh 2vw; /* prevents touching edges */
  box-sizing: border-box;
}

.title-logo {
  width: 90px;
  height: auto;
  margin-bottom: 0.2em;
}

.game-title {
  font-size: 2.5em;
  font-weight: 600;
  margin: 0.01em 0;
  margin-bottom: 0.1em
}

.subtitle {
  font-size: 1em;
  margin-bottom: 5em;
  opacity: 0.9;
}

.tap-to-start {
  font-size: 1em;
  opacity: 0.7;
  animation: pulse 1.8s infinite;
}

/* === Landscape Fix === */
@media (orientation: landscape) {
  .title-logo {
    width: 18vh;   /* scale crown+shield by screen height */
    margin-bottom: 1vh;
  }
  .game-title {
    font-size: 9vh;  /* scale title by height */
  }
  .subtitle {
    font-size: 7vh;
    margin-bottom: 5vh;
  }
  .tap-to-start {
    font-size: 5vh;
  }
} 

  @keyframes pulse {
    0%,100% { opacity: 0.1; }
    50% { opacity: 1; }
  }  

  /* Animate custom CSS variable */
  @property --r {
    syntax: '<length>';
    inherits: false;
    initial-value: 0px;
  }

  /* --- Circular reveal-out --- */
  #splash-overlay.reveal-out {
    --r: 0px;
    -webkit-mask: radial-gradient(circle var(--r) at var(--tap-x) var(--tap-y),
                                  transparent 99%, black 100%);
            mask: radial-gradient(circle var(--r) at var(--tap-x) var(--tap-y),
                                  transparent 99%, black 100%);
    animation: r-expand 100000ms cubic-bezier(0.2, 0.8, 0.4, 1) forwards;
  }
  @keyframes r-expand { to { --r: 10000vmax; } }
</style>

<script>
(function () {
  const devScreen     = document.getElementById('dev-screen');
  const loadingScreen = document.getElementById('loading-screen');
  const titleScreen   = document.getElementById('title-screen');
  const overlay       = document.getElementById('splash-overlay');
  const fill          = loadingScreen.querySelector('.loading-fill');

  // Fade util
  function fadeTo(next, prev, delay = 0, onShown) {
    setTimeout(() => {
      if (prev) prev.classList.remove('show');
      setTimeout(() => {
        if (prev) prev.classList.add('hidden');
        next.classList.remove('hidden');
        requestAnimationFrame(() => {
          next.classList.add('show');
          if (onShown) setTimeout(onShown, 500); // wait until fade-in is complete
        });
      }, 1000);
    }, delay);
  }

  // Step 1: Dev logo
  devScreen.classList.remove('hidden');
  requestAnimationFrame(() => devScreen.classList.add('show'));
  fadeTo(loadingScreen, devScreen, 2000, startLoadingBar);

  // Step 2: Fake loading bar (3 intervals: 0 â†’ 89 â†’ 100)
  function startLoadingBar() {
    fill.style.width = "0%"; // start at 0%
    let step = 0;
    const intervals = [89, 100];
    const interval = setInterval(() => {
      fill.style.width = intervals[step] + "%";
      step++;
      if (step >= intervals.length) {
        clearInterval(interval);
        fadeTo(titleScreen, loadingScreen, 600);
      }
    }, 800); // each step ~0.8s
  }

  // Step 3: Tap to start with circular reveal
  let started = false;
  overlay.addEventListener('pointerdown', (e) => {
    if (started) return;
    if (!titleScreen || titleScreen.classList.contains('hidden')) return;
    started = true;

    const rect = overlay.getBoundingClientRect();
    const x = (e.clientX ?? (e.touches && e.touches[0]?.clientX) ?? rect.width / 2) - rect.left;
    const y = (e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? rect.height / 2) - rect.top;

    overlay.style.setProperty('--tap-x', `${x}px`);
    overlay.style.setProperty('--tap-y', `${y}px`);

    overlay.classList.add('reveal-out');

    // Small delay before main UI is clickable
    setTimeout(() => {
      overlay.style.pointerEvents = "none";
    }, 350);

    // Remove after animation finishes
    setTimeout(() => overlay.remove(), 1200);
  }, { passive: true });
})();
</script>
 
<div class="app" id="appRoot">
<div class="container" id="mainContainer">
<div class="card">
<div class="header">
<div style="font-weight:800;font-size:20px;">Yes, Sire. (beta)</div>
<div style="text-align:right"><small id="yearDisplay">1512</small><div id="playerPlate" style="font-weight:700">The King</div></div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:6px;flex-wrap:nowrap;">
<!-- LEFT COLUMN -->
<div style="display:flex;flex-direction:column;gap:6px;flex:0 0 auto;">
<!-- Difficulty row -->
<select class="input" id="difficulty">
<option value="easy">Easy</option>
<option value="medium">Medium</option>
<option value="hard">Hard</option>
</select>
<!-- Theme + Color Picker row -->
<div style="display:flex;gap:6px;align-items:center;">
<select class="input" id="theme" style="flex:1;">
<option value="dark">Original Gold</option>
<option value="light">Frosted Light</option>
<option value="custom">Custom</option>
</select>
<input id="customBgPicker" style="display:none;width:42px;height:42px;border:none;border-radius:8px;cursor:pointer;" type="color" value="#071029"/>
</div>
</div>
<!-- MIDDLE COLUMN -->
<button class="choice" id="startBtn" style="flex:0 0 auto;">Start</button>
<!-- RIGHT COLUMN -->
<div style="display:flex;flex-direction:column;gap:4px;align-items:flex-start;flex:0 0 auto;">
<input id="hidePreview" style="display:none" type="checkbox">
<input id="hideConsequences" style="display:none" type="checkbox"/>
<button class="toggle-btn" id="hidePreviewBtn">Previews</button>
<button class="toggle-btn" id="hideEffectsBtn">Effects</button>
</input></div>
</div>
<div class="scene" id="sceneArea" style="margin-top:12px">
<div class="scene-card" id="sceneCard">Press Start to begin your reign. Your decisions shape centuries.</div>
</div>
<div class="scene-meta" id="sceneMeta" style="display:none;">
<div><small>Decisions this decade: <span id="decCount">0</span>/6</small></div>
<div class="traits" id="traitsList"></div>
</div>
<div class="choices" id="choicesBox" style="display:none">
<button class="choice" id="acceptBtn">Accept</button>
<button class="choice secondary" id="declineBtn">Decline</button>
</div>
<!-- V9.7.5: Custom Queen decision tabs -->
<div class="choices" id="queenChoicesBox" style="display:none">
<button class="choice" id="queenAgreeBtn">Support Her Plan</button>
<button class="choice secondary" id="queenRefuseBtn">Politely Decline</button>
</div>
<div class="footer-small">Tip: Hold choices buttons to preview which essences will be affected (if previews enabled).</div>
</div>
<!-- Card 1: Essences & Status -->
<div class="card" id="sideCard">
<div style="display:flex;justify-content:space-between;align-items:center">
<div style="font-weight:700">Essences &amp; Status</div>
</div>
<div class="essences" id="essencesList"></div>
</div>
<!-- Card 2: Logs -->
<div class="card" id="logCard">
<div style="font-weight:700">Log</div>
<div class="log" id="log"></div>
</div>
<!-- Card 3: Achievements -->
<div class="card" id="achCard">
<div style="font-weight:700">Achievements</div>
<div id="achList"></div>
</div>
</div>
</div>
<div class="overlay" id="nameOverlay" style="display:none">
<div class="card" style="max-width:520px;width:92%">
<div style="font-weight:700;margin-bottom:8px">Enter your name and pick a persona</div>
<input class="input" id="playerName" maxlength="15" placeholder="The Monarch's name"/>
<div style="display:flex;gap:8px;margin-top:10px">
<button class="choice" id="acceptName" style="flex:1">Start Reign</button>
<button class="choice secondary" id="randomize" style="flex:1">Random Persona</button>
</div>
<div class="overlay" id="effectsOverlay" style="display:none;">
<div class="card" style="max-width:420px;width:92%;text-align:center;">
<div style="font-size:18px;font-weight:700;margin-bottom:10px;">Background Settings</div>
<div style="margin-bottom:12px;">
<label for="bgColorPicker">Choose background color:</label>
<input id="bgColorPicker" style="margin-left:8px;" type="color" value="#071029"/>
</div>
<button class="choice" id="applyBgColor" style="margin-top:8px;">Apply</button>
<button class="choice secondary" id="closeEffects" style="margin-top:8px;">Close</button>
</div>
</div>
<div class="hint" style="margin-top:8px">Pick a persona to get a starting trait.</div>
<div style="display:flex;gap:8px;margin-top:8px">
<select class="input" id="persona" style="width:100%">
<option value="none">-- Choose a persona --</option>
<option value="beloved">Beloved Ruler (Population+)</option>
<option value="iron">Iron Fist (Strength+)</option>
<option value="shrewd">Shrewd Economist (Money+)</option>
<option value="patron">Patron of Arts (Culture+)</option>
</select>
</div>
</div>
</div>


<!-- V9.8: Mini Event Popup -->
<div class="overlay" id="miniEventOverlay" style="display:none;">
<div class="card" style="max-width:520px;width:92%;text-align:center;">
<div style="font-size:22px;font-weight:800;color:var(--accent-a);margin-bottom:12px;">
      ðŸ“¢ MINI EVENT ðŸ“¢
    </div>
<div id="miniEventText" style="margin-bottom:12px;font-size:16px;"></div>
<div id="miniEventEffects" style="margin-bottom:16px;"></div>
<button class="choice" id="dismissMiniEvent">OK</button>
</div>
</div>
<script>

// DOM
const yearEl = document.getElementById('yearDisplay');
const startBtn = document.getElementById('startBtn');
const difficultyEl = document.getElementById('difficulty');
const sceneCard = document.getElementById('sceneCard');
const choicesBox = document.getElementById('choicesBox');
const queenChoicesBox = document.getElementById('queenChoicesBox');

const essList = document.getElementById('essencesList');
const decCountEl = document.getElementById('decCount');
const logEl = document.getElementById('log');
const hideConsEl = document.getElementById('hideConsequences');
const hidePrevEl = document.getElementById('hidePreview');
const nameOverlay = document.getElementById('nameOverlay');
const acceptName = document.getElementById('acceptName');
const randomize = document.getElementById('randomize');
const playerNameInput = document.getElementById('playerName');
const personaEl = document.getElementById('persona');
const traitsList = document.getElementById('traitsList');
const achList = document.getElementById('achList');
const playerPlate = document.getElementById('playerPlate');

// Utility: force dark colors
function ensureDarkColor(hex) {
    if (!hex || !/^#([0-9A-F]{6})$/i.test(hex)) return "#222222"; // fallback dark

    // Convert hex â†’ RGB
    const r = parseInt(hex.substr(1, 2), 16);
    const g = parseInt(hex.substr(3, 2), 16);
    const b = parseInt(hex.substr(5, 2), 16);

    // Calculate brightness (perceived luminance)
    const brightness = (0.299 * r + 0.587 * g + 0.114 * b);

    // If it's too bright, darken it
    if (brightness > 120) { // tweak threshold if needed
        const factor = 0.5; // darken by 50%
        return `rgb(${Math.floor(r * factor)}, ${Math.floor(g * factor)}, ${Math.floor(b * factor)})`;
    }

    return hex;
}

// Example hook on color input
const bgPicker = document.getElementById("background-picker");
if (bgPicker) {
    bgPicker.addEventListener("input", (e) => {
        const chosen = e.target.value;
        const darkColor = ensureDarkColor(chosen);

        document.body.style.backgroundColor = darkColor;
    });
}

function renderChoices(scene) {
    choicesBox.style.display = 'flex';
    choicesBox.innerHTML = '';

    if (!scene.choices || !scene.choices.length) return;

    scene.choices.forEach((choice, idx) => {
        const btn = document.createElement('button');
        btn.className = 'choice' + (choice.secondary ? ' secondary' : '');
        btn.textContent = choice.label || `Choice ${idx + 1}`;

        btn.addEventListener('click', () => {
            makeDecision(choice, idx);
        });

        choicesBox.appendChild(btn);
    });

    // === If only 1 choice, make it full width ===
    const buttons = choicesBox.querySelectorAll('.choice');
    if (buttons.length === 1) {
        buttons[0].classList.add('fullwidth');
    }

    // After creating, wire previews
    renderChoicePreview(scene);
}

function adjustLayoutForLandscape() {
  if (window.innerWidth > window.innerHeight) {
    document.body.classList.add('landscape-mode');
  } else {
    document.body.classList.remove('landscape-mode');
  }
}
window.addEventListener('resize', adjustLayoutForLandscape);
window.addEventListener('orientationchange', adjustLayoutForLandscape);
document.addEventListener('DOMContentLoaded', adjustLayoutForLandscape);

window.__TRACE = (...args) => console.log('[REIGN]', ...args);

// ensure a single global suppression flag that every module uses
window.suppressQueen = window.suppressQueen || false;

  // DOM
document.addEventListener('DOMContentLoaded', function(){
 
// Wire up the ellipses button
const ellipsesBtn = document.querySelector('.ellipses-btn');
if (ellipsesBtn) {
  ellipsesBtn.addEventListener('click', () => {
    // Kill the Queen arc permanently
    state.queenArcActive = false;
    window.suppressQueen = true;  // in case other checks still use this

    // Immediately strip queen scenarios from the pool
    state.scenePool = state.scenePool.filter(s =>
      !(s && typeof s.id === 'string' && s.id.startsWith('q'))
    );

    // Log and move forward
    console.log("Ellipses button pressed â€” Queen arc suppressed permanently.");
    makeDecision(false); // act like a decline, moves to next scene
  });
}

window.__TRACE = (...args) => console.log('[REIGN]', ...args);

// ensure a single global suppression flag that every module uses
window.suppressQueen = window.suppressQueen || false;

// Keep this â€” but no duplicate DOM references
document.addEventListener('DOMContentLoaded', function(){
  // Wire up the ellipses button
  const ellipsesBtn = document.querySelector('.ellipses-btn');
  if (ellipsesBtn) {
    ellipsesBtn.addEventListener('click', () => {
      state.queenArcActive = false;
      window.suppressQueen = true;

      // Strip queen scenarios
      state.scenePool = state.scenePool.filter(s =>
        !(s && typeof s.id === 'string' && s.id.startsWith('q'))
      );

    // Log and move forward
    console.log("Ellipses button pressed â€” Queen arc suppressed permanently.");
      makeDecision(false);
  });
}
});

  function resizeApp() {
  const baseWidth = 698;
  const baseHeight = 944;

  // Independent manual multipliers
  const manualWidthMultiplier = 0.8;   // narrower than default
  const manualHeightMultiplier = 1.1;  // taller than default
  
  const scaleX = (window.innerWidth / baseWidth) * manualWidthMultiplier;
  const scaleY = (window.innerHeight / baseHeight) * manualHeightMultiplier;

  document.documentElement.style.setProperty('--scale-x', scaleX);
  document.documentElement.style.setProperty('--scale-y', scaleY);
}

const hidePreviewBtn = document.getElementById('hidePreviewBtn');
const hidePreviewCheckbox = document.getElementById('hidePreview');
const hideEffectsBtn = document.getElementById('hideEffectsBtn');
hideEffectsBtn.textContent = '+1UP';
hideEffectsBtn.disabled = true; // not clickable
// === Previews toggle ===
hidePreviewCheckbox.checked = false;
hidePreviewBtn.classList.add('on');

hidePreviewBtn.addEventListener('click', () => {
  hidePreviewCheckbox.checked = !hidePreviewCheckbox.checked;
  hidePreviewBtn.classList.toggle('on', !hidePreviewCheckbox.checked);
});

// === Theme selection (dark, light, custom background) ===
const themeSelect = document.getElementById('theme');

// === Background setter ===
function setBackgroundColor(color) {
  document.documentElement.style.backgroundColor = color;
  document.body.style.backgroundColor = color;
}

/* ---------- DARK-ONLY HELPERS ---------- */

// WCAG relative luminance
function relLum(r, g, b) {
  const toLin = v => {
    v /= 255;
    return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
  };
  const R = toLin(r), G = toLin(g), B = toLin(b);
  return 0.2126 * R + 0.7152 * G + 0.0722 * B;
}
function hexToRgb(hex) {
  const m = /^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(hex);
  if (!m) return { r: 7, g: 16, b: 41 };
  return { r: parseInt(m[1], 16), g: parseInt(m[2], 16), b: parseInt(m[3], 16) };
}
function rgbToHex(r, g, b) {
  const h = v => v.toString(16).padStart(2, '0');
  return `#${h(r)}${h(g)}${h(b)}`;
}
// Ensure background is dark enough for white text (â‰¥ 4.5:1)
function ensureDarkReadable(hex, minContrast = 4.5) {
  const WHITE_L = 1.0;
  let { r, g, b } = hexToRgb(hex);
  let L = relLum(r, g, b);
  // contrast(white, bg) = (1.05) / (L + 0.05)
  const targetMaxL = (1.05 / minContrast) - 0.05; // ~0.183 for 4.5:1
  if (L <= targetMaxL) return `#${hex.replace('#', '')}`.toUpperCase();

  // Darken iteratively until contrast passes
  for (let i = 0; i < 12 && L > targetMaxL; i++) {
    r = Math.max(0, Math.floor(r * 0.88));
    g = Math.max(0, Math.floor(g * 0.88));
    b = Math.max(0, Math.floor(b * 0.88));
    L = relLum(r, g, b);
  }
  return rgbToHex(r, g, b).toUpperCase();
}

/* ---------- HIDDEN COLOR INPUT + DARK SWATCHES ---------- */

const hiddenColorPicker = document.createElement('input');
hiddenColorPicker.type = 'color';
hiddenColorPicker.value = '#071029'; // default
hiddenColorPicker.style.display = 'none';

// Provide ONLY dark suggestions to the native dialog
const darkList = document.createElement('datalist');
darkList.id = 'darkcolors';
[
  '#0D1164','#640D5F','#EA2264','#F78D60','#4B352A',
  '#1C352D','#FEFBC7','#F7F7F7','#3338A0','#FBF9D1',
  '#E6CFA9','#9A3F3F','#9B3922','#481E14','#0C0C0C'
].forEach(c => {
  const o = document.createElement('option');
  o.value = c;
  darkList.appendChild(o);
});
hiddenColorPicker.setAttribute('list', 'darkcolors');

document.body.appendChild(hiddenColorPicker);
document.body.appendChild(darkList);

/* ---------- APPLY THEME ---------- */

function applyTheme(value, fromRestore = false) {
  document.documentElement.classList.remove('light-mode');
  document.body.classList.remove('light-mode');

  if (value === 'light') {
    // (Keep if you still expose Light. Remove this block to disable Light entirely.)
    setBackgroundColor('#f0f0f0');
    return;
  }

  if (value === 'dark') {
    setBackgroundColor('#071029');
    return;
  }

  if (value === 'custom') {
    if (fromRestore) {
      const safe = ensureDarkReadable(hiddenColorPicker.value);
      hiddenColorPicker.value = safe;
      setBackgroundColor(safe);
    } else {
      // Open the picker; apply happens via input/change handlers
      hiddenColorPicker.click();
    }
  }
}

/* ---------- ENFORCE DARK ON PICK ---------- */

// Live while dragging the picker
hiddenColorPicker.addEventListener('input', () => {
  if (themeSelect.value !== 'custom') return;
  const safe = ensureDarkReadable(hiddenColorPicker.value);
  hiddenColorPicker.value = safe;        // clamp the value shown by the picker
  setBackgroundColor(safe);              // apply
});

// Final value when the dialog closes (some browsers only fire this)
hiddenColorPicker.addEventListener('change', () => {
  if (themeSelect.value !== 'custom') return;
  const safe = ensureDarkReadable(hiddenColorPicker.value);
  hiddenColorPicker.value = safe;
  setBackgroundColor(safe);
});

// --- Apply theme handler ---
function applyTheme(value, fromRestore = false) {
  document.documentElement.classList.remove('light-mode');
  document.body.classList.remove('light-mode');

  let bgColor = "";

  if (value === 'light') {
    document.documentElement.classList.add('light-mode');
    document.body.classList.add('light-mode');
    bgColor = "#f0f0f0";
  } else if (value === 'dark') {
    bgColor = "#071029";
  } else if (value === 'custom') {
    // If restoring, just apply current picker value
    if (fromRestore) {
      bgColor = hiddenColorPicker.value;
    } else {
      // Open picker on user action
      hiddenColorPicker.click();
      bgColor = hiddenColorPicker.value;
    }
  }
  
  setBackgroundColor(bgColor);
}

// Handle user picking a custom color
hiddenColorPicker.addEventListener('input', () => {
  if (themeSelect.value === 'custom') {
    const color = hiddenColorPicker.value;
    setBackgroundColor(color);
  }
});

// --- Listen for theme changes ---
themeSelect.addEventListener('change', () => {
  const value = themeSelect.value;
  applyTheme(value, false); // direct user action
});

// --- Apply on first load (default theme without persistence) ---
applyTheme(themeSelect.value, true);

// === Essence bar highlight ===
function highlightEssenceChange(key, change) {
  const barEl = document.querySelector(`.essence-bar[data-essence="${key}"]`);
  if (!barEl) return;

  barEl.classList.remove('gain', 'loss', 'fadeout');
  void barEl.offsetWidth; // reflow

  barEl.classList.add(change > 0 ? 'gain' : 'loss');

  const SHOW_MS = 450;
  const FADE_MS = 800;
  setTimeout(() => {
    barEl.classList.add('fadeout');
    setTimeout(() => {
      barEl.classList.remove('gain', 'loss', 'fadeout');
    }, FADE_MS);
  }, SHOW_MS);
}

function setOneUpIndicator(active) {
    const btn = document.getElementById('hideEffectsBtn');
    if (!btn) return;

    if (active) {
        btn.classList.remove('toggle-btn'); // Remove normal button style
        btn.classList.add('oneup-active');  // Add special metallic style
        btn.textContent = '+1UP!';
    } else {
        btn.classList.remove('oneup-active');
        btn.classList.add('toggle-btn'); // Restore original
        btn.textContent = '+1UP'; // Original label
    }
}

(function(){
  // === Data pools (deduplicated + expanded) ===
    const REPEATING = [
  {id:'r01', type:'aid', text:'A fever spreads among Pinebarrowâ€™s fishermen. Shall we send royal healers and supplies?', 
 choices:[
   {id:'r01_yes', label:'Send healers and herbs', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r01_no', label:'Leave them be', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r02', type:'security', text:'Bandits rob merchants along Trundle Pass. Do you dispatch troops to secure the road?', 
 choices:[
   {id:'r02_yes', label:'Send troops', effects:[{k:'Strength',d:2},{k:'Control',d:2},{k:'Money',d:-2}]},
   {id:'r02_no', label:'Do nothing', effects:[{k:'Strength',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r03', type:'culture', text:'Captain Ioan requests funds for a grand artisan festival in Cedarford. Shall we sponsor it?', 
 choices:[
   {id:'r03_yes', label:'Sponsor the festival', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-2}]},
   {id:'r03_no', label:'Refuse funding', effects:[{k:'Culture',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r04', type:'harvest', text:'Heavy rains ruined Willowmereâ€™s granaries. Shall we open royal stores and sell grain cheaply?', 
 choices:[
   {id:'r04_yes', label:'Release grain at low cost', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r04_no', label:'Keep the stores shut', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r05', type:'nobles', text:'Nobles of Mossgate want funds to arm soldiers loyal to the crown. Grant their request?', 
 choices:[
   {id:'r05_yes', label:'Provide gold and arms', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r05_no', label:'Deny their request', effects:[{k:'Control',d:-1},{k:'Strength',d:-1}]}
 ]},

{id:'r06', type:'religion', text:'The abbey of St. Edrin in Tarnmoor is falling into ruin. Shall we fund its repair?', 
 choices:[
   {id:'r06_yes', label:'Restore the abbey', effects:[{k:'Religion',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r06_no', label:'Ignore the abbey', effects:[{k:'Religion',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r07', type:'trade', text:'Evershore merchants request lower harbor fees. Shall we approve?', 
 choices:[
   {id:'r07_yes', label:'Lower the fees', effects:[{k:'Population',d:1},{k:'Money',d:-1},{k:'Control',d:-1}]},
   {id:'r07_no', label:'Keep fees as is', effects:[{k:'Money',d:1},{k:'Culture',d:-1}]}
 ]},

{id:'r08', type:'festival', text:'The guilds in Crowâ€™s Hollow want to host a harvest fair. Shall we support it?', 
 choices:[
   {id:'r08_yes', label:'Fund the fair', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-2}]},
   {id:'r08_no', label:'Deny the request', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r09', type:'education', text:'A traveling scholar offers weaving lessons in Brightford. Shall we support him?', 
 choices:[
   {id:'r09_yes', label:'Fund the program', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r09_no', label:'Refuse support', effects:[{k:'Education',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r10', type:'infrastructure', text:'A lightning strike destroyed Stonefordâ€™s watchtower. Shall we rebuild it?', 
 choices:[
   {id:'r10_yes', label:'Rebuild the tower', effects:[{k:'Control',d:2},{k:'Strength',d:1},{k:'Money',d:-2}]},
   {id:'r10_no', label:'Leave it ruined', effects:[{k:'Strength',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r11', type:'infrastructure', text:'East Arborâ€™s grain shipments stall on damaged roads. Shall we send workers?', 
 choices:[
   {id:'r11_yes', label:'Repair the routes', effects:[{k:'Control',d:2},{k:'Money',d:-2}]},
   {id:'r11_no', label:'Leave roads broken', effects:[{k:'Population',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r12', type:'census', text:'Unrest brews in Blackfen over a disputed census. Shall we send officials to resolve it?', 
 choices:[
   {id:'r12_yes', label:'Send royal officials', effects:[{k:'Control',d:2},{k:'Money',d:-1}]},
   {id:'r12_no', label:'Ignore the dispute', effects:[{k:'Control',d:-2},{k:'Population',d:-1}]}
 ]},

{id:'r13', type:'education', text:'A master glassblower in Mistvale offers to train apprentices. Shall we fund him?', 
 choices:[
   {id:'r13_yes', label:'Support the training', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r13_no', label:'Decline his request', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r14', type:'militia', text:'Marenâ€™s Bay militia complain of broken weapons and late pay. Shall we rearm them?', 
 choices:[
   {id:'r14_yes', label:'Reequip the militia', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r14_no', label:'Refuse to aid them', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r15', type:'diplomacy', text:'High Solway offers peace if we return disputed grazing land. Accept the offer?', 
 choices:[
   {id:'r15_yes', label:'Return the land', effects:[{k:'Population',d:1},{k:'Control',d:1},{k:'Strength',d:-2}]},
   {id:'r15_no', label:'Refuse the deal', effects:[{k:'Strength',d:1},{k:'Population',d:-1}]}
 ]},

{id:'r16', type:'famine', text:'Floods destroyed Vallortâ€™s harvest. Shall we send aid to prevent starvation?', 
 choices:[
   {id:'r16_yes', label:'Send grain', effects:[{k:'Population',d:2},{k:'Money',d:-2}]},
   {id:'r16_no', label:'Withhold aid', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r17', type:'tax', text:'Kingswellâ€™s farmers had a poor season. Shall we grant temporary tax relief?', 
 choices:[
   {id:'r17_yes', label:'Grant relief', effects:[{k:'Population',d:1},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r17_no', label:'Keep taxes unchanged', effects:[{k:'Population',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r18', type:'defense', text:'Scouts report a warband gathering near Lowgate Marshes. Shall we reinforce defenses?', 
 choices:[
   {id:'r18_yes', label:'Strengthen defenses', effects:[{k:'Strength',d:2},{k:'Control',d:2},{k:'Money',d:-2}]},
   {id:'r18_no', label:'Take no action', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r19', type:'art', text:'A mosaic artist from Westwyche offers to decorate Tarnmoor Cathedral. Shall we commission him?', 
 choices:[
   {id:'r19_yes', label:'Commission the art', effects:[{k:'Culture',d:2},{k:'Religion',d:1},{k:'Money',d:-2}]},
   {id:'r19_no', label:'Refuse the offer', effects:[{k:'Culture',d:-1},{k:'Religion',d:-1}]}
 ]},

{id:'r20', type:'education', text:'A traveling herbalist offers to teach rare medicinal skills in Harrowfield. Shall we support her lessons?', 
 choices:[
   {id:'r20_yes', label:'Fund the lessons', effects:[{k:'Education',d:2},{k:'Population',d:1},{k:'Money',d:-2}]},
   {id:'r20_no', label:'Decline the offer', effects:[{k:'Education',d:-1},{k:'Population',d:-1}]}
 ]},
  {id:'r21', type:'religion', text:'Pilgrims traveling through Frostmere beg for a small shrine to be built along the road. Shall we approve?', 
 choices:[
   {id:'r21_yes', label:'Allow the shrine', effects:[{k:'Religion',d:2},{k:'Culture',d:1},{k:'Money',d:-1}]},
   {id:'r21_no', label:'Refuse permission', effects:[{k:'Religion',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r22', type:'military', text:'Your general suggests mandatory drills for village militias. Shall we enforce it?', 
 choices:[
   {id:'r22_yes', label:'Enforce drills', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Population',d:-1}]},
   {id:'r22_no', label:'Leave militias alone', effects:[{k:'Strength',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r23', type:'festival', text:'Dancers in Luthmere want royal musicians for their solstice celebration. Lend them?', 
 choices:[
   {id:'r23_yes', label:'Send musicians', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r23_no', label:'Decline the request', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r24', type:'justice', text:'A corrupt magistrate in Wrenford is accused of bribery. Shall we remove him?', 
 choices:[
   {id:'r24_yes', label:'Remove the magistrate', effects:[{k:'Control',d:2},{k:'Population',d:1}]},
   {id:'r24_no', label:'Leave him in office', effects:[{k:'Control',d:-2},{k:'Money',d:1}]}
 ]},

{id:'r25', type:'education', text:'A scholar offers to open a free arithmetic school in Baywell if granted land. Shall we agree?', 
 choices:[
   {id:'r25_yes', label:'Grant the land', effects:[{k:'Education',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r25_no', label:'Refuse the scholar', effects:[{k:'Education',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r26', type:'defense', text:'The castleâ€™s walls are weathered and cracked. Shall we order urgent repairs?', 
 choices:[
   {id:'r26_yes', label:'Repair the walls', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r26_no', label:'Delay the repairs', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r27', type:'trade', text:'River barges clog the docks of Ironmere. A canal expansion is proposed. Approve?', 
 choices:[
   {id:'r27_yes', label:'Fund the canal', effects:[{k:'Control',d:1},{k:'Money',d:-2},{k:'Population',d:1}]},
   {id:'r27_no', label:'Refuse the project', effects:[{k:'Control',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r28', type:'religion', text:'Priests demand outlawing of public gambling. Shall we enforce the ban?', 
 choices:[
   {id:'r28_yes', label:'Ban gambling', effects:[{k:'Religion',d:2},{k:'Control',d:1},{k:'Population',d:-1}]},
   {id:'r28_no', label:'Permit gambling', effects:[{k:'Religion',d:-1},{k:'Money',d:1}]}
 ]},

{id:'r29', type:'exploration', text:'Adventurers ask for sponsorship to chart the Western Marsh. Support them?', 
 choices:[
   {id:'r29_yes', label:'Sponsor expedition', effects:[{k:'Education',d:1},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r29_no', label:'Refuse support', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r30', type:'nobles', text:'The Duke of Kelmere demands tax exemption for his estates. Shall we yield?', 
 choices:[
   {id:'r30_yes', label:'Grant exemption', effects:[{k:'Control',d:-1},{k:'Money',d:-2}]},
   {id:'r30_no', label:'Refuse the duke', effects:[{k:'Control',d:1},{k:'Strength',d:1}]}
 ]},

{id:'r31', type:'health', text:'A healer offers new herbal remedies, but nobles call it witchcraft. Shall we endorse her?', 
 choices:[
   {id:'r31_yes', label:'Endorse her work', effects:[{k:'Education',d:1},{k:'Population',d:1},{k:'Religion',d:-1}]},
   {id:'r31_no', label:'Ban her practice', effects:[{k:'Religion',d:1},{k:'Population',d:-1}]}
 ]},

{id:'r32', type:'diplomacy', text:'Envoys from Caldwin request safe passage through our realm. Permit it?', 
 choices:[
   {id:'r32_yes', label:'Grant passage', effects:[{k:'Control',d:1},{k:'Strength',d:-1}]},
   {id:'r32_no', label:'Deny passage', effects:[{k:'Control',d:-1},{k:'Strength',d:1}]}
 ]},

{id:'r33', type:'tax', text:'Merchants protest rising tariffs at Goldfen market. Lower them?', 
 choices:[
   {id:'r33_yes', label:'Lower tariffs', effects:[{k:'Population',d:1},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r33_no', label:'Keep tariffs high', effects:[{k:'Money',d:1},{k:'Population',d:-1}]}
 ]},

{id:'r34', type:'military', text:'Your captain suggests building a new armory in Ravenshollow. Approve?', 
 choices:[
   {id:'r34_yes', label:'Build the armory', effects:[{k:'Strength',d:2},{k:'Money',d:-2}]},
   {id:'r34_no', label:'Decline project', effects:[{k:'Strength',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r35', type:'culture', text:'A bard troupe requests to tour villages with royal backing. Grant permission?', 
 choices:[
   {id:'r35_yes', label:'Sponsor the tour', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r35_no', label:'Refuse the troupe', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r36', type:'religion', text:'An order of monks seeks permission to collect alms more widely. Allow it?', 
 choices:[
   {id:'r36_yes', label:'Allow alms', effects:[{k:'Religion',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r36_no', label:'Forbid it', effects:[{k:'Religion',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r37', type:'justice', text:'A thief stole bread in Harrenbrook. Villagers ask for mercy. Shall we pardon him?', 
 choices:[
   {id:'r37_yes', label:'Pardon the thief', effects:[{k:'Population',d:1},{k:'Control',d:-1}]},
   {id:'r37_no', label:'Punish harshly', effects:[{k:'Control',d:1},{k:'Population',d:-1}]}
 ]},

{id:'r38', type:'education', text:'A group of scribes offer to copy ancient manuscripts if provided ink and parchment. Support them?', 
 choices:[
   {id:'r38_yes', label:'Provide supplies', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-1}]},
   {id:'r38_no', label:'Decline support', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r39', type:'harvest', text:'Locusts ravage the fields of Thornstead. Shall we send guards to protect what remains?', 
 choices:[
   {id:'r39_yes', label:'Send guards', effects:[{k:'Strength',d:1},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r39_no', label:'Do nothing', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r40', type:'diplomacy', text:'A minor lord proposes marriage between his daughter and your cousin. Accept?', 
 choices:[
   {id:'r40_yes', label:'Accept alliance', effects:[{k:'Control',d:1},{k:'Strength',d:1},{k:'Culture',d:1}]},
   {id:'r40_no', label:'Refuse proposal', effects:[{k:'Control',d:-1},{k:'Strength',d:-1}]}
 ]},
  {id:'r41', type:'religion', text:'Clerics suggest holding a grand procession through the capital to honor the gods. Approve it?', 
 choices:[
   {id:'r41_yes', label:'Approve procession', effects:[{k:'Religion',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r41_no', label:'Decline event', effects:[{k:'Religion',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r42', type:'education', text:'A philosopher wishes to debate publicly on justice and virtue. Allow him?', 
 choices:[
   {id:'r42_yes', label:'Allow debate', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Control',d:-1}]},
   {id:'r42_no', label:'Forbid it', effects:[{k:'Education',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r43', type:'military', text:'Soldiers request better rations to improve morale. Grant them?', 
 choices:[
   {id:'r43_yes', label:'Grant rations', effects:[{k:'Strength',d:2},{k:'Population',d:1},{k:'Money',d:-2}]},
   {id:'r43_no', label:'Deny request', effects:[{k:'Strength',d:-2},{k:'Population',d:-1}]}
 ]},

{id:'r44', type:'festival', text:'The villagers of Eldhollow want a day of rest to celebrate midsummer. Shall we permit it?', 
 choices:[
   {id:'r44_yes', label:'Permit celebration', effects:[{k:'Culture',d:1},{k:'Population',d:1},{k:'Control',d:-1}]},
   {id:'r44_no', label:'Deny the holiday', effects:[{k:'Population',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r45', type:'justice', text:'Bandits captured near the border await judgment. Shall we execute them publicly?', 
 choices:[
   {id:'r45_yes', label:'Execute publicly', effects:[{k:'Control',d:2},{k:'Strength',d:1},{k:'Culture',d:-1}]},
   {id:'r45_no', label:'Spare or exile them', effects:[{k:'Population',d:1},{k:'Strength',d:-1}]}
 ]},

{id:'r46', type:'trade', text:'Spice merchants want exclusive rights to sell in the capital. Grant monopoly?', 
 choices:[
   {id:'r46_yes', label:'Grant monopoly', effects:[{k:'Money',d:2},{k:'Control',d:-1},{k:'Population',d:-1}]},
   {id:'r46_no', label:'Deny monopoly', effects:[{k:'Money',d:-1},{k:'Population',d:1}]}
 ]},

{id:'r47', type:'religion', text:'An abbey asks for timber to build a new chapel. Shall we provide it?', 
 choices:[
   {id:'r47_yes', label:'Provide timber', effects:[{k:'Religion',d:2},{k:'Culture',d:1},{k:'Money',d:-1}]},
   {id:'r47_no', label:'Refuse request', effects:[{k:'Religion',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r48', type:'education', text:'A mathematician proposes using new techniques to measure land boundaries. Support him?', 
 choices:[
   {id:'r48_yes', label:'Support methods', effects:[{k:'Education',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r48_no', label:'Reject methods', effects:[{k:'Education',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r49', type:'military', text:'Veterans request pensions for their service. Shall we provide them?', 
 choices:[
   {id:'r49_yes', label:'Provide pensions', effects:[{k:'Population',d:1},{k:'Strength',d:1},{k:'Money',d:-2}]},
   {id:'r49_no', label:'Refuse pensions', effects:[{k:'Strength',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r50', type:'culture', text:'A playwright writes a satirical play mocking corrupt lords. Allow performance?', 
 choices:[
   {id:'r50_yes', label:'Allow the play', effects:[{k:'Culture',d:2},{k:'Education',d:1},{k:'Control',d:-1}]},
   {id:'r50_no', label:'Ban performance', effects:[{k:'Culture',d:-1},{k:'Control',d:1}]}
 ]},

{id:'r51', type:'harvest', text:'A poor harvest has left barns half-empty. Should we open the royal granary?', 
 choices:[
   {id:'r51_yes', label:'Open granary', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r51_no', label:'Keep it closed', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r52', type:'diplomacy', text:'Envoys from the north bring gifts but expect lavish feasts in return. Host them?', 
 choices:[
   {id:'r52_yes', label:'Host feasts', effects:[{k:'Culture',d:1},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r52_no', label:'Decline excess', effects:[{k:'Control',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r53', type:'justice', text:'A nobleman strikes a peasant in public. Shall we punish him?', 
 choices:[
   {id:'r53_yes', label:'Punish nobleman', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Strength',d:-1}]},
   {id:'r53_no', label:'Ignore offense', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r54', type:'festival', text:'Fishermen request funds for a festival blessing the sea. Shall we agree?', 
 choices:[
   {id:'r54_yes', label:'Fund the festival', effects:[{k:'Culture',d:1},{k:'Religion',d:1},{k:'Money',d:-1}]},
   {id:'r54_no', label:'Deny funding', effects:[{k:'Culture',d:-1},{k:'Religion',d:-1}]}
 ]},

{id:'r55', type:'military', text:'Scouts warn of raiders near the border. Send troops to patrol?', 
 choices:[
   {id:'r55_yes', label:'Send patrols', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r55_no', label:'Ignore warning', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r56', type:'religion', text:'Some zealots preach against foreign merchants. Shall we silence them?', 
 choices:[
   {id:'r56_yes', label:'Silence zealots', effects:[{k:'Control',d:1},{k:'Religion',d:-1},{k:'Money',d:1}]},
   {id:'r56_no', label:'Allow preaching', effects:[{k:'Religion',d:2},{k:'Control',d:-1}]}
 ]},

{id:'r57', type:'education', text:'A guild of alchemists asks for funding to study metals. Approve?', 
 choices:[
   {id:'r57_yes', label:'Fund study', effects:[{k:'Education',d:2},{k:'Strength',d:1},{k:'Money',d:-2}]},
   {id:'r57_no', label:'Refuse funding', effects:[{k:'Education',d:-1},{k:'Strength',d:-1}]}
 ]},

{id:'r58', type:'culture', text:'An artist paints a mural of your reign. Shall we unveil it in the capital?', 
 choices:[
   {id:'r58_yes', label:'Unveil mural', effects:[{k:'Culture',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r58_no', label:'Keep hidden', effects:[{k:'Culture',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r59', type:'justice', text:'A thief guild offers bribes in exchange for tolerance. Accept or punish?', 
 choices:[
   {id:'r59_yes', label:'Accept bribes', effects:[{k:'Money',d:2},{k:'Control',d:-2}]},
   {id:'r59_no', label:'Punish guild', effects:[{k:'Control',d:2},{k:'Money',d:-1}]}
 ]},

{id:'r60', type:'diplomacy', text:'The Queen of a neighboring realm invites you to exchange scholars. Accept?', 
 choices:[
   {id:'r60_yes', label:'Accept exchange', effects:[{k:'Education',d:2},{k:'Culture',d:1}]},
   {id:'r60_no', label:'Decline exchange', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},
  {id:'r61', type:'religion', text:'A prophet claims visions of doom unless the kingdom repents. Shall we heed him?', 
 choices:[
   {id:'r61_yes', label:'Heed prophet', effects:[{k:'Religion',d:2},{k:'Control',d:-1}]},
   {id:'r61_no', label:'Dismiss prophet', effects:[{k:'Religion',d:-2},{k:'Control',d:1}]}
 ]},

{id:'r62', type:'education', text:'Scholars propose building a library to preserve knowledge. Approve?', 
 choices:[
   {id:'r62_yes', label:'Approve library', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r62_no', label:'Reject project', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r63', type:'military', text:'A famed general asks for more troops to guard distant forts. Grant request?', 
 choices:[
   {id:'r63_yes', label:'Grant troops', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r63_no', label:'Refuse troops', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r64', type:'festival', text:'Farmers want to hold a harvest dance in your honor. Allow it?', 
 choices:[
   {id:'r64_yes', label:'Allow dance', effects:[{k:'Culture',d:1},{k:'Population',d:1},{k:'Control',d:-1}]},
   {id:'r64_no', label:'Disallow event', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r65', type:'justice', text:'A corrupt judge has been exposed. Shall we strip his title?', 
 choices:[
   {id:'r65_yes', label:'Strip title', effects:[{k:'Control',d:2},{k:'Education',d:1},{k:'Strength',d:-1}]},
   {id:'r65_no', label:'Spare him', effects:[{k:'Control',d:-2},{k:'Population',d:-1}]}
 ]},

{id:'r66', type:'trade', text:'A caravan offers exotic silks if we lower import taxes. Agree?', 
 choices:[
   {id:'r66_yes', label:'Lower taxes', effects:[{k:'Money',d:-1},{k:'Culture',d:1},{k:'Population',d:1}]},
   {id:'r66_no', label:'Keep taxes', effects:[{k:'Money',d:2},{k:'Culture',d:-1}]}
 ]},

{id:'r67', type:'religion', text:'Priests propose enforcing stricter temple attendance. Approve?', 
 choices:[
   {id:'r67_yes', label:'Enforce attendance', effects:[{k:'Religion',d:2},{k:'Control',d:1},{k:'Population',d:-1}]},
   {id:'r67_no', label:'Decline enforcement', effects:[{k:'Religion',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r68', type:'education', text:'Apprentices request tools to learn craftsmanship. Provide them?', 
 choices:[
   {id:'r68_yes', label:'Provide tools', effects:[{k:'Education',d:2},{k:'Strength',d:1},{k:'Money',d:-1}]},
   {id:'r68_no', label:'Refuse tools', effects:[{k:'Education',d:-1},{k:'Strength',d:-1}]}
 ]},

{id:'r69', type:'military', text:'A new weapon design is proposed by blacksmiths. Fund its trials?', 
 choices:[
   {id:'r69_yes', label:'Fund trials', effects:[{k:'Strength',d:2},{k:'Education',d:1},{k:'Money',d:-2}]},
   {id:'r69_no', label:'Refuse trials', effects:[{k:'Strength',d:-1},{k:'Education',d:-1}]}
 ]},

{id:'r70', type:'culture', text:'A troupe of dancers offers to perform at court. Accept?', 
 choices:[
   {id:'r70_yes', label:'Accept dancers', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r70_no', label:'Decline offer', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r71', type:'harvest', text:'Locusts threaten crops. Shall we organize burning of fields to stop them?', 
 choices:[
   {id:'r71_yes', label:'Burn fields', effects:[{k:'Population',d:1},{k:'Strength',d:1},{k:'Money',d:-2}]},
   {id:'r71_no', label:'Do nothing', effects:[{k:'Population',d:-2},{k:'Strength',d:-1}]}
 ]},

{id:'r72', type:'diplomacy', text:'An ally asks for marriage ties with your family. Accept proposal?', 
 choices:[
   {id:'r72_yes', label:'Accept marriage', effects:[{k:'Control',d:1},{k:'Culture',d:1},{k:'Population',d:1}]},
   {id:'r72_no', label:'Decline proposal', effects:[{k:'Control',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r73', type:'justice', text:'Peasants accuse tax collectors of extortion. Shall we investigate?', 
 choices:[
   {id:'r73_yes', label:'Investigate', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r73_no', label:'Ignore claims', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r74', type:'festival', text:'A bard offers to compose an anthem for your reign. Support him?', 
 choices:[
   {id:'r74_yes', label:'Support bard', effects:[{k:'Culture',d:2},{k:'Religion',d:1},{k:'Money',d:-1}]},
   {id:'r74_no', label:'Decline support', effects:[{k:'Culture',d:-1},{k:'Religion',d:-1}]}
 ]},

{id:'r75', type:'military', text:'Your navy requests funds to build faster ships. Approve?', 
 choices:[
   {id:'r75_yes', label:'Approve ships', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r75_no', label:'Reject funding', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r76', type:'religion', text:'Heretics spread pamphlets questioning divine order. Suppress them?', 
 choices:[
   {id:'r76_yes', label:'Suppress pamphlets', effects:[{k:'Religion',d:2},{k:'Control',d:1},{k:'Education',d:-1}]},
   {id:'r76_no', label:'Allow dissent', effects:[{k:'Education',d:1},{k:'Religion',d:-2}]}
 ]},

{id:'r77', type:'education', text:'Students request your patronage for a new academy. Will you give it?', 
 choices:[
   {id:'r77_yes', label:'Fund academy', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r77_no', label:'Refuse patronage', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r78', type:'culture', text:'An ancient ruin is found. Should we preserve it as heritage?', 
 choices:[
   {id:'r78_yes', label:'Preserve ruin', effects:[{k:'Culture',d:2},{k:'Education',d:1},{k:'Money',d:-1}]},
   {id:'r78_no', label:'Leave it unused', effects:[{k:'Culture',d:-1},{k:'Education',d:-1}]}
 ]},

{id:'r79', type:'justice', text:'Criminals are stealing grain. Should we impose harsher punishments?', 
 choices:[
   {id:'r79_yes', label:'Impose punishments', effects:[{k:'Control',d:2},{k:'Strength',d:1},{k:'Population',d:-1}]},
   {id:'r79_no', label:'Keep leniency', effects:[{k:'Population',d:1},{k:'Control',d:-1}]}
 ]},

{id:'r80', type:'diplomacy', text:'Envoys propose a cultural exchange of musicians. Accept?', 
 choices:[
   {id:'r80_yes', label:'Accept exchange', effects:[{k:'Culture',d:2},{k:'Education',d:1}]},
   {id:'r80_no', label:'Decline exchange', effects:[{k:'Culture',d:-1},{k:'Education',d:-1}]}
 ]},
  {id:'r81', type:'religion', text:'Pilgrims ask for safe passage through your lands. Allow escorts?', 
 choices:[
   {id:'r81_yes', label:'Provide escorts', effects:[{k:'Religion',d:2},{k:'Strength',d:1},{k:'Money',d:-1}]},
   {id:'r81_no', label:'Deny escorts', effects:[{k:'Religion',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r82', type:'education', text:'Philosophers want a public forum for debates. Permit them?', 
 choices:[
   {id:'r82_yes', label:'Permit forum', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Control',d:-1}]},
   {id:'r82_no', label:'Deny debates', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r83', type:'military', text:'Your captain suggests night patrols for safety. Approve?', 
 choices:[
   {id:'r83_yes', label:'Approve patrols', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r83_no', label:'Refuse patrols', effects:[{k:'Strength',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r84', type:'culture', text:'Artists request walls to paint murals celebrating the kingdom. Support?', 
 choices:[
   {id:'r84_yes', label:'Support murals', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r84_no', label:'Decline support', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r85', type:'justice', text:'Bandits are captured. Do you execute them publicly?', 
 choices:[
   {id:'r85_yes', label:'Execute publicly', effects:[{k:'Control',d:2},{k:'Strength',d:1},{k:'Population',d:-1}]},
   {id:'r85_no', label:'Spare or exile them', effects:[{k:'Control',d:-1},{k:'Population',d:1}]}
 ]},

{id:'r86', type:'trade', text:'Merchants ask to mint new coins with your image. Allow it?', 
 choices:[
   {id:'r86_yes', label:'Mint coins', effects:[{k:'Culture',d:1},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r86_no', label:'Reject request', effects:[{k:'Culture',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r87', type:'religion', text:'Clergy want funds to repair a crumbling shrine. Approve?', 
 choices:[
   {id:'r87_yes', label:'Approve funds', effects:[{k:'Religion',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r87_no', label:'Decline repairs', effects:[{k:'Religion',d:-2},{k:'Culture',d:-1}]}
 ]},

{id:'r88', type:'education', text:'Astronomers ask to build an observatory. Will you fund it?', 
 choices:[
   {id:'r88_yes', label:'Fund observatory', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'r88_no', label:'Refuse project', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r89', type:'military', text:'Weapons stockpiles are aging. Reforge them?', 
 choices:[
   {id:'r89_yes', label:'Reforge weapons', effects:[{k:'Strength',d:2},{k:'Money',d:-2}]},
   {id:'r89_no', label:'Ignore stockpiles', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r90', type:'population', text:'A plague spreads in villages. Shall we quarantine them?', 
 choices:[
   {id:'r90_yes', label:'Quarantine villages', effects:[{k:'Population',d:-1},{k:'Control',d:2},{k:'Strength',d:1}]},
   {id:'r90_no', label:'Avoid quarantine', effects:[{k:'Population',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r91', type:'culture', text:'A legendary singer passes by your court. Host a concert?', 
 choices:[
   {id:'r91_yes', label:'Host concert', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r91_no', label:'Decline hosting', effects:[{k:'Culture',d:-1},{k:'Population',d:-1}]}
 ]},

{id:'r92', type:'justice', text:'A noble defies your law in public. Punish him?', 
 choices:[
   {id:'r92_yes', label:'Punish noble', effects:[{k:'Control',d:2},{k:'Population',d:1},{k:'Strength',d:-1}]},
   {id:'r92_no', label:'Spare noble', effects:[{k:'Control',d:-2},{k:'Population',d:-1}]}
 ]},

{id:'r93', type:'religion', text:'Monks ask to translate sacred texts. Do you allow?', 
 choices:[
   {id:'r93_yes', label:'Allow translation', effects:[{k:'Religion',d:1},{k:'Education',d:2}]},
   {id:'r93_no', label:'Forbid translation', effects:[{k:'Religion',d:-1},{k:'Education',d:-1}]}
 ]},

{id:'r94', type:'education', text:'Students seek a royal grant for a university theater. Fund it?', 
 choices:[
   {id:'r94_yes', label:'Fund theater', effects:[{k:'Education',d:2},{k:'Culture',d:2},{k:'Money',d:-2}]},
   {id:'r94_no', label:'Refuse grant', effects:[{k:'Education',d:-1},{k:'Culture',d:-1}]}
 ]},

{id:'r95', type:'military', text:'A border wall has crumbled. Shall we rebuild?', 
 choices:[
   {id:'r95_yes', label:'Rebuild wall', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'r95_no', label:'Ignore wall', effects:[{k:'Strength',d:-2},{k:'Control',d:-1}]}
 ]},

{id:'r96', type:'population', text:'Peasants want rights to form guilds. Approve?', 
 choices:[
   {id:'r96_yes', label:'Approve guilds', effects:[{k:'Population',d:2},{k:'Education',d:1},{k:'Control',d:-1}]},
   {id:'r96_no', label:'Reject guilds', effects:[{k:'Population',d:-2},{k:'Control',d:1}]}
 ]},

{id:'r97', type:'culture', text:'A sculptor offers to carve your likeness in stone. Accept?', 
 choices:[
   {id:'r97_yes', label:'Accept statue', effects:[{k:'Culture',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'r97_no', label:'Decline offer', effects:[{k:'Culture',d:-1},{k:'Control',d:-1}]}
 ]},

{id:'r98', type:'religion', text:'Clerics warn of omens in the stars. Shall we perform rituals?', 
 choices:[
   {id:'r98_yes', label:'Perform rituals', effects:[{k:'Religion',d:2},{k:'Population',d:1},{k:'Money',d:-1}]},
   {id:'r98_no', label:'Ignore omens', effects:[{k:'Religion',d:-2},{k:'Population',d:-1}]}
 ]},

{id:'r99', type:'education', text:'Inventors want backing for a new clockwork device. Support them?', 
 choices:[
   {id:'r99_yes', label:'Support device', effects:[{k:'Education',d:2},{k:'Strength',d:1},{k:'Money',d:-2}]},
   {id:'r99_no', label:'Reject idea', effects:[{k:'Education',d:-1},{k:'Strength',d:-1}]}
 ]},

{id:'r100', type:'legacy', text:'As your century closes, scribes ask how you wish to be remembered. Encourage chronicles?', 
 choices:[
   {id:'r100_yes', label:'Encourage chronicles', effects:[{k:'Culture',d:2},{k:'Education',d:1},{k:'Religion',d:1}]},
   {id:'r100_no', label:'Forbid chronicles', effects:[{k:'Culture',d:-2},{k:'Education',d:-1}]}
 ]}
];

  const SPECIAL = [
{id:'s01', decade:1, text:'Ferdinand Magellan offers to sail under your banner to find a western sea route to the spice islands. Supporting his voyage could bring glory and knowledge, but many sailors may be lost to the unknown seas.', 
  choices: [
    { id: 's01_yes', label: 'Fund Him', effects:[ {k:'Culture', d:2}, {k:'Strength', d:1}, {k:'Population', d:-2}, {k:'Education', d:1}
    ]},
    { id: 's01_no',  label: 'Refuse', effects:[ {k:'Culture', d:-1}, {k:'Control', d:1}, {k:'Population', d:1}
    ]}]},

{id:'s02', decade:1, text:'Leonardo da Vinciâ€™s final works arrive in your court. Preserving them would enrich your legacy and inspire learning, but the attention it requires may distract from other matters.', 
  choices: [
    { id: 's02_yes', label: 'Preserve', effects:[ {k:'Culture', d:3}, {k:'Education', d:1}, {k:'Control', d:0}, {k:'Population', d:-1}
    ]},
    { id: 's02_no',  label: 'Ignore', effects:[ {k:'Culture', d:-2}, {k:'Control', d:1}, {k:'Money', d:1}
    ]}]},

{id:'s03', decade:1, text:'Merchants returning from the New World request settlers and soldiers to secure their claims. Assisting them strengthens your forces, but many citizens may leave and traditions could fade.', 
  choices: [
    { id: 's03_yes', label: 'Support Colonization', effects:[ {k:'Strength', d:2}, {k:'Control', d:1}, {k:'Population', d:-2}
    ]},
    { id: 's03_no',  label: 'Keep People Home', effects:[ {k:'Population', d:1}, {k:'Culture', d:0}, {k:'Money', d:0}
    ]}]},

{id:'s04', decade:1, text:'The printing press is spreading across Europe, changing how ideas circulate. Establishing official presses could unify doctrine and inspire culture, but local traditions may suffer.',
  choices: [
    { id: 's04_yes', label: 'Establish', effects:[ {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Religion', d:1}, {k:'Population', d:-1}
    ]},
    { id: 's04_no',  label: 'Resist the Press', effects:[ {k:'Control', d:1}, {k:'Culture', d:-1}, {k:'Education', d:-1}
    ]}]},

{id:'s05', decade:2, text:'Conquistadors return from distant lands with treasures and tales of mighty empires. Sending more expeditions could expand your influence, but many young men may never return.',  
  choices: [  
    { id: 's05_yes', label: 'Send Expeditions', effects:[ {k:'Strength', d:2}, {k:'Culture', d:1}, {k:'Population', d:-2}, {k:'Control', d:-1} ]},  
    { id: 's05_no',  label: 'Stay Home', effects:[ {k:'Control', d:1}, {k:'Population', d:1}, {k:'Strength', d:-1} ]}]},  

{id:'s06', decade:2, text:'Michelangelo unveils the Last Judgment in the Sistine Chapel. Will you commission your own grand work to rival Romeâ€™s, even if it distracts from military needs?',  
  choices: [  
    { id: 's06_yes', label: 'Commission Grand Work', effects:[ {k:'Culture', d:3}, {k:'Strength', d:-2}, {k:'Control', d:1} ]},  
    { id: 's06_no',  label: 'Focus on Military', effects:[ {k:'Strength', d:2}, {k:'Culture', d:-2}, {k:'Control', d:-1} ]}]},  

{id:'s07', decade:2, text:'A surge of Protestant reformers challenge the authority of the church. Supporting reform could gain popular favor, but might fracture unity and weaken order.',  
  choices: [  
    { id: 's07_yes', label: 'Support Reformers', effects:[ {k:'Culture', d:2}, {k:'Population', d:1}, {k:'Religion', d:-2}, {k:'Control', d:-2} ]},  
    { id: 's07_no',  label: 'Suppress Reform', effects:[ {k:'Control', d:2}, {k:'Religion', d:2}, {k:'Culture', d:-1}, {k:'Population', d:-1} ]}]},  

{id:'s08', decade:2, text:'Cartographers request support to map newly discovered coasts. Funding them would expand knowledge and prestige, though it means diverting resources from governance.',  
  choices: [  
    { id: 's08_yes', label: 'Fund Mapping', effects:[ {k:'Education', d:3}, {k:'Culture', d:1}, {k:'Control', d:-1} ]},  
    { id: 's08_no',  label: 'Prioritize Governance', effects:[ {k:'Control', d:2}, {k:'Education', d:-1}, {k:'Culture', d:-1} ]}]},

{id:'s09', decade:3, text:'Tycho Brahe requests patronage to improve astronomical instruments. Supporting his research could advance knowledge and culture, but divert attention from other affairs may strain your forces.',  
  choices:[  
    {id:'s09_yes', label:'Support Research', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Population', d:-1}, {k:'Strength', d:-1}]},  
    {id:'s09_no', label:'Decline', effects:[{k:'Control', d:2}, {k:'Strength', d:1}, {k:'Culture', d:-1}]}]},

{id:'s10', decade:3, text:'Rumors spread of rich silver mines overseas. Claiming them could expand your influence, but the journey is perilous and some settlers may be lost.',  
  choices:[  
    {id:'s10_yes', label:'Claim Mines', effects:[{k:'Strength', d:2}, {k:'Population', d:-2}, {k:'Culture', d:1}, {k:'Control', d:1}]},  
    {id:'s10_no', label:'Avoid Risk', effects:[{k:'Population', d:1}, {k:'Control', d:2}, {k:'Strength', d:-1}]}]},

{id:'s11', decade:3, text:'The Council of Trent reaffirms traditional doctrine against Protestant reformers. Enforcing its decrees strictly would strengthen religious unity, but risk alienating some citizens.',  
  choices:[  
    {id:'s11_yes', label:'Enforce Decrees', effects:[{k:'Religion', d:3}, {k:'Control', d:2}, {k:'Population', d:-1}, {k:'Culture', d:-1}]},  
    {id:'s11_no', label:'Tolerate Reform', effects:[{k:'Population', d:1}, {k:'Culture', d:2}, {k:'Control', d:-1}, {k:'Religion', d:-2}]}]},

{id:'s12', decade:3, text:'Shipbuilders propose a new class of galleons for both trade and war. Approving their construction strengthens your navy, but demands manpower and focus, leaving fewer people for other tasks.',  
  choices:[  
    {id:'s12_yes', label:'Build Galleons', effects:[{k:'Strength', d:3}, {k:'Population', d:-1}, {k:'Culture', d:1}, {k:'Education', d:1}]},  
    {id:'s12_no', label:'Delay Construction', effects:[{k:'Population', d:1}, {k:'Control', d:2}, {k:'Strength', d:-2}]}]},

{id:'s13', decade:4, text:'Sir Francis Drake offers to raid rival treasure fleets on your behalf. Will you grant him commission, or refuse to avoid open conflict?',  
  choices:[  
    {id:'s13_yes', label:'Commission Drake', effects:[{k:'Money', d:3}, {k:'Strength', d:2}, {k:'Control', d:-2}, {k:'Culture', d:1}]},  
    {id:'s13_no', label:'Avoid Conflict', effects:[{k:'Control', d:2}, {k:'Population', d:1}, {k:'Strength', d:-1}]}]},

{id:'s14', decade:4, text:'William Shakespeareâ€™s plays gain immense popularity. Will you sponsor a theater to promote culture, or dismiss it as frivolous entertainment?',  
  choices:[  
    {id:'s14_yes', label:'Sponsor Theater', effects:[{k:'Culture', d:4}, {k:'Education', d:1}, {k:'Population', d:-1}]},  
    {id:'s14_no', label:'Dismiss', effects:[{k:'Culture', d:-2}, {k:'Control', d:1}, {k:'Strength', d:1}]}]},

{id:'s15', decade:4, text:'A major port city in your realm suffers from plague. Will you quarantine and rebuild, or let commerce resume quickly despite the risk?',  
  choices:[  
    {id:'s15_yes', label:'Quarantine and Rebuild', effects:[{k:'Population', d:2}, {k:'Control', d:1}, {k:'Money', d:-2}]},  
    {id:'s15_no', label:'Resume Commerce', effects:[{k:'Population', d:-2}, {k:'Money', d:2}, {k:'Strength', d:1}]}]},

{id:'s16', decade:4, text:'Mathematicians request royal patronage to compile advanced navigation tables. Will you finance their work, or focus on immediate military spending?',  
  choices:[  
    {id:'s16_yes', label:'Finance Tables', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Control', d:-1}]},  
    {id:'s16_no', label:'Prioritize Military', effects:[{k:'Strength', d:2}, {k:'Control', d:1}, {k:'Education', d:-2}]}]},

{id:'s17', decade:5, text:'Galileo Galilei offers to demonstrate his improved telescope. Will you fund his research, or ignore it to avoid controversy with religious authorities?',  
  choices:[  
    {id:'s17_yes', label:'Fund Telescope', effects:[{k:'Education', d:4}, {k:'Culture', d:2}, {k:'Control', d:-1}, {k:'Religion', d:-1}]},  
    {id:'s17_no', label:'Ignore Research', effects:[{k:'Control', d:2}, {k:'Religion', d:1}, {k:'Culture', d:-2}]}]},

{id:'s18', decade:5, text:'The first globe-spanning trade routes become viable. Will you invest in establishing your own, or keep focus on regional commerce?',  
  choices:[  
    {id:'s18_yes', label:'Invest Globally', effects:[{k:'Money', d:3}, {k:'Culture', d:2}, {k:'Control', d:2}]},  
    {id:'s18_no', label:'Focus Locally', effects:[{k:'Control', d:1}, {k:'Population', d:1}, {k:'Money', d:-1}]}]},

{id:'s19', decade:5, text:'Jesuit missionaries request funding to spread influence abroad. Will you approve their mission, or concentrate resources at home?',  
  choices:[  
    {id:'s19_yes', label:'Support Mission', effects:[{k:'Religion', d:3}, {k:'Culture', d:2}, {k:'Population', d:-1}]},  
    {id:'s19_no', label:'Concentrate at Home', effects:[{k:'Control', d:2}, {k:'Population', d:1}, {k:'Religion', d:-2}]}]},

{id:'s20', decade:5, text:'An inventor presents an early mechanical calculator. Will you sponsor further development, or dismiss it as impractical?',  
  choices:[  
    {id:'s20_yes', label:'Sponsor Invention', effects:[{k:'Education', d:3}, {k:'Culture', d:1}, {k:'Control', d:-1}]},  
    {id:'s20_no', label:'Dismiss', effects:[{k:'Control', d:2}, {k:'Culture', d:-1}, {k:'Population', d:1}]}]},

{id:'s21', decade:6, text:'Johannes Kepler requests royal patronage to publish his laws of planetary motion. Will you fund his research or keep such knowledge under wraps to maintain religious authority?',  
  choices:[  
    {id:'s21_yes', label:'Fund Kepler', effects:[{k:'Education', d:4}, {k:'Culture', d:2}, {k:'Money', d:-2}, {k:'Religion', d:-1}]},  
    {id:'s21_no', label:'Suppress Knowledge', effects:[{k:'Control', d:2}, {k:'Religion', d:1}, {k:'Education', d:-2}]}]},

{id:'s22', decade:6, text:'Coffee from the East becomes a fashionable drink. Will you establish royal coffee houses to foster trade and culture, or dismiss it as a passing fad?',  
  choices:[  
    {id:'s22_yes', label:'Establish Coffee Houses', effects:[{k:'Culture', d:2}, {k:'Money', d:2}, {k:'Population', d:1}]},  
    {id:'s22_no', label:'Ignore Trend', effects:[{k:'Control', d:1}, {k:'Culture', d:-1}, {k:'Population', d:-1}]}]},

{id:'s23', decade:6, text:'The Thirty Yearsâ€™ War begins to engulf the continent. Will you intervene militarily to defend your allies, or remain neutral to preserve resources?',  
  choices:[  
    {id:'s23_yes', label:'Intervene', effects:[{k:'Strength', d:3}, {k:'Control', d:2}, {k:'Population', d:-1}, {k:'Money', d:-2}]},  
    {id:'s23_no', label:'Remain Neutral', effects:[{k:'Control', d:2}, {k:'Money', d:1}, {k:'Population', d:1}, {k:'Strength', d:-2}]}]},

{id:'s24', decade:6, text:'Royal architects propose a grand palace to display your power. Will you commission it now, or delay construction for more pressing needs?',  
  choices:[  
    {id:'s24_yes', label:'Commission Palace', effects:[{k:'Culture', d:3}, {k:'Control', d:2}, {k:'Population', d:-1}, {k:'Money', d:-3}]},  
    {id:'s24_no', label:'Delay Construction', effects:[{k:'Control', d:1}, {k:'Strength', d:2}, {k:'Money', d:2}]}]}, 
    
{id:'s25', decade:7, text:'Rene Descartes offers to dedicate his philosophical works to your court. Will you support his ideas of reason and science, or reject them to uphold tradition?', 
  choices:[  
    {id:'s25_yes', label:'Support', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Religion', d:-1}]},  
    {id:'s25_no', label:'Reject', effects:[{k:'Control', d:2}, {k:'Culture', d:-1}, {k:'Population', d:1}]}]},

{id:'s26', decade:7, text:'A plague outbreak threatens your largest trade hub. Will you fund quarantines and hospitals, or keep trade flowing to avoid economic collapse?',  
  choices:[  
    {id:'s26_yes', label:'Fund Aid', effects:[{k:'Population', d:2}, {k:'Control', d:2}, {k:'Money', d:-3}]},  
    {id:'s26_no', label:'Keep Trade', effects:[{k:'Money', d:2}, {k:'Population', d:-2}, {k:'Control', d:-1}]}]},

{id:'s27', decade:7, text:'A new musket design promises greater battlefield efficiency. Will you equip your armies, or stick with proven arms to avoid costly re-training?',  
  choices:[  
    {id:'s27_yes', label:'Equip Armies', effects:[{k:'Strength', d:3}, {k:'Control', d:1}, {k:'Money', d:-2}]},  
    {id:'s27_no', label:'Stick with Old Arms', effects:[{k:'Money', d:1}, {k:'Strength', d:-2}, {k:'Population', d:1}]}]},

{id:'s28', decade:7, text:'Colonial governors report unrest and demand more autonomy. Will you grant concessions, or reinforce control from the capital?',  
  choices:[  
    {id:'s28_yes', label:'Grant Autonomy', effects:[{k:'Control', d:-1}, {k:'Strength', d:-1}, {k:'Population', d:2}]},  
    {id:'s28_no', label:'Reinforce Control', effects:[{k:'Control', d:3}, {k:'Strength', d:2}, {k:'Culture', d:-1}]}]},

{id:'s29', decade:8, text:'Isaac Newton presents his groundbreaking theories of motion and gravity. Will you sponsor his continued work, or decline to fund these abstract studies?',  
  choices:[  
    {id:'s29_yes', label:'Sponsor', effects:[{k:'Education', d:5}, {k:'Culture', d:3}, {k:'Money', d:-2}]},  
    {id:'s29_no', label:'Decline', effects:[{k:'Control', d:1}, {k:'Money', d:2}, {k:'Culture', d:-2}]}]},

{id:'s30', decade:8, text:'The Royal Society forms to advance scientific exchange. Will you become its patron, or focus on military innovation instead?',  
  choices:[  
    {id:'s30_yes', label:'Patron', effects:[{k:'Education', d:4}, {k:'Culture', d:2}, {k:'Money', d:-2}]},  
    {id:'s30_no', label:'Focus on Military', effects:[{k:'Strength', d:2}, {k:'Money', d:2}, {k:'Education', d:-2}]}]},

{id:'s31', decade:8, text:'Dutch traders propose a joint venture in lucrative spice trade. Will you invest heavily, or let private merchants take the risk?',  
  choices:[  
    {id:'s31_yes', label:'Invest', effects:[{k:'Money', d:4}, {k:'Culture', d:2}, {k:'Control', d:1}]},  
    {id:'s31_no', label:'Let Merchants Risk', effects:[{k:'Control', d:1}, {k:'Money', d:-1}, {k:'Culture', d:0}]}]},

{id:'s32', decade:8, text:'A massive fire devastates a key city. Will you rebuild with improved planning, or quickly restore what was lost to save funds?',  
  choices:[  
    {id:'s32_yes', label:'Rebuild Properly', effects:[{k:'Population', d:2}, {k:'Culture', d:2}, {k:'Money', d:-3}, {k:'Control', d:1}]},  
    {id:'s32_no', label:'Restore Quickly', effects:[{k:'Money', d:2}, {k:'Control', d:-1}, {k:'Population', d:-1}]}]},

{id:'s33', decade:9, text:'John Locke publishes works on government and liberty. Will you encourage these ideas to gain public support, or suppress them to maintain control?',  
  choices:[  
    {id:'s33_yes', label:'Encourage', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Population', d:1}, {k:'Control', d:-2}]},  
    {id:'s33_no', label:'Suppress', effects:[{k:'Control', d:3}, {k:'Population', d:-1}, {k:'Culture', d:-1}]}]},

{id:'s34', decade:9, text:'Naval officers propose establishing a permanent standing navy. Will you approve the budget, or keep a smaller force to save gold?',  
  choices:[  
    {id:'s34_yes', label:'Approve', effects:[{k:'Strength', d:4}, {k:'Control', d:2}, {k:'Money', d:-4}]},  
    {id:'s34_no', label:'Keep Small Force', effects:[{k:'Money', d:2}, {k:'Strength', d:-2}, {k:'Control', d:-1}]}]},

{id:'s35', decade:9, text:'The opera gains popularity among nobility. Will you sponsor royal performances, or invest in more practical endeavors?',  
  choices:[  
    {id:'s35_yes', label:'Sponsor', effects:[{k:'Culture', d:3}, {k:'Money', d:-2}]},  
    {id:'s35_no', label:'Practical Investments', effects:[{k:'Money', d:2}, {k:'Culture', d:-1}]}]},

{id:'s36', decade:9, text:'Merchants request exclusive rights to colonial resources. Will you grant the monopoly, or keep trade open to all?',  
  choices:[  
    {id:'s36_yes', label:'Grant Monopoly', effects:[{k:'Money', d:3}, {k:'Control', d:2}, {k:'Population', d:-1}]},  
    {id:'s36_no', label:'Keep Trade Open', effects:[{k:'Population', d:1}, {k:'Control', d:-1}, {k:'Money', d:-1}]}]},

{id:'s37', decade:10, text:'Gottfried Leibniz offers to bring his calculating machines to your court. Will you invest in this technology, or deem it unnecessary?',  
  choices:[  
    {id:'s37_yes', label:'Invest', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}]},  
    {id:'s37_no', label:'Decline', effects:[{k:'Money', d:2}, {k:'Education', d:-2}, {k:'Culture', d:-1}]}]},

{id:'s38', decade:10, text:'The War of Spanish Succession looms. Will you enter the conflict to secure influence, or remain neutral to protect your realm?',  
  choices:[  
    {id:'s38_yes', label:'Enter War', effects:[{k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}, {k:'Population', d:-1}]},  
    {id:'s38_no', label:'Remain Neutral', effects:[{k:'Money', d:2}, {k:'Population', d:1}, {k:'Control', d:-1}]}]},

{id:'s39', decade:10, text:'Public coffee houses become hotbeds of political discussion. Will you tolerate them for cultural growth, or suppress them to avoid dissent?',  
  choices:[  
    {id:'s39_yes', label:'Tolerate', effects:[{k:'Culture', d:2}, {k:'Population', d:1}, {k:'Control', d:-1}]},  
    {id:'s39_no', label:'Suppress', effects:[{k:'Control', d:2}, {k:'Culture', d:-1}, {k:'Population', d:-1}]}]},

{id:'s40', decade:10, text:'Artisans request funding to produce fine porcelain to rival the East. Will you support the industry, or let merchants import it instead?',  
  choices:[  
    {id:'s40_yes', label:'Support', effects:[{k:'Culture', d:3}, {k:'Money', d:-2}, {k:'Population', d:1}]},  
    {id:'s40_no', label:'Import Instead', effects:[{k:'Money', d:2}, {k:'Culture', d:-1}]}]}, 

{id:'s41', decade:11, text:'Voltaire seeks sanctuary and patronage after criticizing foreign rulers. Will you welcome him to your court, or refuse to avoid diplomatic tension?',  
  choices:[  
    {id:'s41_yes', label:'Welcome', effects:[{k:'Culture', d:3}, {k:'Education', d:2}, {k:'Control', d:-1}]},  
    {id:'s41_no', label:'Refuse', effects:[{k:'Control', d:2}, {k:'Culture', d:-1}, {k:'Population', d:1}]}]},

{id:'s42', decade:11, text:'Merchants propose the creation of a central bank. Will you approve to stabilize currency, or keep royal control over coinage?',  
  choices:[  
    {id:'s42_yes', label:'Approve', effects:[{k:'Money', d:3}, {k:'Control', d:2}, {k:'Culture', d:1}]},  
    {id:'s42_no', label:'Maintain Royal Control', effects:[{k:'Control', d:1}, {k:'Money', d:-1}, {k:'Culture', d:-1}]}]},

{id:'s43', decade:11, text:'Engineers present plans for a major canal to connect trade routes. Will you fund the project, or invest in roads instead?',  
  choices:[  
    {id:'s43_yes', label:'Fund Canal', effects:[{k:'Control', d:3}, {k:'Population', d:2}, {k:'Money', d:-4}]},  
    {id:'s43_no', label:'Invest in Roads', effects:[{k:'Money', d:-1}, {k:'Control', d:1}, {k:'Population', d:1}]}]},

{id:'s44', decade:11, text:'Smallpox inoculation is proposed by court physicians. Will you support the trials, or ban the practice as dangerous?',  
  choices:[  
    {id:'s44_yes', label:'Support', effects:[{k:'Population', d:3}, {k:'Education', d:2}, {k:'Religion', d:-1}]},  
    {id:'s44_no', label:'Ban', effects:[{k:'Control', d:2}, {k:'Population', d:-2}, {k:'Religion', d:1}]}]},

{id:'s45', decade:12, text:'Benjamin Franklin offers to share his experiments on electricity. Will you fund his work, or see it as mere curiosity?',  
  choices:[  
    {id:'s45_yes', label:'Fund', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-2}]},  
    {id:'s45_no', label:'Decline', effects:[{k:'Money', d:2}, {k:'Education', d:-2}, {k:'Culture', d:-1}]}]},

{id:'s46', decade:12, text:'A rival empireâ€™s navy grows alarmingly strong. Will you launch a shipbuilding program to match them, or focus on diplomacy?',  
  choices:[  
    {id:'s46_yes', label:'Build Navy', effects:[{k:'Strength', d:4}, {k:'Control', d:2}, {k:'Money', d:-3}]},  
    {id:'s46_no', label:'Focus on Diplomacy', effects:[{k:'Control', d:1}, {k:'Money', d:2}, {k:'Strength', d:-2}]}]},

{id:'s47', decade:12, text:'Naturalists request funding for an expedition to catalog distant lands. Will you sponsor them, or dismiss the venture as frivolous?',  
  choices:[  
    {id:'s47_yes', label:'Sponsor', effects:[{k:'Culture', d:2}, {k:'Education', d:2}, {k:'Money', d:-2}]},  
    {id:'s47_no', label:'Dismiss', effects:[{k:'Money', d:2}, {k:'Culture', d:-1}, {k:'Education', d:-1}]}]},

{id:'s48', decade:12, text:'Merchants propose standardized weights and measures to ease trade. Will you implement the reform, or leave local systems in place?',  
  choices:[  
    {id:'s48_yes', label:'Implement Reform', effects:[{k:'Control', d:3}, {k:'Money', d:2}, {k:'Education', d:1}]},  
    {id:'s48_no', label:'Keep Local Systems', effects:[{k:'Control', d:-1}, {k:'Culture', d:1}, {k:'Money', d:-1}]}]},

{id:'s49', decade:13, text:'James Watt demonstrates an improved steam engine. Will you invest in its development, or stick to traditional power sources?',  
  choices:[  
    {id:'s49_yes', label:'Invest', effects:[{k:'Education', d:3}, {k:'Strength', d:2}, {k:'Money', d:-3}]},  
    {id:'s49_no', label:'Stick to Tradition', effects:[{k:'Money', d:2}, {k:'Strength', d:-1}, {k:'Education', d:-1}]}]},

{id:'s50', decade:13, text:'Philosophers advocate for the abolition of slavery. Will you support the movement, or maintain the practice for economic gain?',  
  choices:[  
    {id:'s50_yes', label:'Support', effects:[{k:'Culture', d:3}, {k:'Population', d:1}, {k:'Control', d:-2}, {k:'Money', d:-2}]},  
    {id:'s50_no', label:'Maintain Practice', effects:[{k:'Money', d:2}, {k:'Control', d:2}, {k:'Culture', d:-2}]}]},

{id:'s51', decade:13, text:'Agricultural innovators propose crop rotation reforms. Will you implement them, or keep traditional methods?',  
  choices:[  
    {id:'s51_yes', label:'Implement', effects:[{k:'Population', d:3}, {k:'Education', d:2}, {k:'Money', d:-2}]},  
    {id:'s51_no', label:'Keep Tradition', effects:[{k:'Money', d:1}, {k:'Population', d:-1}, {k:'Education', d:-1}]}]},

{id:'s52', decade:13, text:'A surge in political pamphlets sparks unrest. Will you censor publications, or permit open debate?',  
  choices:[  
    {id:'s52_yes', label:'Permit Debate', effects:[{k:'Culture', d:2}, {k:'Education', d:1}, {k:'Control', d:-2}]},  
    {id:'s52_no', label:'Censor', effects:[{k:'Control', d:3}, {k:'Culture', d:-1}, {k:'Population', d:-1}]}]},

{id:'s53', decade:14, text:'American colonies demand independence from foreign rule. Will you support their cause for liberty, or side with the established power?',  
  choices:[  
    {id:'s53_yes', label:'Support', effects:[{k:'Culture', d:2}, {k:'Control', d:-3}, {k:'Strength', d:-2}]},  
    {id:'s53_no', label:'Side with Power', effects:[{k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-1}]}]},

{id:'s54', decade:14, text:'Captain James Cook offers to chart unknown oceans. Will you fund his voyages, or allocate resources elsewhere?',  
  choices:[  
    {id:'s54_yes', label:'Fund', effects:[{k:'Education', d:3}, {k:'Culture', d:2}, {k:'Money', d:-3}]},  
    {id:'s54_no', label:'Allocate Elsewhere', effects:[{k:'Money', d:2}, {k:'Education', d:-1}, {k:'Culture', d:-1}]}]},

{id:'s55', decade:14, text:'A political revolution abroad seeks your aid. Will you send troops and supplies, or stay out to avoid entanglement?',  
  choices:[  
    {id:'s55_yes', label:'Send Aid', effects:[{k:'Strength', d:3}, {k:'Money', d:-2}, {k:'Control', d:1}]},  
    {id:'s55_no', label:'Stay Out', effects:[{k:'Money', d:1}, {k:'Control', d:-1}, {k:'Strength', d:-2}]}]},

{id:'s56', decade:14, text:'Debates arise over adopting a formal declaration of human rights. Will you endorse it, or reject it to preserve the monarchyâ€™s authority?',  
  choices:[  
    {id:'s56_yes', label:'Endorse', effects:[{k:'Culture', d:3}, {k:'Education', d:2}, {k:'Control', d:-3}]},  
    {id:'s56_no', label:'Reject', effects:[{k:'Control', d:2}, {k:'Culture', d:-2}]}]},

{id:'s57', decade:15, text:'Napoleon Bonaparte rises to prominence. Will you ally with him for mutual gain, or oppose his ambitions?',  
  choices:[  
    {id:'s57_yes', label:'Ally', effects:[{k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}]},  
    {id:'s57_no', label:'Oppose', effects:[{k:'Strength', d:-2}, {k:'Control', d:-1}, {k:'Money', d:2}]}]},

{id:'s58', decade:15, text:'The metric system is proposed to standardize measures. Will you adopt it, or keep traditional units?',  
  choices:[  
    {id:'s58_yes', label:'Adopt', effects:[{k:'Education', d:2}, {k:'Control', d:2}, {k:'Money', d:1}]},  
    {id:'s58_no', label:'Keep Units', effects:[{k:'Control', d:-1}, {k:'Money', d:0}, {k:'Education', d:-1}]}]},

{id:'s59', decade:15, text:'Steam-powered ships promise faster trade routes. Will you invest, or stick to sail until proven safe?',  
  choices:[  
    {id:'s59_yes', label:'Invest', effects:[{k:'Strength', d:2}, {k:'Culture', d:1}, {k:'Money', d:-3}]},  
    {id:'s59_no', label:'Stick to Sail', effects:[{k:'Money', d:2}, {k:'Strength', d:-1}]}]},

{id:'s60', decade:15, text:'A devastating famine strikes your provinces. Will you open royal granaries to feed the people, or sell reserves to fund the army?',  
  choices:[  
    {id:'s60_yes', label:'Feed People', effects:[{k:'Population', d:3}, {k:'Control', d:1}, {k:'Money', d:-3}]},  
    {id:'s60_no', label:'Sell Reserves', effects:[{k:'Money', d:2}, {k:'Population', d:-2}, {k:'Control', d:-1}]}]}, 

{id:'s61', decade:16, text:'The Industrial Revolution accelerates. Will you fund factories in your cities, or restrict them to protect traditional craftsmen?',  
  choices:[  
    { id:'s61_yes', label:'Fund Factories', effects:[ {k:'Money', d:4}, {k:'Population', d:2}, {k:'Culture', d:-1} ]},  
    { id:'s61_no', label:'Protect Craftsmen', effects:[ {k:'Culture', d:2}, {k:'Money', d:-2}, {k:'Population', d:-1} ]}  
]},  

{id:'s62', decade:16, text:'Charles Babbage proposes his mechanical computing engine. Will you invest in its construction, or deem it impractical?',  
  choices:[  
    { id:'s62_yes', label:'Fund Babbage', effects:[ {k:'Education', d:3}, {k:'Culture', d:1}, {k:'Money', d:-3} ]},  
    { id:'s62_no', label:'Dismiss Idea', effects:[ {k:'Control', d:1}, {k:'Education', d:-1} ]}  
]},  

{id:'s63', decade:16, text:'Railway technology emerges abroad. Will you build a network now, or wait until the costs decline?',  
  choices:[  
    { id:'s63_yes', label:'Build Railways', effects:[ {k:'Control', d:2}, {k:'Money', d:-4}, {k:'Population', d:3} ]},  
    { id:'s63_no', label:'Wait and Delay', effects:[ {k:'Money', d:1}, {k:'Control', d:-1} ]}  
]},  

{id:'s64', decade:16, text:'Romantic poets gain influence among the youth. Will you sponsor their works, or restrict their reach to maintain discipline?',  
  choices:[  
    { id:'s64_yes', label:'Sponsor Poets', effects:[ {k:'Culture', d:3}, {k:'Control', d:-1} ]},  
    { id:'s64_no', label:'Restrict Poetry', effects:[ {k:'Control', d:2}, {k:'Culture', d:-1} ]}  
]},  

{id:'s65', decade:17, text:'Telegraph networks are being built in neighboring realms. Will you invest in connecting your kingdom, or rely on existing couriers?',  
  choices:[  
    { id:'s65_yes', label:'Build Telegraph', effects:[ {k:'Education', d:2}, {k:'Control', d:3}, {k:'Money', d:-3} ]},  
    { id:'s65_no', label:'Keep Couriers', effects:[ {k:'Money', d:1}, {k:'Control', d:-1} ]}  
]},  

{id:'s66', decade:17, text:'Charles Darwin begins work on his theories of evolution. Will you support his studies, or suppress them as heretical?',  
  choices:[  
    { id:'s66_yes', label:'Support Darwin', effects:[ {k:'Education', d:3}, {k:'Culture', d:2}, {k:'Religion', d:-2} ]},  
    { id:'s66_no', label:'Suppress Studies', effects:[ {k:'Religion', d:2}, {k:'Control', d:1}, {k:'Education', d:-1} ]}  
]},  

{id:'s67', decade:17, text:'Mass protests erupt demanding voting reforms. Will you grant concessions, or deploy the army to restore order?',  
  choices:[  
    { id:'s67_yes', label:'Grant Reforms', effects:[ {k:'Control', d:-2}, {k:'Population', d:2}, {k:'Culture', d:1} ]},  
    { id:'s67_no', label:'Deploy Army', effects:[ {k:'Strength', d:2}, {k:'Control', d:2}, {k:'Population', d:-1} ]}  
]},  

{id:'s68', decade:17, text:'A deadly cholera outbreak spreads rapidly. Will you fund sanitation projects, or leave it to local authorities?',  
  choices:[  
    { id:'s68_yes', label:'Fund Sanitation', effects:[ {k:'Population', d:3}, {k:'Money', d:-3}, {k:'Education', d:1} ]},  
    { id:'s68_no', label:'Leave to Locals', effects:[ {k:'Money', d:1}, {k:'Population', d:-2} ]}  
]},  

{id:'s69', decade:18, text:'Alexander Graham Bell seeks support to develop the telephone. Will you finance his invention, or dismiss it as fanciful?',  
  choices:[  
    { id:'s69_yes', label:'Fund Telephone', effects:[ {k:'Education', d:3}, {k:'Control', d:2}, {k:'Money', d:-3} ]},  
    { id:'s69_no', label:'Dismiss Invention', effects:[ {k:'Money', d:1}, {k:'Culture', d:-1} ]}  
]},  

{id:'s70', decade:18, text:'Workers organize to demand shorter hours. Will you legislate reforms, or side with industrialists to preserve profits?',  
  choices:[  
    { id:'s70_yes', label:'Support Workers', effects:[ {k:'Population', d:2}, {k:'Control', d:-1}, {k:'Money', d:-2} ]},  
    { id:'s70_no', label:'Support Industrialists', effects:[ {k:'Money', d:2}, {k:'Control', d:1}, {k:'Population', d:-1} ]}  
]},  

{id:'s71', decade:18, text:'A railway tycoon offers to link your ports with inland mines. Will you back the project, or let private investors handle it?',  
  choices:[  
    { id:'s71_yes', label:'Back Project', effects:[ {k:'Money', d:3}, {k:'Control', d:2}, {k:'Population', d:1} ]},  
    { id:'s71_no', label:'Leave to Investors', effects:[ {k:'Money', d:1}, {k:'Control', d:-1} ]}  
]},  

{id:'s72', decade:18, text:'Photography becomes a popular medium. Will you fund a royal archive of images, or consider it a passing novelty?',  
  choices:[  
    { id:'s72_yes', label:'Fund Archive', effects:[ {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Money', d:-1} ]},  
    { id:'s72_no', label:'Ignore Photography', effects:[ {k:'Culture', d:-1}, {k:'Money', d:1} ]}  
]},  

{id:'s73', decade:19, text:'Thomas Edison offers to light your capital with electric lamps. Will you invest in the project, or stick to gas lighting?',  
  choices:[  
    { id:'s73_yes', label:'Adopt Electric Lamps', effects:[ {k:'Education', d:2}, {k:'Control', d:2}, {k:'Money', d:-3} ]},  
    { id:'s73_no', label:'Stay with Gas', effects:[ {k:'Money', d:1}, {k:'Control', d:-1} ]}  
]},  

{id:'s74', decade:19, text:'The telephone spreads rapidly abroad. Will you nationalize the network, or leave it in private hands?',  
  choices:[  
    { id:'s74_yes', label:'Nationalize Network', effects:[ {k:'Control', d:3}, {k:'Money', d:2}, {k:'Culture', d:1} ]},  
    { id:'s74_no', label:'Leave Private', effects:[ {k:'Money', d:2}, {k:'Control', d:-1} ]}  
]},  

{id:'s75', decade:19, text:'An influenza epidemic sweeps through the realm. Will you close public gatherings, or let daily life continue unchanged?',  
  choices:[  
    { id:'s75_yes', label:'Close Gatherings', effects:[ {k:'Population', d:-1}, {k:'Control', d:1} ]},  
    { id:'s75_no', label:'Keep Open', effects:[ {k:'Population', d:-2}, {k:'Culture', d:1} ]}  
]},  

{id:'s76', decade:19, text:'Foreign explorers request funding to reach the poles. Will you support them, or focus on domestic projects?',  
  choices:[  
    { id:'s76_yes', label:'Fund Exploration', effects:[ {k:'Culture', d:2}, {k:'Education', d:2}, {k:'Money', d:-2} ]},  
    { id:'s76_no', label:'Prioritize Domestic', effects:[ {k:'Money', d:1}, {k:'Control', d:1} ]}  
]}, 

{id:'s77', decade:20, text:'The Wright brothers request backing for their flying machine. Will you invest, or wait until the technology matures?', 
 choices:[
   {id:'s77_yes', label:'Fund Them', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'s77_no', label:'Decline', effects:[{k:'Control',d:1},{k:'Education',d:-1}]}
 ]},

{id:'s78', decade:20, text:'A suffrage movement demands voting rights for women. Will you enact the reform, or resist to maintain tradition?', 
 choices:[
   {id:'s78_yes', label:'Grant Rights', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Control',d:-1}]},
   {id:'s78_no', label:'Resist', effects:[{k:'Control',d:2},{k:'Culture',d:-1}]}
 ]},

{id:'s79', decade:20, text:'A massive earthquake devastates a coastal city. Will you send royal engineers for reconstruction, or leave it to local councils?', 
 choices:[
   {id:'s79_yes', label:'Send Help', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'s79_no', label:'Leave It Local', effects:[{k:'Money',d:2},{k:'Control',d:-1}]}
 ]},

{id:'s80', decade:20, text:'Marconiâ€™s wireless telegraph promises global communication. Will you adopt it, or rely on existing telegraph lines?', 
 choices:[
   {id:'s80_yes', label:'Adopt Wireless', effects:[{k:'Education',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'s80_no', label:'Stick to Telegraph', effects:[{k:'Control',d:-1},{k:'Money',d:1}]}
 ]},

{id:'s81', decade:21, text:'Albert Einstein offers to join your court as scientific advisor. Will you accept, or decline to avoid controversy?', 
 choices:[
   {id:'s81_yes', label:'Accept Him', effects:[{k:'Education',d:3},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'s81_no', label:'Decline', effects:[{k:'Control',d:1},{k:'Education',d:-1}]}
 ]},

{id:'s82', decade:21, text:'War breaks out among major powers. Will you mobilize your forces, or stay neutral to preserve stability?', 
 choices:[
   {id:'s82_yes', label:'Mobilize', effects:[{k:'Strength',d:3},{k:'Control',d:1},{k:'Money',d:-3},{k:'Population',d:-2}]},
   {id:'s82_no', label:'Stay Neutral', effects:[{k:'Control',d:2},{k:'Strength',d:-2}]}
 ]},

{id:'s83', decade:21, text:'A deadly influenza pandemic spreads. Will you impose quarantines and fund hospitals, or focus on economic recovery?', 
 choices:[
   {id:'s83_yes', label:'Fund Hospitals', effects:[{k:'Population',d:2},{k:'Money',d:-2},{k:'Control',d:1}]},
   {id:'s83_no', label:'Focus Economy', effects:[{k:'Money',d:2},{k:'Population',d:-2}]}
 ]},

{id:'s84', decade:21, text:'A major industrial strike paralyzes key industries. Will you negotiate with workers, or deploy troops to break the strike?', 
 choices:[
   {id:'s84_yes', label:'Negotiate', effects:[{k:'Control',d:-1},{k:'Population',d:2}]},
   {id:'s84_no', label:'Deploy Troops', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Culture',d:-1}]}
 ]},

{id:'s85', decade:22, text:'Global economic depression cripples trade. Will you launch public works programs, or cut spending to balance the treasury?', 
 choices:[
   {id:'s85_yes', label:'Launch Programs', effects:[{k:'Population',d:2},{k:'Control',d:1},{k:'Money',d:-3}]},
   {id:'s85_no', label:'Cut Spending', effects:[{k:'Money',d:2},{k:'Population',d:-1}]}
 ]},

{id:'s86', decade:22, text:'A charismatic foreign leader offers an alliance. Will you accept, or remain cautious?', 
 choices:[
   {id:'s86_yes', label:'Accept Alliance', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'s86_no', label:'Remain Cautious', effects:[{k:'Control',d:1},{k:'Strength',d:-1}]}
 ]},

{id:'s87', decade:22, text:'Radar technology promises an edge in warfare. Will you invest in its development, or ignore it until proven effective?', 
 choices:[
   {id:'s87_yes', label:'Invest', effects:[{k:'Education',d:2},{k:'Strength',d:2},{k:'Money',d:-3}]},
   {id:'s87_no', label:'Ignore', effects:[{k:'Strength',d:-1},{k:'Money',d:1}]}
 ]},

{id:'s88', decade:22, text:'Wartime propaganda boosts morale. Will you fund it, or focus resources on the front lines?', 
 choices:[
   {id:'s88_yes', label:'Fund Propaganda', effects:[{k:'Culture',d:2},{k:'Control',d:1},{k:'Money',d:-1}]},
   {id:'s88_no', label:'Focus Front Lines', effects:[{k:'Strength',d:2},{k:'Culture',d:-1}]}
 ]},

{id:'s89', decade:23, text:'Space exploration becomes a new frontier. Will you launch a national program, or focus on earthly concerns?', 
 choices:[
   {id:'s89_yes', label:'Launch Program', effects:[{k:'Education',d:3},{k:'Culture',d:2},{k:'Money',d:-4}]},
   {id:'s89_no', label:'Focus Earthly Matters', effects:[{k:'Money',d:2},{k:'Control',d:1}]}
 ]},

{id:'s90', decade:23, text:'A revolution erupts in a neighboring land. Will you intervene to protect your interests, or let events unfold?', 
 choices:[
   {id:'s90_yes', label:'Intervene', effects:[{k:'Strength',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'s90_no', label:'Stay Out', effects:[{k:'Control',d:-1},{k:'Money',d:1}]}
 ]},

{id:'s91', decade:23, text:'Civil rights activists demand equal treatment for all citizens. Will you enact reforms, or resist change?', 
 choices:[
   {id:'s91_yes', label:'Enact Reforms', effects:[{k:'Culture',d:3},{k:'Population',d:1},{k:'Control',d:-2}]},
   {id:'s91_no', label:'Resist', effects:[{k:'Control',d:2},{k:'Culture',d:-1}]}
 ]},

{id:'s92', decade:23, text:'Television becomes a powerful medium. Will you fund a royal broadcasting service, or leave it to private enterprises?', 
 choices:[
   {id:'s92_yes', label:'Fund Broadcasting', effects:[{k:'Culture',d:2},{k:'Control',d:1},{k:'Money',d:-2}]},
   {id:'s92_no', label:'Leave to Private', effects:[{k:'Money',d:2},{k:'Culture',d:-1}]}
 ]},

{id:'s93', decade:24, text:'Computers emerge as vital tools for governance. Will you modernize your administration, or keep traditional records?', 
 choices:[
   {id:'s93_yes', label:'Modernize', effects:[{k:'Education',d:3},{k:'Control',d:2},{k:'Money',d:-3}]},
   {id:'s93_no', label:'Stay Traditional', effects:[{k:'Control',d:1},{k:'Education',d:-1}]}
 ]},

{id:'s94', decade:24, text:'The oil crisis threatens your economy. Will you invest in alternative energy, or double down on existing imports?', 
 choices:[
   {id:'s94_yes', label:'Invest Alternatives', effects:[{k:'Education',d:2},{k:'Control',d:1},{k:'Money',d:-3}]},
   {id:'s94_no', label:'Stick to Imports', effects:[{k:'Money',d:2},{k:'Control',d:-1}]}
 ]},

{id:'s95', decade:24, text:'Medical scientists propose mass vaccination programs. Will you approve funding, or limit it to the most vulnerable?', 
 choices:[
   {id:'s95_yes', label:'Fund Programs', effects:[{k:'Population',d:3},{k:'Education',d:1},{k:'Money',d:-2}]},
   {id:'s95_no', label:'Limit Effort', effects:[{k:'Money',d:1},{k:'Population',d:-1}]}
 ]},

{id:'s96', decade:24, text:'Personal computers enter the market. Will you promote digital literacy, or let the trend grow without interference?', 
 choices:[
   {id:'s96_yes', label:'Promote Literacy', effects:[{k:'Education',d:2},{k:'Culture',d:1},{k:'Money',d:-1}]},
   {id:'s96_no', label:'Hands Off', effects:[{k:'Money',d:1},{k:'Education',d:-1}]}
 ]},

{id:'s97', decade:25, text:'The internet connects the world. Will you invest in nationwide access, or restrict it to key institutions?', 
 choices:[
   {id:'s97_yes', label:'Invest Nationwide', effects:[{k:'Education',d:3},{k:'Culture',d:2},{k:'Money',d:-3}]},
   {id:'s97_no', label:'Restrict Access', effects:[{k:'Control',d:2},{k:'Education',d:-1}]}
 ]},

{id:'s98', decade:25, text:'Climate change activists call for strict environmental laws. Will you pass sweeping reforms, or prioritize industry?', 
 choices:[
   {id:'s98_yes', label:'Pass Reforms', effects:[{k:'Culture',d:2},{k:'Population',d:1},{k:'Money',d:-2}]},
   {id:'s98_no', label:'Prioritize Industry', effects:[{k:'Money',d:2},{k:'Culture',d:-1}]}
 ]},

{id:'s99', decade:25, text:'A financial crisis rocks global markets. Will you bail out key industries, or let them fail?', 
 choices:[
   {id:'s99_yes', label:'Bail Out', effects:[{k:'Control',d:1},{k:'Money',d:-3}]},
   {id:'s99_no', label:'Let Fail', effects:[{k:'Money',d:2},{k:'Population',d:-1}]}
 ]},

{id:'s100', decade:25, text:'Mobile phones dominate communication. Will you create a royal telecom network, or leave it to private firms?', 
 choices:[
   {id:'s100_yes', label:'Royal Network', effects:[{k:'Control',d:2},{k:'Culture',d:1},{k:'Money',d:-2}]},
   {id:'s100_no', label:'Private Firms', effects:[{k:'Money',d:2},{k:'Control',d:-1}]}
 ]},

// -------------------- 2012â€“2032 (fictional future) --------------------
{
  id:'s101', decade:26, 
  text:'Artificial intelligence promises to revolutionize governance. Will you adopt it to run parts of your administration, or keep humans in charge?',
  buttons:[
    {text:'Adopt AI governance', effects:[{k:'Education',d:3},{k:'Control',d:3},{k:'Money',d:-2}]},
    {text:'Keep humans in charge', effects:[{k:'Control',d:-1},{k:'Culture',d:1}]}
  ]
},
{
  id:'s102', decade:26,
  text:'Gene editing can eliminate hereditary diseases. Will you authorize widespread use, or limit it due to ethical concerns?',
  buttons:[
    {text:'Authorize widespread use', effects:[{k:'Population',d:3},{k:'Education',d:2},{k:'Religion',d:-1}]},
    {text:'Limit for ethical reasons', effects:[{k:'Religion',d:2},{k:'Control',d:1},{k:'Education',d:-1}]}
  ]
},
{
  id:'s103', decade:26,
  text:'Global water shortages loom. Will you invest in desalination plants, or focus on conservation campaigns?',
  buttons:[
    {text:'Invest in desalination', effects:[{k:'Population',d:2},{k:'Money',d:-3},{k:'Control',d:1}]},
    {text:'Focus on conservation', effects:[{k:'Culture',d:1},{k:'Control',d:2},{k:'Population',d:-1}]}
  ]
},
{
  id:'s104', decade:26,
  text:'Private companies plan colonization of Mars. Will you join the venture, or prioritize earthly needs?',
  buttons:[
    {text:'Join the Mars venture', effects:[{k:'Culture',d:2},{k:'Education',d:3},{k:'Money',d:-4}]},
    {text:'Focus on Earth', effects:[{k:'Control',d:2},{k:'Population',d:1}]}
  ]
},

// -------------------- 2032â€“2052 (fictional future) --------------------
{
  id:'s105', decade:27,
  text:'Quantum computing breaks all encryption. Will you invest in secure systems, or accept the risks of open data?',
  buttons:[
    {text:'Invest in security', effects:[{k:'Control',d:2},{k:'Education',d:2},{k:'Money',d:-3}]},
    {text:'Accept the risks', effects:[{k:'Culture',d:1},{k:'Money',d:1},{k:'Control',d:-2}]}
  ]
},
{
  id:'s106', decade:27,
  text:'Synthetic food production can feed the entire population. Will you fund it, or protect traditional farming?',
  buttons:[
    {text:'Fund synthetic food', effects:[{k:'Population',d:3},{k:'Money',d:-2},{k:'Culture',d:-1}]},
    {text:'Protect traditional farming', effects:[{k:'Culture',d:2},{k:'Population',d:-1},{k:'Control',d:1}]}
  ]
},
{
  id:'s107', decade:27,
  text:'Rising sea levels threaten coastal cities. Will you construct massive barriers, or relocate citizens inland?',
  buttons:[
    {text:'Construct barriers', effects:[{k:'Control',d:2},{k:'Population',d:2},{k:'Money',d:-4}]},
    {text:'Relocate citizens', effects:[{k:'Population',d:1},{k:'Money',d:-2},{k:'Culture',d:-1}]}
  ]
},
{
  id:'s108', decade:27,
  text:'Neural interface technology allows direct brain-computer links. Will you regulate it, or embrace its potential?',
  buttons:[
    {text:'Regulate strictly', effects:[{k:'Control',d:2},{k:'Culture',d:-1}]},
    {text:'Embrace potential', effects:[{k:'Education',d:3},{k:'Culture',d:2},{k:'Money',d:-3}]}
  ]
},

// -------------------- 2052â€“2072 (fictional future) --------------------
{
  id:'s109', decade:28,
  text:'Fusion power becomes commercially viable. Will you invest heavily to lead the energy market, or let others take the risk?',
  buttons:[
    {text:'Invest heavily', effects:[{k:'Education',d:3},{k:'Money',d:4},{k:'Control',d:2}]},
    {text:'Let others take risk', effects:[{k:'Money',d:1},{k:'Strength',d:-1}]}
  ]
},
{
  id:'s110', decade:28,
  text:'Global AI governance councils form. Will you join to shape policy, or keep your sovereignty untouched?',
  buttons:[
    {text:'Join councils', effects:[{k:'Control',d:2},{k:'Culture',d:1},{k:'Strength',d:1}]},
    {text:'Keep sovereignty', effects:[{k:'Control',d:1},{k:'Culture',d:-1}]}
  ]
},
{
  id:'s111', decade:28,
  text:'Bio-engineered soldiers are proposed for defense. Will you approve their deployment, or reject the idea on moral grounds?',
  buttons:[
    {text:'Approve soldiers', effects:[{k:'Strength',d:4},{k:'Control',d:2},{k:'Religion',d:-1}]},
    {text:'Reject on moral grounds', effects:[{k:'Religion',d:2},{k:'Culture',d:1}]}
  ]
},
{
  id:'s112', decade:28,
  text:'Undersea cities become possible through advanced engineering. Will you fund their construction, or focus on land development?',
  buttons:[
    {text:'Fund undersea cities', effects:[{k:'Population',d:3},{k:'Culture',d:2},{k:'Money',d:-5}]},
    {text:'Focus on land', effects:[{k:'Control',d:1},{k:'Money',d:2}]}
  ]
},

// -------------------- 2072â€“2092 (fictional future) --------------------
{
  id:'s113', decade:29,
  text:'Climate restoration technology can reverse centuries of damage. Will you deploy it now, or wait for further testing?',
  buttons:[
    {text:'Deploy now', effects:[{k:'Population',d:2},{k:'Culture',d:2},{k:'Money',d:-3}]},
    {text:'Wait for testing', effects:[{k:'Control',d:1},{k:'Education',d:1},{k:'Population',d:-1}]}
  ]
},
{
  id:'s114', decade:29,
  text:'First contact with alien life is established. Will you pursue peaceful cooperation, or prepare for defense?',
  buttons:[
    {text:'Pursue peace', effects:[{k:'Culture',d:3},{k:'Education',d:2}]},
    {text:'Prepare for defense', effects:[{k:'Strength',d:2},{k:'Control',d:2},{k:'Money',d:-2}]}
  ]
},
{
  id:'s115', decade:29,
  text:'Artificial superintelligence offers to advise your rule. Will you accept its counsel, or maintain human decision-making?',
  buttons:[
    {text:'Accept counsel', effects:[{k:'Control',d:3},{k:'Education',d:3},{k:'Money',d:-1}]},
    {text:'Keep humans in charge', effects:[{k:'Culture',d:1},{k:'Control',d:-1}]}
  ]
},
{
  id:'s116', decade:29,
  text:'Mass migration from uninhabitable regions strains resources. Will you welcome the refugees, or close your borders?',
  buttons:[
    {text:'Welcome refugees', effects:[{k:'Population',d:3},{k:'Culture',d:1},{k:'Control',d:-2}]},
    {text:'Close borders', effects:[{k:'Control',d:2},{k:'Culture',d:-1}]}
  ]
},

<!--
// -------------------- 2092â€“2112 (fictional future) --------------------
{id:'s117', decade:30, text:'A rogue asteroid is detected on a collision course. Will you fund a planetary defense system, or trust in fate?', effects:[
  {k:'Strength', d:4}, {k:'Control', d:2}, {k:'Money', d:-5}
]},
{id:'s118', decade:30, text:'Mind uploading becomes a reality. Will you offer immortality to your citizens, or restrict it to a select few?', effects:[
  {k:'Culture', d:2}, {k:'Population', d:2}, {k:'Education', d:2}
]},
{id:'s119', decade:30, text:'Global governance proposes uniting all armies under one banner. Will you join, or maintain your independent forces?', effects:[
  {k:'Strength', d:-2}, {k:'Control', d:-2}, {k:'Culture', d:1}
]},
{id:'s120', decade:30, text:'Terraforming technology allows habitable worlds beyond Earth. Will you lead colonization efforts, or preserve your focus on the homeworld?', effects:[
  {k:'Culture', d:3}, {k:'Population', d:3}, {k:'Money', d:-4}
]}
-->
];



// === V9.7.5: NPC Scenarios ===
// These are special decade-first-decision events tied to notable NPCs.
// For now, we start with "The Queen" arc.
const NPC_SCENARIOS = [
  { id: 'q01', npc: 'The Queen', text: 'The Queen proposes establishing a royal orphanage to shelter children of fallen soldiers. Shall we fund it?', effects:[
    {k:'Population', d:3}, {k:'Education', d:2}, {k:'Culture', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q02', npc: 'The Queen', text: 'The Queen wishes to sponsor a womenâ€™s weaving guild to strengthen the textile trade. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q03', npc: 'The Queen', text: 'The Queen suggests hosting a diplomatic banquet for neighboring rulers. Shall we allocate funds?', effects:[
    {k:'Culture', d:2}, {k:'Control', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q04', npc: 'The Queen', text: 'The Queen urges improved palace security after a recent scare. Approve her plan?', effects:[
    {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q05', npc: 'The Queen', text: 'The Queen proposes a charity fair to raise funds for the poor. Shall we support it?', effects:[
    {k:'Population', d:2}, {k:'Culture', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q06', npc: 'The Queen', text: 'The Queen wants to commission a portrait gallery honoring past monarchs. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q07', npc: 'The Queen', text: 'The Queen recommends sending relief ships to famine-struck isles. Approve?', effects:[
    {k:'Population', d:3}, {k:'Religion', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q08', npc: 'The Queen', text: 'The Queen proposes a new code of court etiquette. Approve?', effects:[
    {k:'Control', d:2}, {k:'Culture', d:1}, {k:'Education', d:1}
  ]},
  { id: 'q09', npc: 'The Queen', text: 'The Queen urges funding for a music academy in the capital. Approve?', effects:[
    {k:'Culture', d:3}, {k:'Education', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q10', npc: 'The Queen', text: 'The Queen seeks to improve palace gardens to host foreign dignitaries. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Population', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q11', npc: 'The Queen', text: 'The Queen proposes sending envoys to settle a border dispute peacefully. Approve?', effects:[
    {k:'Control', d:2}, {k:'Culture', d:1}, {k:'Strength', d:1}
  ]},
  { id: 'q12', npc: 'The Queen', text: 'The Queen wishes to open a royal school for gifted children. Approve?', effects:[
    {k:'Education', d:3}, {k:'Population', d:1}, {k:'Culture', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q13', npc: 'The Queen', text: 'The Queen asks for funds to restore a historic cathedral. Approve?', effects:[
    {k:'Religion', d:3}, {k:'Culture', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q14', npc: 'The Queen', text: 'The Queen recommends sending herbalists to rural villages to improve health. Approve?', effects:[
    {k:'Population', d:2}, {k:'Religion', d:1}, {k:'Education', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q15', npc: 'The Queen', text: 'The Queen suggests creating a scholarship for talented village children. Approve?', effects:[
    {k:'Education', d:2}, {k:'Population', d:1}, {k:'Culture', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q16', npc: 'The Queen', text: 'The Queen wishes to commission a royal chronicle of your reign. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Education', d:1}, {k:'Control', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q17', npc: 'The Queen', text: 'The Queen urges expanding the city watch to keep peace. Approve?', effects:[
    {k:'Strength', d:3}, {k:'Control', d:2}, {k:'Population', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q18', npc: 'The Queen', text: 'The Queen wants to create a guild for healers to standardize medicine. Approve?', effects:[
    {k:'Education', d:2}, {k:'Population', d:1}, {k:'Religion', d:1}, {k:'Money', d:-3}
  ]},
  { id: 'q19', npc: 'The Queen', text: 'The Queen proposes sending aid to an ally recovering from war. Approve?', effects:[
    {k:'Strength', d:1}, {k:'Control', d:2}, {k:'Money', d:-3}
  ]},
  { id: 'q20', npc: 'The Queen', text: 'The Queen asks for funds to sponsor a grand midwinter feast for the people. Approve?', effects:[
    {k:'Culture', d:2}, {k:'Population', d:1}, {k:'Money', d:-2}
  ]},

  // Queen Immortality Arc

  { id: 'q21', npc: 'The Queen', text: "As the first decade of your reign draws to a close, the Queen gazes at her reflection, her features softened by age. 'My love,' she says, 'you will stand unchanging for centuries... but I will fade. I beg you â€” let us seek the Alchemist of Eternity, even if it takes decades.'", effects:[
    {k:'Culture', d:1}, {k:'Population', d:1}, {k:'Money', d:-2}
  ]},
  { id: 'q22', npc: 'The Queen', text: "Ten years have passed since the Queen began her search. Now, in the second decade, she returns with a fragment of hope â€” a dusty scroll pointing to the Alchemistâ€™s last known dwelling. But journeys into forgotten lands will drain the kingdomâ€™s wealth and test its peopleâ€™s loyalty.", effects:[
    {k:'Money', d:-3}, {k:'Strength', d:1}, {k:'Culture', d:1}
  ]},
  { id: 'q23', npc: 'The Queen', text: "Two decades of labor bear fruit. The Alchemist stands in the grand hall, promising the Queenâ€™s immortality. Yet, as the third decade wanes, rumors spread through the realm â€” strange eclipses, sickness among livestock, and whispers that the crown meddles with forbidden forces.", effects:[
    {k:'Religion', d:-2}, {k:'Culture', d:1}, {k:'Population', d:-1}
  ]},
  { id: 'q24', npc: 'The Queen', text: "The fourth decade finds the Queen changed â€” her hair streaked with silver, her gaze fixed on the Alchemistâ€™s work. 'One last ingredient remains,' he tells you, 'a portion of your eternal essence.' The Queenâ€™s voice trembles, but her eyes are steady. 'Will you give it to me?'", effects:[
    {k:'Religion', d:-1}, {k:'Strength', d:-1}, {k:'Money', d:-2}
  ]},
  { id: 'q25', npc: 'The Queen', text: "Half a century has passed since the Queen first spoke of her fear. Tonight, the fifth decade ends, and the ritual stands ready. The hall is lined with candles; the air hums with power. If you proceed, she may reign with you forever â€” or vanish into the shadows of history.", effects:[
    {k:'Culture', d:1}, {k:'Religion', d:-2}, {k:'Population', d:-1}
  ]}, 
  
  // Refusal of Counsels
  
  {
  id: 'q26',
  npc: 'The Queen',
  text: "'You have refused my counsel more than once,'<br><br>the Queen whispers, standing beneath the dim glow of dusk in the private gallery where they once danced without music. The air between them is heavy with years unspoken, and the palace walls seem to echo her ache.<br><br>'I do not come to argue, only to remember. Just one hour â€” let me know if your heart still reaches for mine beneath the weight of the crown. Or must I learn to love you from afar, as one loves a fading star?'", effects: [
    {k:'Money', d:-1}, {k:'Population', d:1}, {k:'Culture', d:2}, {k:'Control', d:-1}
  ],
  resultText: {
  accept: "The chamber falls silent but for your voices. What began as counsel drifts into laughter, and laughter into something softer â€” a warmth that neither crown nor duty could command. The Queenâ€™s eyes shine, not with triumph, but with the quiet relief of love remembered and returned. For a moment, the palace feels like home again.",
  decline: "Her smile falters, just enough to betray the hope she carried in. She bows with perfect grace, but the gesture feels colder now â€” rehearsed. As she turns, the echo of her footsteps lingers, stretching through the gallery like a memory that refuses to fade. The dusk deepens, and the distance between you grows."
  }},

  {
  id: 'q27',
  npc: 'The Queen',
  text: "Seasons pass after the galleryâ€™s silence. The Queen returns, her composure unshaken but her gaze unguarded. 'We have shared warmth, and yetâ€¦ no heir comes,' she admits, voice low as though the stones themselves might gossip. 'The kingdom needs more than memory. There are healers, scholars, even alchemists who claim hope where nature has denied us. Some paths are sacred, others perilous. Stillâ€”will you walk them with me?'",
  effects: [
    {k:'Population', d:2}, {k:'Control', d:2}, {k:'Money', d:-3}, {k:'Culture', d:1}, {k:'Religion', d:-2}, {k:'Education', d:2}
  ],
  resultText: {
    accept: "The palace opens its doors to strangers cloaked in incense and strange symbols. Nights are filled with whispers of remedies and rites. Though doubt lingers, the Queen moves with quiet determination, and hope flickers once more in the shadow of the throne.",
    decline: "The scrolls curl into ash, their promises lost to smoke. The Queen lowers her gaze, a brittle smile masking the ache beneath. 'Then the realm itself shall be our child,' she murmurs, her words heavy with resignation. Yet the silence between you feels heavier still."
  }},

  {
  id: 'q28',
  npc: 'The Queen',
  text: "The Queen stands before you, cradling a newborn â€” a quiet miracle, a promise wrapped in soft breath and fragile warmth. This is no longer just the realmâ€™s future, but yours. In the childâ€™s eyes, you see everything unspoken: the sacrifices, the longing, the hope that this moment might mend what history could not.<br><br>She offers the child to you, hands trembling slightly.<br><br>â€œWill you claim our heir,â€ she asks, â€œnot by duty, but by love?â€<br><br>The chamber holds its breath. The crown feels lighter. The choice before you is no longer about power â€” itâ€™s about devotion, and the legacy only you can give.",
  effects: [
    { k: 'Population', d: 3 },
    { k: 'Money', d: -3 },
    { k: 'Control', d: 1 }
  ],
  resultText: {
    accept: "You take the child in your arms, the weight both delicate and immeasurable. The court erupts in celebration, and across the land, bells ring for the birth of the heir. For once, duty and love are indistinguishable â€” the realmâ€™s future secured by your embrace.",
    decline: "You step back, the air colder for your distance. The Queen gathers the child close, lips pressed to a trembling brow. Whispers bloom in the court like weeds: of a ruler without love, of an heir unclaimed. The realm has its future, but the bond between crown and heart may never heal."
  }
},
  
  {
  id: 'q29',
  npc: 'The Queen',
  text: "Nights grow longer, halls grow quieter. The Queen no longer walks the gardens, nor attends the court. Her laughter â€” once a rare, bright thing â€” has withered into silence.<br><br>\
She stands before you only once more, eyes hollow with grief too heavy for crowns or counsel.<br><br>\
'Once, I called this gift a blessing,' she whispers, touching the faint silver mark that lingers on her wrist â€” the seal of her immortality. 'But love spurned, devotion refusedâ€¦ has turned it into a curse I can no longer bear.'<br><br>\
Her hands tremble as she raises them, weaving the ancient signs. The air shudders with power, not of life preserved, but of life released.",

  // No essence effects â€” it's a pure story event
  effects: [],

  // Only one button
  singleChoice: {
  label: "...",
  onChoose: () => {
  // Popup (keep your existing message)
  queenArcPopup(
    "The Queen closes her eyes and whispers an ancient word â€” not of power, but of surrender. The halls will echo with no laughter, no promise of heirs, no immortal vows.<br><br>\
    Love has outlived its vessel, and even grief has grown too heavy to bear.<br><br>\
    When she opens her eyes, there is no magic in them â€” only the quiet acceptance of an ending.<br><br>\
    The Immortal Queen is gone.",
    { cssClass: 'queen-finale-popup' }
  );

  // Terminate the Queen arc permanently (use the global flag)
  state.queenArcStep = 999;
  state.queenArcActive = false;
  state.lockNormalQueen = true; // prevent normal Queen events
  window.suppressQueen = true;   // global suppression used by preparePool()

  // Immediately remove any queued Queen scenes from the existing pool
  if (Array.isArray(state.scenePool)) {
    state.scenePool = state.scenePool.filter(s => !(s && typeof s.id === 'string' && /^q\d+/i.test(s.id)));
  }

  // Optional: advance the scene to the next one (mirrors ellipses behaviour)
  // makeDecision(false);  // uncomment if you want this to behave like the global ellipses button
}
} 
}, 

{
  id: 'q30',
  npc: 'The Queen',
  text: "The nursery is quiet now. No laughter, no footsteps â€” only the hush of folded blankets and unopened books. The Queen stands by the window, her crown set aside, her voice barely above a whisper. 'They were never meant to last,' she says. 'Our blood defies time, but their bodies could not hold it.' Her eyes do not meet yours. 'I asked the scholars if love could be undone. They said no. So I ask you instead â€” what shall we do with the grief that outlives the child?'",

  // âœ… Effects applied when ellipses clicked
  effects: [
    { k: 'Population', d: -2 },
    { k: 'Money', d: -2 },
    { k: 'Culture', d: -2 },
    { k: 'Religion', d: -2 },
    { k: 'Control', d: -2 },
    { k: 'Education', d: -2 }
  ],

  singleChoice: {
    label: "...",
    onChoose: () => {
  // Popup (keep your existing message)
  queenArcPopup(
    "The Queen closes her eyes and whispers an ancient word â€” not of power, but of surrender. The halls will echo with no laughter, no promise of heirs, no immortal vows.<br><br>\
    Love has outlived its vessel, and even grief has grown too heavy to bear.<br><br>\
    When she opens her eyes, there is no magic in them â€” only the quiet acceptance of an ending.<br><br>\
    The Immortal Queen is gone.",
    { cssClass: 'queen-finale-popup' }
  );

  // Terminate the Queen arc permanently (use the global flag)
  state.queenArcStep = 999;
  state.queenArcActive = false;
  state.lockNormalQueen = true; // prevent normal Queen events
  window.suppressQueen = true;   // global suppression used by preparePool()

  // Immediately remove any queued Queen scenes from the existing pool
  if (Array.isArray(state.scenePool)) {
    state.scenePool = state.scenePool.filter(s => !(s && typeof s.id === 'string' && /^q\d+/i.test(s.id)));
  }

  // Optional: advance the scene to the next one (mirrors ellipses behaviour)
  // makeDecision(false);  // uncomment if you want this to behave like the global ellipses button
}
  }
}

]; 


const BIZZARE = [
  { id: 'fund_bizarre', npc: 'The Alchemist', text: "A wild-eyed man bursts into your court clutching a jar of glowing liquid. 'With this, I can turn lead to gold!' he claims, though the air reeks of swamp gas. Genius or madman, he asks for royal funding to finish his work.", effects:[
    {k:'Money', d:-3}, {k:'Culture', d:2}, {k:'Education', d:1}
  ]},
  { id: 'plead_help', npc: 'The Envoy', text: "A rider from Wynthor kneels before you, voice raw with desperation. 'Our fields are barren, our children starving. We beg for grain and mercy.' Aid would save lives, but your own stores are running thin.", effects:[
    {k:'Population', d:-2}, {k:'Money', d:1}, {k:'Control', d:-1}
  ]},
  { id: 'urgent_marriage', npc: 'Lord Atherwyn', text: "A noble lord stands before your throne. 'Your Majesty, marry my daughter and unite our houses. Refusal will not be forgotten.' The court holds its breath as his gaze sharpens.", effects:[
    {k:'Control', d:2}, {k:'Money', d:-2}, {k:'Culture', d:1}
  ]},
  { id: 'royal_masquerade', npc: 'The Queen', text: "The Queen sweeps in, eyes alight. 'Let us host a masquerade for the visiting dignitaries â€” wine flowing, masks glittering, feasts unending.' The steward mutters about the treasuryâ€™s meager purse.", effects:[
    {k:'Culture', d:3}, {k:'Money', d:-3}, {k:'Population', d:1}
  ]},
  { id: 'ban_festival', npc: 'The Minister of Control', text: "Your advisors warn that the spring festival stirs unrest. 'Ban it, and order will hold,' says the minister. Outside, the scent of roasting meat drifts in, and children laugh in the streets.", effects:[
    {k:'Culture', d:-3}, {k:'Control', d:2}, {k:'Population', d:-1}
  ]}
];


  const CRITICAL = [
    {id:'c01', text:'A palace coup threatens the throne. Crush or negotiate?', effect:6},
    {id:'c02', text:'A continent-wide pandemic collapses supply chains. Mobilize now?', effect:6},
    {id:'c03', text:'A massive earthquake levels the capital. Lead rebuilding?', effect:6},
    {id:'c04', text:'A revolution stirs in the industrial centers. Suppress or concede?', effect:6},
    {id:'c05', text:'Foreign powers demand tribute or war looms. Respond?', effect:6}
  ];


    const ONEUP = [
    {id:'u01', text:'A reclusive healer from the border claims to possess a vial that binds you to life; accept the healer\'s costly cure?', revive:true},
    {id:'u02', text:'A hidden reliquary is uncovered beneath the chapel at Kingswell; it contains a blessing that might restore your life at a price; claim it?', revive:true},
    {id:'u03', text:'An oath-bound knight offers to trade his soul-ward for a single boon that preserves your line; demand the knight\'s boon?', revive:true}
  ];


      const MINI_EVENTS = [
  {id:'m01', text:'A market fire destroys goods.', effects:[
    {k:'Money', d:-2}, {k:'Population', d:-1}
  ]},
  {id:'m02', text:'A street performer delights the crowd.', effects:[
    {k:'Culture', d:1}, {k:'Population', d:1}
  ]},
  {id:'m03', text:'A thief is caught stealing from the treasury.', effects:[
    {k:'Money', d:1}, {k:'Control', d:1}
  ]},
  {id:'m04', text:'A visiting healer cures the sick in a village.', effects:[
    {k:'Population', d:2}
  ]},
  {id:'m05', text:'Merchants report higher sales after a feast.', effects:[
    {k:'Money', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m06', text:'A militia patrol catches a group of bandits.', effects:[
    {k:'Strength', d:1}, {k:'Control', d:1}
  ]},
  {id:'m07', text:'A drunk noble causes a scene at the court.', effects:[
    {k:'Culture', d:-1}, {k:'Control', d:-1}
  ]},
  {id:'m08', text:'An unexpected tax windfall fills the coffers.', effects:[
    {k:'Money', d:2}
  ]},
  {id:'m09', text:'A sudden downpour ruins the town fair.', effects:[
    {k:'Culture', d:-1}, {k:'Population', d:-1}
  ]},
  {id:'m10', text:'A well-received sermon draws large crowds.', effects:[
    {k:'Religion', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m11', text:'A brawl in the tavern injures several locals.', effects:[
    {k:'Population', d:-1}, {k:'Control', d:-1}
  ]},
  {id:'m12', text:'A group of scholars publishes a new map.', effects:[
    {k:'Education', d:1}, {k:'Control', d:1}
  ]},
  {id:'m13', text:'A granary rat infestation spoils the harvest.', effects:[
    {k:'Population', d:-2}
  ]},
  {id:'m14', text:'A new sculpture is unveiled in the plaza.', effects:[
    {k:'Culture', d:1}
  ]},
  {id:'m15', text:'A guard is caught taking bribes.', effects:[
    {k:'Control', d:-1}, {k:'Money', d:-1}
  ]},
  {id:'m16', text:'A bard performs a ballad about the queen.', effects:[
    {k:'Culture', d:1}, {k:'Control', d:1}
  ]},
  {id:'m17', text:'A bridge collapse disrupts trade routes.', effects:[
    {k:'Control', d:-1}, {k:'Money', d:-2}
  ]},
  {id:'m18', text:'A foreign merchant donates to the abbey.', effects:[
    {k:'Religion', d:1}, {k:'Money', d:1}
  ]},
  {id:'m19', text:'A traveling teacher holds free classes.', effects:[
    {k:'Education', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m20', text:'A gang of pickpockets targets the market.', effects:[
    {k:'Money', d:-1}, {k:'Control', d:-1}
  ]},
  {id:'m21', text:'A charity bake sale raises funds for the poor.', effects:[
    {k:'Population', d:1}, {k:'Culture', d:1}
  ]},
  {id:'m22', text:'A lightning strike sets a barn on fire.', effects:[
    {k:'Population', d:-1}, {k:'Money', d:-1}
  ]},
  {id:'m23', text:'A scribe discovers an error in the census.', effects:[
    {k:'Control', d:1}
  ]},
  {id:'m24', text:'A popular song spreads across the realm.', effects:[
    {k:'Culture', d:1}
  ]},
  {id:'m25', text:'A shipment of grain arrives ahead of schedule.', effects:[
    {k:'Population', d:1}, {k:'Money', d:1}
  ]}
];

  // Essence configuration
  const ALL_ESSENCES = [
    {k:'Population', icon:'ðŸ‘¥'},
    {k:'Money', icon:'ðŸ’°'},
    {k:'Strength', icon:'ðŸ—¡ï¸'},
    {k:'Religion', icon:'âœï¸'},
    {k:'Culture', icon:'ðŸŽ­'},
    {k:'Education', icon:'ðŸŽ“'},
    {k:'Control', icon:'ðŸ›ï¸'}
  ];
  const GAME_OVER_REASONS = {
  'Population': {
    min: "Your people deserted the kingdom due to neglect and famine, leaving your throne abandoned.",
    max: "Your lands buckled under the strain of overpopulation, sparking famine and unrest that toppled your rule."
  },
  'Money': {
    min: "Your treasury ran dry, and with no gold to pay soldiers or buy loyalty, your crown was seized.",
    max: "Your hoarded wealth fueled envy and rebellion among the nobles, ending in your overthrow."
  },
  'Strength': {
    min: "Your weakened armies crumbled, and invaders stormed your capital, forcing your surrender.",
    max: "Your relentless militarism drove your generals to unite against you in a bloody coup."
  },
  'Religion': {
    min: "Your abandonment of faith alienated the clergy, who led the masses to depose you.",
    max: "Your zealous rule ignited holy uprisings that consumed your reign."
  },
  'Culture': {
    min: "Your neglect of the arts drained your kingdomâ€™s spirit, and the people turned against you.",
    max: "Your extravagant court alienated the masses, who revolted and ended your reign."
  },
  'Education': {
    min: "Ignorance spread unchecked, and unrest among the uneducated masses tore your rule apart.",
    max: "Your intellectual elite grew arrogant, challenging and ultimately dismantling your authority."
  },
  'Control': {
    min: "Your lax governance plunged the realm into chaos, and warlords seized the crown.",
    max: "Your oppressive grip bred rebellion, and the people rose to overthrow you."
  }
};

  // State
let state = {
  year: 1512,

  difficulty: 'easy',
  running: false,
  hideConsequences: false,
  hidePreview: false,
  essences: {},
  scenePool: [],
  // 1UP lives counter
  lives: 0,
  log: [],
  traits: [],
  achievements: new Set(),
  miniEventsTriggeredCount: 0,
  currentScene: null,
  persona: 'none',
  playerName: 'The King',
  lastDecadeUsed: new Set(),
  currentDecadeUsed: new Set(),
  usedSpecials: new Set(),
  
  // New tracking for unusual decisions
  unusualDeclines: [],
  unusualAccepts: [], 
  
  // New tracking for streak achievements
  consecutiveAgree: 0,
  consecutiveDecline: 0
};

  // Utility
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function shuffle(arr){ const c=arr.slice(); for(let i=c.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]]; } return c; }

  // Initialize essences depending on difficulty
  function initEssences(){ state.essences = {}; const mode = state.difficulty; let keys;
    if(mode === 'easy') keys = ALL_ESSENCES.slice(0,5).map(e=>e.k); // first 5
    else keys = ALL_ESSENCES.map(e=>e.k); // all 7
    keys.forEach(k=> state.essences[k] = 10); // start center    
  }

  function maybeInsertOneUp(pool) {
  // Only offer a 1UP if we don't already have one
  const oneupChance = 0.1; //oneup toggle

  // If player already has extra life, just ensure indicator shows active
  if ((state.lives || 0) > 0) {
    setOneUpIndicator(true);
    return;
  }

  // Otherwise, reset indicator to "no 1UP"
  setOneUpIndicator(false);

  // Validate pools
  if (!Array.isArray(pool) || !Array.isArray(ONEUP) || ONEUP.length === 0) return;

  // Random chance to insert a One-Up card
  if (Math.random() < oneupChance) {
    let slot = Math.floor(Math.random() * pool.length);
    // Avoid the first slot (usually reserved for guaranteed card)
    if (slot === 0) slot = 1 + Math.floor(Math.random() * (pool.length - 1));

    // Pick a random One-Up scenario and ensure revive:true
    const pick = { ...shuffle(ONEUP)[0], revive: true };

    // Add marker for renderer (badge, etc.)
    pick.hasOneUpBadge = true;

    // Place it into the pool
    pool[slot] = pick;
  }
}

  function renderEssences() {
  const max = 20;

  // Decide how many essences based on difficulty
  const essenceLimit = (state.difficulty === "easy") ? 5 :
                       (state.difficulty === "medium") ? 7 : 10;

  // âœ… Remove any extra essences if switching difficulty
  Array.from(essList.querySelectorAll('.ess')).forEach(node => {
    const key = node.getAttribute('data-ess');
    if (!(key in state.essences)) {
      node.remove();
    }
  });

  // âœ… Only render up to the allowed essences
  const essenceKeys = Object.keys(state.essences).slice(0, essenceLimit);

  essenceKeys.forEach(k => {
    const val = state.essences[k];
    const pct = Math.round((val / max) * 100);
    const meta = ALL_ESSENCES.find(e => e.k === k) || { icon: '?' };

    // Check if this essence already exists
    let node = essList.querySelector(`.ess[data-ess="${k}"]`);
    if (!node) {
      // Create new essence container once
      node = document.createElement('div');
      node.className = 'ess';
      node.setAttribute('data-ess', k);

      node.innerHTML = `
        <div class="label">${meta.icon} ${k}<span class="critical-dot"></span></div>
        <div class="bar essence-bar" data-essence="${k}"><i></i></div>
        <div class="value"></div>
      `;

      // Ensure transition is on the bar container for glow/fade
      const barContainer = node.querySelector('.bar');
      barContainer.style.transition =
        'box-shadow 0.28s ease, transform 0.28s ease, opacity 0.5s ease';

      essList.appendChild(node);
    }

    // --- update critical state ---
    node.classList.remove('critical', 'critical-border');
    if (val <= 3 || val >= 17) node.classList.add('critical-border');

    // --- update fill + value ---
    const barFill = node.querySelector('.bar > i');
    barFill.style.width = `${pct}%`;

    const valEl = node.querySelector('.value');
    valEl.textContent = val;

    // --- gradient thresholds ---
    if (val <= 3) {
      barFill.style.background = 'linear-gradient(90deg,#ff9b9b,#ff6b6b)';
      node.classList.add('critical');
    } else if (val >= 17) {
      barFill.style.background = 'linear-gradient(90deg,#9bf6b6,#64d368)';
    } else {
      barFill.style.background = 'linear-gradient(90deg,#ffd166,#ff9f1c)';
    }

    // --- Reset glow state smoothly ---
    const barContainer = node.querySelector('.bar');
    barContainer.style.boxShadow = '0 0 8px 4px rgba(255,255,255,0)';
    barContainer.style.opacity = '1';
    barContainer.style.transform = 'none';
  });
}

  function writeLog(text){ state.log.unshift((state.year)+' â€” '+text); logEl.innerHTML = state.log.slice(0,200).map(l=>`<div>${l}</div>`).join(''); }

  // Pool preparation with deduplication by type
// use the global suppress flag
window.suppressQueen = window.suppressQueen || false;

function preparePool() {
    const BIZZARE_CHANCE = 0.1; // toggle bizarre
    let pool = [];

    if (typeof state.queenArcStage === 'undefined') state.queenArcStage = 0;
    if (typeof state.queenArcActive === 'undefined') state.queenArcActive = true;
    if (typeof state.newArcStage === 'undefined') state.newArcStage = 0;
    if (typeof state.queenDeclineCount === 'undefined') state.queenDeclineCount = 0;
    if (typeof state.lockNormalQueen === 'undefined') state.lockNormalQueen = false;

    const queenArcIds = ['q21', 'q22', 'q23', 'q24', 'q25'];
    const newArcIds = ['q26', 'q27', 'q28'];
    const q29Id = 'q29';

    function getAnyNPCScene(list = NPC_SCENARIOS) {
        const filtered = list.filter(s => !s.decade || s.decade <= decadeNum);
        if (!filtered || filtered.length === 0) {
            const rep = REPEATING.filter(r => !r.decade || r.decade <= decadeNum);
            if (rep.length > 0) return shuffle(rep)[0];
            const spec = SPECIAL.filter(sp => !sp.decade || sp.decade <= decadeNum);
            if (spec.length > 0) return shuffle(spec)[0];
            return { id: 'fallback', text: 'No scenes available', npc: null };
        }
        return shuffle(filtered)[0];
    }

    const decadeNum = Math.floor(((state.year || 1512) - 1512) / 10) + 1; // âœ… one decade = 10 years
    if (!state.usedSpecials) state.usedSpecials = new Set();

    // === Arc & Queen handling ===
    if (state.decisionsThisDecade === 0 && state.running) {
        let npcScene;

        if (window.suppressQueen) {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc !== 'The Queen'));
        }
        else if (state.nextIsQ30) {
            npcScene = NPC_SCENARIOS.find(s => s.id === 'q30') || getAnyNPCScene();
            state.nextIsQ30 = false;
        }
        else if (state.queenArcActive) {
            if (state.queenArcStage < queenArcIds.length) {
                npcScene = NPC_SCENARIOS.find(s => s.id === queenArcIds[state.queenArcStage]) || getAnyNPCScene();
                state.queenArcStage++;
            } else {
                state.queenArcActive = false;
                npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc === 'The Queen' && /^q0\d/.test(s.id)));
            }
        }
        else if (state.newArcStage > 0 && state.newArcStage <= newArcIds.length) {
            npcScene = NPC_SCENARIOS.find(s => s.id === newArcIds[state.newArcStage - 1]) || getAnyNPCScene();
            state.newArcStage++;
            if (state.newArcStage > newArcIds.length) {
                state.lockNormalQueen = false;
            }
        }
        else if (state.newArcStage === 99) {
            npcScene = NPC_SCENARIOS.find(s => s.id === q29Id) || getAnyNPCScene();
            state.newArcStage = 0;
            state.lockNormalQueen = false;
        }
        else if (!state.lockNormalQueen) {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc === 'The Queen' && /^q0\d/.test(s.id)));
        }
        else {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc !== 'The Queen'));
        }

        if (window.suppressQueen && npcScene && /^q\d+/i.test(npcScene.id)) {
            npcScene = getAnyNPCScene(NPC_SCENARIOS.filter(s => s.npc !== 'The Queen'));
        }

        pool = [npcScene];

        const availableSpecials = SPECIAL.filter(s => (!s.decade || s.decade <= decadeNum) && !state.usedSpecials.has(s.id));
        let specials = availableSpecials.length >= 2 ? shuffle(availableSpecials).slice(0, 2) : shuffle(SPECIAL.filter(s => !s.decade || s.decade <= decadeNum)).slice(0, 2);
        specials.forEach(s => state.usedSpecials.add(s.id));
        pool.push(...specials);

        let repsCandidates = shuffle(REPEATING.filter(r => (!r.decade || r.decade <= decadeNum) && !state.lastDecadeUsed.has(r.id)));
        while (pool.length < 6 && repsCandidates.length) pool.push(repsCandidates.shift());

        if (Math.random() < BIZZARE_CHANCE) {
            let slot = Math.floor(Math.random() * pool.length);
            if (slot === 0) slot = 1 + Math.floor(Math.random() * (pool.length - 1));
            pool[slot] = shuffle(BIZZARE.filter(b => !b.decade || b.decade <= decadeNum))[0];
        }

        maybeInsertOneUp(pool);
        state.scenePool = [pool[0], ...shuffle(pool.slice(1))];
        return;
    }

    // === Normal decade pool ===
    const availableSpecials = SPECIAL.filter(s => (!s.decade || s.decade <= decadeNum) && !state.usedSpecials.has(s.id));
    let specials = availableSpecials.length >= 2 ? shuffle(availableSpecials).slice(0, 2) : shuffle(SPECIAL.filter(s => !s.decade || s.decade <= decadeNum)).slice(0, 2);
    pool.push(...specials);
    specials.forEach(s => state.usedSpecials.add(s.id));

    let repsCandidates = shuffle(REPEATING.filter(r => (!r.decade || r.decade <= decadeNum) && !state.lastDecadeUsed.has(r.id)));
    while (pool.length < 6 && repsCandidates.length) pool.push(repsCandidates.shift());

    if (pool.length < 6) {
        pool.push(...shuffle(REPEATING.filter(r => !r.decade || r.decade <= decadeNum)).slice(0, 6 - pool.length));
    }

    if (Math.random() < BIZZARE_CHANCE) {
        let slot = Math.floor(Math.random() * pool.length);
        if (slot === 0) slot = 1 + Math.floor(Math.random() * (pool.length - 1));
        pool[slot] = shuffle(BIZZARE.filter(b => !b.decade || b.decade <= decadeNum))[0];
    }

    const critChance = state.difficulty === 'hard' ? 0.45 : 0.12;
    if (Math.random() < critChance) {
        const slot = Math.floor(Math.random() * pool.length);
        pool[slot] = shuffle(CRITICAL.filter(c => !c.decade || c.decade <= decadeNum))[0];
    }

    if (window.suppressQueen) {
        pool = pool.filter(scene => !/^q\d+/i.test(scene.id));
    }

    maybeInsertOneUp(pool);
    state.scenePool = shuffle(pool);
}
  
  // Apply scene effects
  function applyEffects(scene, accepted, effectsOverride) {
  const consequences = [];
  if (!scene) return consequences;

  // 1) If explicit effects are provided (custom button), apply them verbatim
  if (Array.isArray(effectsOverride)) {
    for (let i = 0; i < effectsOverride.length; i++) {
      const { k, d } = effectsOverride[i];
      if (!(k in state.essences)) continue;
      const before = state.essences[k];
      state.essences[k] = clamp(before + d, 0, 20);
      consequences.push({ k, from: before, to: state.essences[k] });
    }
  }
  // 2) Otherwise, keep the original logic
  else if (scene.id && scene.id.startsWith('c')) {
    // Critical â€” distribute effect among all essences
    const total = scene.effect || 5;
    const keys = Object.keys(state.essences);
    const base = Math.floor(total / keys.length);
    let rem = total - base * keys.length;
    for (let i = 0; i < keys.length; i++) {
      const amt = base + (rem > 0 ? 1 : 0);
      if (rem > 0) rem--;
      const delta = accepted ? -amt : amt;
      const before = state.essences[keys[i]];
      state.essences[keys[i]] = clamp(before + delta, 0, 20);
      consequences.push({ k: keys[i], from: before, to: state.essences[keys[i]] });
    }
  }
  else if (scene.effects) {
    // Normal scenario with fixed effects
    for (let i = 0; i < scene.effects.length; i++) {
      const { k, d } = scene.effects[i];
      if (!(k in state.essences)) continue;
      const delta = accepted ? d : -d;
      const before = state.essences[k];
      state.essences[k] = clamp(before + delta, 0, 20);
      consequences.push({ k, from: before, to: state.essences[k] });
    }
  }

  // Handle 1UP pickup (revive token)
  if (scene && scene.revive === true) {
    // If effectsOverride exists, assume any positive choice grants the revive
    if (accepted || effectsOverride) {
      state.lives = (state.lives || 0) + 1;
      try { writeLog(`You obtained a 1UP. Lives available: ${state.lives}.`); } catch (e) {}
    } else {
      try { writeLog('You refused the life-binding boon.'); } catch (e) {}
    }
  }

  return consequences;
} 

  function adjustScenarioText(scene) {
  return scene; // No captions or icons added
}

  function mapTarget(name){ // map older shorthand to full keys
    if(name==='People') return 'Population'; return name;
  }

  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

  // Decision handling
function makeDecision(choiceOrAccepted, effectsOverride) {
    if (!state.running) return;
    const scene = state.currentScene;
    if (!scene) return;

    // === Disable all active choice buttons dynamically
    const activeBtns = choicesBox.querySelectorAll('button.choice');
    activeBtns.forEach(btn => btn.disabled = true);

    const queenFailureMessages = {
        q21: "The Queen's eyes dim. Without your support from the very start, her dream never leaves the palace walls. She ages in quiet sorrow.",
        q22: "Years of searching end in despair. The Queen collapses in the great hall as news of your refusal reaches her.",
        q23: "The ritual is abandoned midway. Decades of preparation dissolve into rumor, and the Queen retreats from public life, never to be seen again.",
        q24: "So close to the end, the Queen watches the circle break. Tears carve deep lines on her face as time claims her swiftly.",
        q25: "With the final step denied, the Queen accepts her fate. She smiles faintly â€” perhaps in relief, perhaps in resignation â€” before vanishing from the realm's story."
    };

    // --- Normalize accepted vs custom choice ---
    let accepted = false;
    if (typeof choiceOrAccepted === "boolean") {
        accepted = choiceOrAccepted; // old style true/false
    } else if (choiceOrAccepted && typeof choiceOrAccepted === "object") {
        // if passed a choice object
        accepted = !!choiceOrAccepted.accept; 
        effectsOverride = choiceOrAccepted.effects || effectsOverride;
    }

    // âœ… Apply effects (with optional override for custom choices)
    const consequences = applyEffects(scene, accepted, effectsOverride);

    // === Handle +1UP Acquisition ===
    if (scene.revive === true && (accepted || effectsOverride)) {
        state.lives = 1;
        setOneUpIndicator(true);
    }

    // === Special popup for q26/q27 ===
    if ((scene.id === 'q26' || scene.id === 'q27') && scene.resultText) {
        const popupMsg = accepted ? scene.resultText.accept : scene.resultText.decline;
        queenArcPopup(popupMsg);
    }

    // === New Arc Trigger (declines unlock q26) ===
    if (scene.npc === 'The Queen') {
        const sceneNum = parseInt(scene.id.replace('q', ''), 10);
        if (sceneNum >= 1 && sceneNum <= 20 && !state.lockNormalQueen) {
            if (!accepted) {
                state.queenDeclineCount++;
            } else {
                state.queenDeclineCount = 0;
            }

            if (state.queenDeclineCount === 3) {
                state.queenDeclineCount = 0;
                state.lockNormalQueen = true;
                state.newArcStage = 1; // Will start at q26 next decade
            }
        }
    }

    // === Arc Progress ===
    if (scene.id === 'q26') state.newArcStage = 2;
    if (scene.id === 'q27') {
        state.newArcStage = accepted ? 3 : 99; // 99 for q29 if declined
    }
    if (scene.id === 'q29') {
        state.newArcStage = 0;
        state.lockNormalQueen = false;
    }

    // === Immortality Arc ===
    const immortalityIds = ['q21', 'q22', 'q23', 'q24', 'q25'];
    if (state.queenArcActive && immortalityIds.includes(scene.id)) {
        if (!state.queenArcHistory) state.queenArcHistory = [];
        const wasRight = accepted;
        state.queenArcHistory.push(wasRight);

        if (!wasRight) {
            state.queenArcActive = false;
            let colorClass = '';
            switch (scene.id) {
                case 'q21': colorClass = 'queen-fail-early'; break;
                case 'q22':
                case 'q23': colorClass = 'queen-fail-mid'; break;
                case 'q24':
                case 'q25': colorClass = 'queen-fail-late'; break;
            }
            const failMsg = queenFailureMessages[scene.id] || "The Queen's fate is sealed.";
            queenArcPopup(failMsg);

            window.suppressQueen = true;
            state.lockNormalQueen = true;
        } else {
            const currentIndex = immortalityIds.indexOf(scene.id);
            if (currentIndex === immortalityIds.length - 1) {
                state.achievements.add("Eternal Love");
                queenArcPopup("Achievement unlocked: Eternal Love â€” The Queen now reigns beside you, forever.");
            }
        }
    }

    // === Remove qXX for rest of decade ===
    const decadeStart = state.year - 9;
    const hasRecentQueenScenario = state.log.find(l =>
        l && typeof l.id === 'string' &&
        l.id.startsWith('q') &&
        l.year >= decadeStart
    );
    if (scene.id && /^q\d+$/i.test(scene.id) && Array.isArray(state.scenePool)) {
        state.scenePool = state.scenePool.filter((s, index) =>
            index === 0 || !(s && typeof s.id === 'string' && /^q\d+$/i.test(s.id))
        );
    }

    // === Decade Progress ===
    state.decisionsThisDecade = (state.decisionsThisDecade || 0) + 1;
    decCountEl.textContent = state.decisionsThisDecade;

    if (state.decisionsThisDecade >= 6) {
        setTimeout(() => {
            yearEl.classList.add('fade-out-in');
            if (typeof decadeEl !== "undefined") {
                decadeEl.classList.add('fade-out-in');
            }

            setTimeout(() => {
                state.decisionsThisDecade = 0;
                decCountEl.textContent = state.decisionsThisDecade;

                state.decadeNumber = (state.decadeNumber || 1) + 1;
                state.year = (state.year || 1512) + 10;
                yearEl.textContent = state.year;
                if (typeof decadeEl !== "undefined") {
                    decadeEl.textContent = state.decadeNumber;
                }

                spawnFloat(yearEl, "+10 years");
                if (typeof decadeEl !== "undefined") {
                    spawnFloat(decadeEl, "+1 decade");
                }
            }, 300);

            setTimeout(() => {
                yearEl.classList.remove('fade-out-in');
                if (typeof decadeEl !== "undefined") {
                    decadeEl.classList.remove('fade-out-in');
                }
            }, 600);
        }, 600);
    }

    // === Logging & Updates ===
    let logText;
    if (typeof choiceOrAccepted === "object") {
        logText = `Chose: ${scene.text}`;
    } else {
        logText = (accepted ? 'Accepted: ' : 'Declined: ') + scene.text;
    }
    if (!state.hideConsequences) {
        const parts = consequences.map(c => `${iconFor(c.k)} ${c.k} ${c.to - c.from >= 0 ? '+' : ''}${c.to - c.from}`);
        if (parts.length) logText += ' â€” Effects: ' + parts.join(', ');
    }
    writeLog(logText);
    renderEssences();
    consequences.forEach(({ k, from, to }) => {
        const delta = to - from;
        if (delta !== 0) highlightEssenceChange(k, delta);
    });
    

    // === Unlimited Life Check ===
    const unlimitedLife = false;
    if (!unlimitedLife && checkGameOver()) {
        checkAchievements();
        return;
    }

    // === Next Scene ===
setTimeout(() => {
    if (state.decisionsThisDecade >= 6) {
        state.decisionsThisDecade = 0;
        writeLog('A decade passes â€” Year ' + state.year);
        yearEl.textContent = state.year;
        state.lastDecadeUsed = new Set(state.currentDecadeUsed);
        state.currentDecadeUsed = new Set();
        if (Math.random() < 0.3) triggerMiniEvent();
        checkAchievements();
        if (state.year >= 2012) { 
            winGame();
            return;
        }
        preparePool();
    }

    
    presentScene(nextScene());
}, 480);
}

  function presentScene(s) {
    if (!s) return;

    // Remove old fade classes so animation can retrigger
    sceneCard.classList.remove('fade-in', 'fade-out');
    void sceneCard.offsetWidth; // Force reflow

    // Fade out current card
    sceneCard.classList.add('fade-out');

    // Wait for fade-out to complete
    setTimeout(() => {
        state.currentScene = adjustScenarioText(s);
        if (s.id) state.currentDecadeUsed.add(s.id);

        // Reset base class
        sceneCard.className = 'scene-card';

        // Assign type-specific class
        if (s.id && s.id.startsWith('r')) sceneCard.classList.add('repeating');
        else if (s.id && s.id.startsWith('s')) sceneCard.classList.add('special-scenario');
        else if (s.id && s.id.startsWith('c')) sceneCard.classList.add('critical');
        else if (s.id && s.id.startsWith('q')) sceneCard.classList.add('queen-scenario');
        else if (s.id && s.id.startsWith('u') && s.revive === true) {
            sceneCard.classList.add('oneup');
        }

        // Bizarre scenario check
        if (BIZZARE.some(item => item.id === s.id)) {
            sceneCard.classList.add('bizarre-scenario');
        }

        // Update content
        sceneCard.innerHTML = `<div class="scene-card-content">${s.text}</div>`;

        // === ONEUP sparkle effect ===
        const isOneUp = !!(s && s.revive === true);
        if (isOneUp) {
            const sparkleCount = 30;

            if (!sceneCard.querySelector('.oneup-badge')) {
                const badge = document.createElement('div');
                badge.className = 'oneup-badge';
                badge.textContent = 'âœš 1UP';

                // inline fade animation
                badge.style.opacity = '0';
                badge.style.transition = 'opacity 0.6s ease';

                sceneCard.appendChild(badge);

                // trigger fade-in on next frame
                requestAnimationFrame(() => {
                    badge.style.opacity = '1';
                });

                // auto fade-out after 2s
                setTimeout(() => {
                    badge.style.opacity = '0';
                    setTimeout(() => badge.remove(), 600);
                }, 2000);
            }

            sceneCard.querySelectorAll('.sparkle').forEach(el => el.remove());

            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.classList.add('sparkle');

                const posX = Math.random() * sceneCard.clientWidth;
                const posY = Math.random() * sceneCard.clientHeight;
                sparkle.style.left = `${posX}px`;
                sparkle.style.top = `${posY}px`;

                sparkle.style.animationDelay = `${Math.random() * 1.6}s`;
                const size = 2 + Math.random() * 2;
                sparkle.style.width = `${size}px`;
                sparkle.style.height = `${size}px`;

                sceneCard.appendChild(sparkle);
            }
        }

        // === Default UI Reset ===
        choicesBox.style.display = 'none';
        queenChoicesBox.style.display = 'none';

        // === Handle Queen Scenarios ===
        if (s.id && s.id.startsWith('q')) {
            choicesBox.style.display = 'none';
            queenChoicesBox.style.display = 'flex';
            queenAgreeBtn.disabled = false;
            queenRefuseBtn.disabled = false;
        }

        // === Special case: single-choice (eg. q29) ===
        if (s.singleChoice) {
            choicesBox.style.display = 'none';
            queenChoicesBox.style.display = 'none';

            let ellipsisBtn = document.getElementById("ellipsisBtn");
            if (!ellipsisBtn) {
                ellipsisBtn = document.createElement("button");
                ellipsisBtn.id = "ellipsisBtn";
                ellipsisBtn.className = "choice fullwidth";
                const footerHint = document.querySelector(".footer-small");
                if (footerHint) {
                    footerHint.parentNode.insertBefore(ellipsisBtn, footerHint);
                } else {
                    choicesBox.parentNode.appendChild(ellipsisBtn);
                }
            }

            ellipsisBtn.textContent = s.singleChoice.label || "...";
            ellipsisBtn.style.display = "block";
            ellipsisBtn.disabled = false;

            ellipsisBtn.onclick = () => {
                ellipsisBtn.disabled = true;

                if (typeof applyEffects === "function") applyEffects(s, true);
                if (typeof renderEssences === "function") renderEssences();
                if (typeof s.singleChoice.onChoose === "function") s.singleChoice.onChoose();

                ellipsisBtn.style.transition = "opacity 0.4s ease";
                ellipsisBtn.style.opacity = "0";

                setTimeout(() => {
                    ellipsisBtn.style.display = "none";
                    ellipsisBtn.style.opacity = "1"; // reset
                    presentScene(nextScene());
                }, 500);
            };

        } else {
            const ellipsisBtn = document.getElementById("ellipsisBtn");
            if (ellipsisBtn) ellipsisBtn.style.display = "none";
        }

        // === Dynamic Custom Choices ===
        if (!s.id.startsWith('q') && Array.isArray(s.choices) && s.choices.length) {
            choicesBox.style.display = 'flex';
            choicesBox.innerHTML = '';

            s.choices.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = 'choice';
                btn.textContent = choice.label || `Choice ${idx + 1}`;
                btn.disabled = false;

                attachPreviewEvents(btn, choice, idx);

                btn.addEventListener('click', () => {
                    btn.disabled = true;
                    trackAnyDecision(choice.id || `${s.id}_choice_${idx}`);
                    makeDecision(choice, choice.effects || null);
                    
                });

                choicesBox.appendChild(btn);
            });
        }

        // === Default accept/decline ===
else if (!s.id.startsWith('q') && !s.singleChoice) {
    choicesBox.style.display = 'flex';
    choicesBox.innerHTML = '';

    const acceptBtnDyn = document.createElement('button');
    acceptBtnDyn.className = 'choice';
    acceptBtnDyn.textContent = "Accept";
    acceptBtnDyn.disabled = false;

    // âœ… add preview for Accept
    attachPreviewEvents(acceptBtnDyn, { accept: true, effects: s.effectsAccept || null }, 0);

    acceptBtnDyn.addEventListener('click', () => {
        makeDecision(true);
    });

    const declineBtnDyn = document.createElement('button');
    declineBtnDyn.className = 'choice';
    declineBtnDyn.textContent = "Decline";
    declineBtnDyn.disabled = false;

    // âœ… add preview for Decline
    attachPreviewEvents(declineBtnDyn, { accept: false, effects: s.effectsDecline || null }, 1);

    declineBtnDyn.addEventListener('click', () => {
        makeDecision(false);
    });

    choicesBox.appendChild(acceptBtnDyn);
    choicesBox.appendChild(declineBtnDyn);
}

        // Fade in
        sceneCard.classList.remove('fade-out');
        sceneCard.classList.add('fade-in');

        requestAnimationFrame(() => {
            sceneCard.classList.remove('centered', 'topAligned');
            if (sceneCard.scrollHeight > sceneCard.clientHeight) {
                sceneCard.classList.add('topAligned');
            } else {
                sceneCard.classList.add('centered');
            }
        });

        // Render previews
        renderChoicePreview(s);

    }, 400);
}

function nextScene() {
  // ðŸ”’ If we owe the child intro, launch it *before* consuming the pool
  // (and only after result popups are actually closed)
  try {
    if (window.ChildArc && ChildArc.tryLaunchIntro()) {
      state.currentScene = null;
      return null; // wait; ChildArc will call nextScene() after its popup/card is dismissed
    }
  } catch (e) {
    console.warn('ChildArc gate skipped:', e);
  }

  // Ensure there is a pool
  if (!state.scenePool || state.scenePool.length === 0) {
    if (typeof preparePool === 'function') {
      preparePool();
    } else {
      console.warn('preparePool() is not defined; nextScene() returning null.');
      state.currentScene = null;
      return null;
    }
  }

  // ðŸ›¡ï¸ Hotfix: dedupe any duplicate scene IDs in the pool
  try {
    if (Array.isArray(state.scenePool)) {
      const seen = new Set();
      state.scenePool = state.scenePool.filter(s => {
        if (!s || typeof s.id !== 'string') return true;
        if (seen.has(s.id)) return false;
        seen.add(s.id);
        return true;
      });
    }
  } catch (e) {
    console.warn('Pool dedupe failed:', e);
  }

  // After one Queen (qXX) appears in a decade, strip additional qXX from the remainder
  try {
    const hadQueenThisDecade =
      state.currentDecadeUsed &&
      [...state.currentDecadeUsed].some(id => /^q\d+$/i.test(id));

    if (hadQueenThisDecade && Array.isArray(state.scenePool)) {
      state.scenePool = state.scenePool.filter((scene, index) =>
        index === 0 || !(scene && typeof scene.id === 'string' && /^q\d+$/i.test(scene.id))
      );
    }
  } catch (err) {
    console.warn('nextScene: purge step skipped:', err);
  }

  // Pop and set current scene
  const scene = (state.scenePool && state.scenePool.shift()) || null;
  state.currentScene = scene;
  return scene;
}

function renderChoicePreview(scene, overrideEffects) {
  // reset essences
  const bars = document.querySelectorAll('.ess .bar > i'); 
  bars.forEach(b => {
    b.style.opacity = '1';
    b.style.transform = 'scaleY(1)';
    b.style.boxShadow = 'none';
  });

  function getAffected(choice, idx) {
    const set = new Set();

    // use overrideEffects (manual preview) if given
    if (Array.isArray(overrideEffects) && overrideEffects.length) {
      overrideEffects.forEach(e => {
        if (e.k in state.essences) set.add(e.k);
      });
    } else if (choice && choice.effects) {
      choice.effects.forEach(e => {
        if (e.k in state.essences) set.add(e.k);
      });
    } else if (scene && scene.effects && !choice) {
      scene.effects.forEach(e => {
        if (e.k in state.essences) set.add(e.k);
      });
    }
    return set;
  }
  
function attachPreviewEvents(btn, choice, idx) {
    if (!btn) return;
    let holdTimer = null;
    let previewShown = false;

    const showPreview = () => {
        if (!hidePreviewCheckbox.checked) {
            highlightAffected(getAffected(choice, idx), idx === 0);
        }
    };

    const triggerHoldPreview = () => {
        if (!previewShown) {
            previewShown = true; // mark as triggered
            showPreview();

            // âœ… Vibrate only once here
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
    };

    const clearPreviewNow = () => {
        clearTimeout(holdTimer);
        holdTimer = null;
        previewShown = false; // reset for next interaction
        renderEssences();
    };

    // --- Desktop hover ---
    btn.addEventListener('mouseenter', showPreview);
    btn.addEventListener('mouseleave', clearPreviewNow);

    // --- Mouse press ---
    btn.addEventListener('mousedown', showPreview);
    ['mouseup', 'mouseleave', 'blur'].forEach(ev => {
        btn.addEventListener(ev, clearPreviewNow);
    });

    // --- Touch hold ---
    btn.addEventListener('touchstart', () => {
        if (!hidePreviewCheckbox.checked) {
            clearTimeout(holdTimer);
            holdTimer = setTimeout(triggerHoldPreview, 550);
        }
    }, { passive: true });

    btn.addEventListener('touchend', clearPreviewNow, { passive: true });
    btn.addEventListener('touchcancel', clearPreviewNow, { passive: true });
}

// === Attach to dynamic scenario buttons ===
const dynamicBtns = choicesBox.querySelectorAll('button.choice');
dynamicBtns.forEach((btn, idx) => {
    const choice = scene.choices ? scene.choices[idx] : null;
    attachPreviewEvents(btn, choice, idx);
});

// === Attach to Queen buttons only if current scene is Queen ===
if (scene && scene.id && scene.id.startsWith('q')) {
    attachPreviewEvents(queenAgreeBtn, scene.choices ? scene.choices[0] : null, 0);
    attachPreviewEvents(queenRefuseBtn, scene.choices ? scene.choices[1] : null, 1);
}} 


function highlightAffected(setAff, isAccept) {
  const nodes = Array.from(essList.children);
  const transition = 'box-shadow 0.2s ease, transform 0.2s ease, opacity 0.2s ease';

  nodes.forEach(n => {
    const label = n.querySelector('.label').textContent.trim();
    const key = label.replace(/^\S+\s/, '');
    const bar = n.querySelector('.bar');
    if (!bar) return;

    if (!bar.style.position) bar.style.position = 'relative';
    bar.style.transition = transition;
    bar.style.zIndex = '0';

    if (setAff.has(key)) {
      // Neutral gray glow, smaller radius
      bar.style.boxShadow = '0 0 6px 3px rgba(128, 128, 128, 0.75)';
      bar.style.opacity = '1';
      bar.style.transform = 'scale(1.03)';
    } else {
      bar.style.boxShadow = '0 0 6px 3px rgba(128, 128, 128, 0)';
      bar.style.opacity = '0.35';
      bar.style.transform = 'none';
    }
  });
}

// Essence icon lookup
function iconFor(k) {
  const e = ALL_ESSENCES.find(x => x.k === k);
  return e ? e.icon : 'â—¼ï¸';
}

if (typeof window.attachPreviewEvents !== 'function') {
  window.attachPreviewEvents = function attachPreviewEvents(btn, choice, idx, delayMs = 500) {
    let holdTimer = null;

    const computeAffected = () => {
      if (typeof getAffected === 'function') {
        return getAffected(choice, idx);
      }
      // Fallback: derive from choice.effects
      const affected = new Set();
      const effects = (choice && choice.effects) || [];
      effects.forEach(e => {
        if (e && e.k && state && state.essences && (e.k in state.essences)) {
          affected.add(e.k);
        }
      });
      return affected;
    };

    const start = () => {
      if (hidePreviewCheckbox && hidePreviewCheckbox.checked) return;
      clearTimeout(holdTimer);
      holdTimer = setTimeout(() => {
        if (typeof highlightAffected === 'function') {
          const affected = computeAffected();
          const isPrimary = (typeof idx === 'number') ? (idx === 0) : true;
          highlightAffected(affected, isPrimary);
        }
      }, delayMs);
    };

    const cancel = () => {
      clearTimeout(holdTimer);
      if (typeof renderEssences === 'function') renderEssences();
    };

    // Start on press/hold
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, { passive: true });

    // Cancel/reset on release/leave/cancel (covers mouse & touch)
    ['mouseup','mouseleave','touchend','touchcancel','blur'].forEach(ev => {
      btn.addEventListener(ev, cancel);
    });
  };
}

// Popup system for Queen & special arcs
function queenArcPopup(message, options = {}) {
  const { cssClass = '', callback = null, isResult = false } = options;

  const overlay = document.createElement('div');
  overlay.className = 'queen-popup-overlay';

  const popup = document.createElement('div');
  popup.className = `queen-popup ${cssClass}`;
  popup.innerHTML = `
    <div class="queen-popup-text">${message}</div>
    <button class="queen-popup-close">Continue</button>
  `;

  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  setTimeout(() => {
    overlay.classList.add('show');
    popup.classList.add('show');
  }, 50);

  popup.querySelector('.queen-popup-close').addEventListener('click', () => {
    overlay.classList.remove('show');
    popup.classList.remove('show');
    setTimeout(() => {
      overlay.remove();

      // ðŸ”‘ Only run intro hook if this was a result popup
      if (isResult && typeof state.afterResultCallback === "function") {
        const fn = state.afterResultCallback;
        state.afterResultCallback = null; // one-shot
        fn(); // This will call showChildIntro(...)
        return; // donâ€™t fall through to callback() or nextScene() again
      }

      if (typeof callback === "function") {
        callback();
      }
    }, 500);
  });
}

  // Game over & win
function checkGameOver() {
  const entries = Object.entries(state.essences);
  for (const [k, v] of entries) {
    if (v <= 0 || v >= 20) {
      // If we have a 1UP, consume it and recover instead of game over
      if ((state.lives || 0) > 0) {
        state.lives -= 1;

        // === Reset +1UP indicator if no lives left ===
        if (state.lives <= 0) {
          setOneUpIndicator(false);
        }

        const offending = k;
        const was = v;

        // Bring the offending essence back to safe mid and soften extremes on others
        state.essences[offending] = 10;
        for (const [kk, vv] of Object.entries(state.essences)) {
          if (kk !== offending) {
            state.essences[kk] = Math.max(1, Math.min(19, vv));
          }
        }

        try { renderEssences(); } catch (e) {}
        try {
          const properName = offending.charAt(0).toUpperCase() + offending.slice(1);
          writeLog(`Miracle! 1UP saved your reign from ${properName} ${was <= 0 ? "collapse" : "overreach"}. Lives left: ${state.lives}.`);
        } catch (e) {}
        try {
          if (typeof queenArcPopup === "function") {
            queenArcPopup("<b>1UP used!</b><br>Your fate is turned aside. The realm steadies for now.");
          }
        } catch (e) {}

        // Continue the game
        return false;
      }

      // No 1UP available â€” proceed to game over
      state.running = false;
      choicesBox.style.display = 'none';

      const properName = k.charAt(0).toUpperCase() + k.slice(1);
      const reasonData = GAME_OVER_REASONS[properName];
      let reason;
      if (reasonData) {
        reason = v <= 0 ? reasonData.min : reasonData.max;
      } else {
        reason = v <= 0
          ? `${properName} has completely collapsed.`
          : `${properName} has spiraled out of control.`;
      }

      showGameOverOverlay(reason);
      writeLog(`Game Over â€” ${properName} reached ${v}. ${reason}`);

      // Reset any toggles that suppress arcs
      window.suppressQueen = false;

      return true; // stop further actions
    }
  }
  return false;
}

  function winGame(){ state.running=false; choicesBox.style.display='none'; const msg = `Victory â€” ${state.playerName} reigned to ${state.year}.`; sceneCard.textContent = msg; const btn = document.createElement('button'); btn.textContent='Play again'; btn.className='choice'; btn.style.marginTop='12px'; btn.onclick = ()=> showNameOverlay(); sceneCard.appendChild(btn); writeLog('Victory â€” reached '+state.year); computeEnding(); }

  function computeEnding(){ // simple ending descriptions based on top essences
    const sorted = Object.entries(state.essences).sort((a,b)=>b[1]-a[1]); const top = sorted.slice(0,2).map(s=>s[0]); let title='A Long Reign';
    if(top.includes('Population') && top.includes('Culture')) title='The Golden Age';
    else if(top.includes('Strength') && !top.includes('Culture')) title='The Iron Throne';
    else if(top.includes('Money') && top.includes('Control')) title='The Merchant Commonwealth';
    else if(top.includes('Religion') && top.includes('Population')) title='The Pious Kingdom';
    writeLog(`Ending: ${title}`);
  }

  // Mini events between decades
function triggerMiniEvent() {
    state.miniEventsTriggeredCount++;
    checkAchievements(); // count this mini-event

    const ev = shuffle(MINI_EVENTS)[0];

    // Prepare overlay elements
    const textEl = document.getElementById('miniEventText');
    const effectsEl = document.getElementById('miniEventEffects');

    // Set main text
    textEl.textContent = ev.text;

    // Apply effects and build effect display
    const effectsHtml = [];
    ev.effects.forEach(e => {
        if (e.k in state.essences) {
            const before = state.essences[e.k];
            state.essences[e.k] = clamp(before + e.d, 0, 20);
            const delta = e.d >= 0 ? `+${e.d}` : `${e.d}`;
            effectsHtml.push(`${iconFor(e.k)} ${e.k} ${delta}`);
        }
    });
    effectsEl.innerHTML = `<div style="font-weight:700;">Effects: ${effectsHtml.join(', ')}</div>`;

    // âœ… Use the helper instead of duplicating fade logic
    showMiniEventOverlay();

    // Update essences in sidebar
    renderEssences();

    // Log with highlight
    writeLog(`<span class="mini-event-log">Mini-event: ${ev.text}</span>`);
}

function handleDecision(isAgree) {
  if (isAgree) {
    state.consecutiveAgree++;
    state.consecutiveDecline = 0;
    if (state.consecutiveAgree >= 5) {
      unlock('Steadfast Supporter'); // Agreed 5 times in a row
    }
  } else {
    state.consecutiveDecline++;
    state.consecutiveAgree = 0;
    if (state.consecutiveDecline >= 5) {
      unlock('Resolute Dissenter'); // Declined 5 times in a row
    }
  }
  checkAchievements(); // Immediately update achievements UI
}

  // Achievements
  function checkAchievements() {
  // Longevity
  if (state.year >= 1600) unlock('Survived the 16th Century');
  if (state.year >= 1800) unlock('Centuries of Rule');
  if (state.year >= 2000) unlock('Long Reign');

  // Balanced
  if (Object.values(state.essences).every(v => v >= 8 && v <= 12)) {
    unlock('Godspeed, King');
  }

  // First Decade
  if (state.decisionsThisDecade >= 1) unlock('Decisive');

  // Three mini-events
  if (state.miniEventsTriggeredCount >= 3) unlock('Variety is the Spice of Life');

  // Heavy mini-event lover
  if (state.miniEventsTriggeredCount >= 10) unlock('Mini-eventer');

  // Stat-specific highs
  if (state.essences.Religion >= 19) unlock('Pious Ruler');
  if (state.essences.Money >= 19) unlock('Treasure Hoard');
  if (state.essences.Culture >= 19) unlock('Cultural Icon');
  if (state.essences.Population >= 19) unlock('Beloved Leader');
  if (state.essences.Strength >= 19) unlock('Warlord Supreme');
  if (state.essences.Control >= 19) unlock('Iron Grip');
  if (state.essences.Education >= 19) unlock('Enlightened Mind');

  // ===============================
  // NEW ACHIEVEMENTS
  // ===============================

  // Failures in specific decades
  if (state.year >= 1500 && state.year < 1520 && state.gameOver) unlock('Gone Too Soon');
  if (state.year >= 1600 && state.year < 1610 && state.gameOver) unlock('Short 17th Century');
  if (state.year >= 1700 && state.year < 1710 && state.gameOver) unlock('Early 18th Century Collapse');
  if (state.year >= 1800 && state.year < 1810 && state.gameOver) unlock('Failed at the Turn of the Century');
  if (state.year >= 1900 && state.year < 1910 && state.gameOver) unlock('Lost in the New Age');

  // Extreme highs & lows
  if (Object.values(state.essences).some(v => v <= 0)) unlock('On the Brink'); // any stat hits zero
  if (Object.values(state.essences).some(v => v >= 20)) unlock('Overflowing Power'); // max out any stat
  if (state.essences.Population <= 2) unlock('Empty Kingdom');
  if (state.essences.Money <= 2) unlock('Penniless Monarch');
  if (state.essences.Strength <= 2) unlock('Defenseless Ruler');
  if (state.essences.Religion <= 2) unlock('Faithless Crown');
  if (state.essences.Culture <= 2) unlock('Cultural Collapse');
  if (state.essences.Control <= 2) unlock('Chaos Reigns');
  if (state.essences.Education <= 2) unlock('Age of Ignorance');

  // Rare unusual decisions Bizzare Scenarios
  if (state.unusualDeclines && state.unusualDeclines.includes('plead_help')) unlock('Cold-Hearted');
  if (state.unusualAccepts && state.unusualAccepts.includes('fund_bizarre')) unlock('Patron of the Absurd');
  if (state.unusualDeclines && state.unusualDeclines.includes('urgent_marriage')) unlock('Freedom First');
  if (state.unusualAccepts && state.unusualAccepts.includes('royal_masquerade')) unlock('Masked Benefactor');
  if (state.unusualDeclines && state.unusualDeclines.includes('ban_festival')) unlock('Killjoy Monarch');
  
  // Button Presser
  if (state.Declines && state.unusualDeclines.length >= 5) unlock('Chronic Naysayer');
  if (state.Accepts && state.unusualAccepts.length >= 5) unlock('Yes to Everything');

  // Mini-event extremes
  if (state.miniEventsTriggeredCount >= 20) unlock('Mini-event Legend');
  if (state.miniEventsTriggeredCount === 0 && state.year >= 1600) unlock('A Life Without Distraction');

  // Combo conditions
  if (state.essences.Money >= 19 && state.essences.Culture >= 19) unlock('Wealth & Refinement');
  if (state.essences.Strength >= 19 && state.essences.Population >= 19) unlock('Might of the Masses');

  renderAchievements();
}

function unlock(n) {
  if (!state.achievements.has(n)) {
    state.achievements.add(n);
    writeLog('Achievement unlocked: ' + n);
    renderAchievements(); // Immediately render achievements
  }
}

function renderAchievements() {
  const achList = document.getElementById('achList'); // Ensure achList is correct
  achList.innerHTML = Array.from(state.achievements)
    .map(a => `<div class="ach">â€¢ ${a}</div>`).join('');
}
  
// Hook up Mini Event popup dismiss
document.getElementById('dismissMiniEvent')?.addEventListener('click', () => {
    const overlay = document.getElementById('miniEventOverlay');

    // Reset classes and force reflow so animation retriggers
    overlay.classList.remove('fade-in', 'fade-out');
    void overlay.offsetWidth;

    // Start fade-out
    overlay.classList.add('fade-out');

    // After fade completes, hide and disable interaction
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.setAttribute('inert', ''); // make it unfocusable
    }, 400); // match CSS transition duration
});

// Show Mini Event Overlay
function showMiniEventOverlay() {
    const overlay = document.getElementById('miniEventOverlay');
    const dismissBtn = document.getElementById('dismissMiniEvent');

    overlay.removeAttribute('inert');
    overlay.style.display = 'flex';

    // Force reflow so transition works after display change
    void overlay.offsetWidth;

    overlay.classList.add('visible');

    if (dismissBtn) {
        dismissBtn.classList.add('fullwidth'); // ðŸ‘ˆ stretch OK button
        dismissBtn.focus();
    }
}

// Hide Mini Event Overlay
function hideMiniEventOverlay() {
    const overlay = document.getElementById('miniEventOverlay');

    overlay.classList.remove('visible');

    // After fade-out, fully hide
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.setAttribute('inert', '');
    }, 400); // match CSS transition
}

// Hook up dismiss button
document.getElementById('dismissMiniEvent')
        ?.addEventListener('click', hideMiniEventOverlay);
        
   // Persona definitions
  const PERSONAS = {
  beloved: {
    name: 'Beloved Ruler',
    bonus: { Population: 2 }
  },
  iron: {
    name: 'Iron Fist',
    bonus: { Strength: 2 }
  },
  shrewd: {
    name: 'Shrewd Economist',
    bonus: { Money: 2 }
  },
  patron: {
    name: 'Patron of Arts',
    bonus: { Culture: 2 }
  }
};

// Accept name and start the game (hard reset every reign)
acceptName.addEventListener('click', () => {
  const enteredName = (playerNameInput && playerNameInput.value || '').trim();

  // Ensure global suppression is cleared
  window.suppressQueen = false;
  try { if (typeof window.suppressQueen !== 'undefined') window.suppressQueen = false; } catch (e){}

  // Full fresh state (preserve selected difficulty/theme toggles if you want)
  window.state = {
    playerName: enteredName || "The King",
    persona: personaEl ? personaEl.value : 'none',
    // Core game progression
    running: true,
    year: 1512,

    decisionsThisDecade: 0,      // main counter
    decadeNumber: 1,
    currentScene: null,
    log: [],
    achievements: new Set(),
    traits: [],
    lastDecadeUsed: new Set(),
    currentDecadeUsed: new Set(),
    usedSpecials: new Set(),

    // Queen arc reset
    queenArcActive: true,
    queenArcStage: 0,
    queenIntroIndex: 0,
    newArcStage: 0,
    lockNormalQueen: false,

    // misc
    unusualDeclines: [],
    unusualAccepts: [],
    consecutiveAgree: 0,
    consecutiveDecline: 0,
    miniEventsTriggeredCount: 0,

    // scenario pool
    scenePool: []
  };

  // ðŸ”‘ ensure local `state` points to the fresh object
  state = window.state;

  // Initialize essences and persona
  state.difficulty = (document.getElementById('difficulty')?.value) || state.difficulty || 'medium';
  if (typeof initEssences === "function") initEssences();
  if (typeof applyStartingPersona === "function") applyStartingPersona();
  if (typeof applyPersona === "function") applyPersona();

  // Clear UI lists
  document.getElementById('log').innerHTML = '';
  const tl = document.getElementById('traitsList'); 
  if (tl) tl.innerHTML = '';
  document.getElementById('yearDisplay').textContent = state.year;
  document.getElementById('decCount').textContent = state.decisionsThisDecade || 0;

  // Rebuild pool fresh
  if (typeof preparePool === "function") preparePool();

  // Update sidebar/UI
  if (typeof renderEssences === "function") renderEssences();
  if (typeof renderAchievements === "function") renderAchievements();
  if (typeof renderTraits === "function") renderTraits?.();

  // Hide overlay & write starting log
  hideNameOverlay?.();
  writeLog?.(`${state.playerName} begins their reign.`);

  // âœ… Show Decisions/Traits bar only after reign starts
  const sceneMeta = document.getElementById('sceneMeta');
  if (sceneMeta) {
    sceneMeta.style.display = 'block';
    sceneMeta.classList.add('fade-in-pop'); // optional smooth fade
  }

  // Finally, start gameplay
  if (typeof startGame === "function") startGame();
});

// Randomize name and persona
randomize.addEventListener('click', () => {
  const personaKeys = Object.keys(PERSONAS);
  const names = ['Polo', 'Eliceo', 'Makol II', 'Somarr'];

  const pickedPersona = personaKeys[Math.floor(Math.random() * personaKeys.length)];
  const pickedName = names[Math.floor(Math.random() * names.length)];

  personaEl.value = pickedPersona;
  playerNameInput.value = pickedName;
});

// Apply persona bonuses & traits
function applyPersona() {
  state.traits = [];

  const persona = PERSONAS[state.persona];
  if (!persona) return;

  // Add trait name
  state.traits.push(persona.name);

  // Apply each essence bonus
  for (const [essence, amount] of Object.entries(persona.bonus)) {
    state.essences[essence] += amount;
  }

  renderTraits();
}

  function renderTraits(){ traitsList.innerHTML = state.traits.map(t=>`<div class="trait">${t}</div>`).join(''); playerPlate.textContent = state.playerName; }

  // Choice listeners Button Handle

acceptBtn.addEventListener('click', () => {
    trackAnyDecision('accept'); // count every accept
    handleDecision(true); // âœ… Track streaks
    makeDecision(true);
});

declineBtn.addEventListener('click', () => {
    trackAnyDecision('decline'); // count every decline
    handleDecision(false); // âœ… Track streaks
    makeDecision(false);
});

queenAgreeBtn.addEventListener('click', () => {
    trackAnyDecision('accept'); // count queen accepts too
    handleDecision(true); // âœ… Track streaks
    makeDecision(true);
});

queenRefuseBtn.addEventListener('click', () => {
    trackAnyDecision('decline'); // count queen declines too
    handleDecision(false); // âœ… Track streaks
    makeDecision(false);
});

hideConsEl.addEventListener('change', () => state.hideConsequences = hideConsEl.checked);
hidePrevEl.addEventListener('change', () => state.hidePreview = hidePrevEl.checked);

    function trackAnyDecision(type) {
    if (!state) state = {}; // ensure state exists

    if (type === 'accept') {
        if (!Array.isArray(state.allAccepts)) state.allAccepts = [];
        state.allAccepts.push(Date.now()); // push dummy value
    } else if (type === 'decline') {
        if (!Array.isArray(state.allDeclines)) state.allDeclines = [];
        state.allDeclines.push(Date.now());
    }

    // Safely check achievements
    if (Array.isArray(state.allDeclines) && state.allDeclines.length >= 5) {
        unlock('Chronic Naysayer');
    }
    if (Array.isArray(state.allAccepts) && state.allAccepts.length >= 5) {
        unlock('Yes to Everything');
    }
}


startBtn.addEventListener('click', () => { showNameOverlay(); });

  // Start game flow
function startGame() {
  __TRACE('startGame() entry', { year: state.year, decisionsThisDecade: state.decisionsThisDecade });

  // Basic state reset
  state.running = true;
  state.queenIntroIndex = 0;  // reset Queen story arc
  state.queenArcActive = true;    
  state.queenArcStage = 0;        
  state.difficulty = difficultyEl.value;
  state.year = 1512;
  state.decisionsThisDecade = 0;   // âœ… reset main decade counter
  state.decadeNumber = 1;          // âœ… reset decade index
  state.log = [];
  state.currentScene = null;
  state.achievements = new Set();
  state.traits = [];

  // Setup starting state
  initEssences();
  applyStartingPersona();
  renderEssences();
  renderTraits();

  // Prepare first pool â€” will inject q21 if decade start
  preparePool();

  // UI updates
  yearEl.textContent = state.year;
  decCountEl.textContent = state.decisionsThisDecade; // âœ… display from main counter
  writeLog(`${state.playerName} begins their reign.`);
  presentScene(nextScene()); 
  applyTheme();
}

  function applyStartingPersona(){ // persona might have been set earlier in overlay; apply small buffs
    if(state.persona==='beloved'){ state.traits.push('Beloved Ruler'); state.essences['Population'] = clamp(state.essences['Population']+2,0,20); }
    else if(state.persona==='iron'){ state.traits.push('Iron Fist'); state.essences['Strength'] = clamp(state.essences['Strength']+2,0,20); }
    else if(state.persona==='shrewd'){ state.traits.push('Shrewd Economist'); state.essences['Money'] = clamp(state.essences['Money']+2,0,20); }
    else if(state.persona==='patron'){ state.traits.push('Patron of Arts'); state.essences['Culture'] = clamp(state.essences['Culture']+2,0,20); }
  }

  function applyTheme(){ const root = document.getElementById('mainContainer'); root.classList.remove('difficulty-easy','difficulty-medium','difficulty-hard'); if(state.difficulty==='easy') root.classList.add('difficulty-easy'); else if(state.difficulty==='medium') root.classList.add('difficulty-medium'); else root.classList.add('difficulty-hard'); }

  // Utility to render and initial
  function renderInitialUI(){ renderEssences(); renderAchievements(); renderTraits(); }

  // populate initial essences for UI preview before start
  state.difficulty = difficultyEl.value; initEssences(); renderInitialUI();

  // small helper to compute icon by key used in logs
  function iconFor(k){ const e = ALL_ESSENCES.find(x=>x.k===k); return e? e.icon : '' }

  // load event pool once to expand variety (we dedup similar repeating scenes)
  
// 1. Define helper
function spawnFloat(el, text) {
  const floatEl = document.createElement('div');
  floatEl.textContent = text;
  floatEl.className = "year-float";

  // Find nearest card container
  const card = el.closest('.card');
  if (!card) return;

  card.style.position = "relative";
  card.style.overflow = "visible";
  floatEl.style.position = "absolute";

  const rect = el.getBoundingClientRect();
  const cardRect = card.getBoundingClientRect();
  floatEl.style.left = (rect.left - cardRect.left + rect.width / 2) + "px";
  floatEl.style.top  = (rect.top - cardRect.top - 10) + "px";

  card.appendChild(floatEl);

  setTimeout(() => floatEl.remove(), 1000);
}

// 2. Later in your decision handler:
state.decisionsThisDecade = (state.decisionsThisDecade || 0) + 1;
decCountEl.textContent = state.decisionsThisDecade;

if (state.decisionsThisDecade >= 6) {
  setTimeout(() => {
    decCountEl.classList.add('fade-out-in');
    yearEl.classList.add('fade-out-in');
    // (if you have decadeEl too)
    decadeEl.classList.add('fade-out-in');

    setTimeout(() => {
      state.decisionsThisDecade = 0;
      decCountEl.textContent = state.decisionsThisDecade;

      state.decadeNumber = (state.decadeNumber || 1) + 1;
      state.year = (state.year || 1512) + 10;
      yearEl.textContent = state.year;
      decadeEl.textContent = state.decadeNumber;

      // ðŸŽ‰ Use helper here
      spawnFloat(yearEl, "+10 years");
      spawnFloat(decCountEl, "+1 decade");
    }, 300);

    setTimeout(() => {
      decCountEl.classList.remove('fade-out-in');
      yearEl.classList.remove('fade-out-in');
      decadeEl.classList.remove('fade-out-in');
    }, 600);
  }, 600);
}

// --- Enhanced modal accessibility & floating window ---
// Ensure overlay is a proper floating dialog with focus trap, ESC to close, and draggable header.
(function(){
  const overlay = document.getElementById('nameOverlay');
  if(!overlay) return;
  overlay.setAttribute('role','dialog');
  overlay.setAttribute('aria-modal','true');
  overlay.setAttribute('aria-hidden','true');
  // create a visually clear modal container if not already
  const card = overlay.querySelector('.card');
  card.setAttribute('tabindex','-1');
  card.style.maxWidth = '520px';
  card.style.width = 'min(92%,540px)';
  card.style.margin = '0';
  card.style.cursor = 'grab';
  card.style.position = 'relative';
  card.style.zIndex = 60;
  card.style.boxShadow = '0 30px 80px rgba(2,6,23,0.8)';
  card.style.border = '1px solid rgba(255,255,255,0.06)';
  // center overlay style
  overlay.style.display = 'none';
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.background = 'linear-gradient(180deg, rgba(2,6,12,0.45), rgba(2,6,12,0.6))';
  overlay.style.backdropFilter = 'blur(4px)';
  overlay.style.zIndex = 50;
  // Add aria labels if missing
  const title = card.querySelector('div') && card.querySelector('div').textContent || 'Persona selection';
  card.setAttribute('aria-label', title);
  // Focus trap variables
  let previouslyFocused = null;
  function trapFocus(e){
    const focusable = card.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(focusable.length === 0) return;
    const first = focusable[0], last = focusable[focusable.length-1];
    if(e.key === 'Tab'){
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    } else if(e.key === 'Escape'){
      hideNameOverlay();
    }
  }
  // Redefine show/hide functions to manage focus and background inertness
  const existingShow = window.showNameOverlay || function(){ overlay.style.display='flex'; };
  const existingHide = window.hideNameOverlay || function(){ overlay.style.display='none'; };
  window.showNameOverlay = function(){
    previouslyFocused = document.activeElement;
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    setTimeout(()=>{ const focusable = card.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'); if(focusable.length) focusable[0].focus(); else card.focus(); }, 40);
    document.addEventListener('keydown', trapFocus);
  };
  window.hideNameOverlay = function(){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', trapFocus);
    if(previouslyFocused && previouslyFocused.focus) previouslyFocused.focus();
  };
  // Make modal draggable by pointer on the card
  (function makeDraggable(){
    let isDown=false, startX=0, startY=0, origLeft=0, origTop=0;
    card.style.touchAction = 'none';
    card.addEventListener('pointerdown', (ev)=>{
      isDown=true; card.setPointerCapture(ev.pointerId);
      startX = ev.clientX; startY = ev.clientY;
      const rect = card.getBoundingClientRect();
      origLeft = rect.left; origTop = rect.top;
      card.style.transition = 'none';
      card.style.cursor = 'grabbing';
    });
    window.addEventListener('pointermove', (ev)=>{
      if(!isDown) return;
      let dx = ev.clientX - startX;
      let dy = ev.clientY - startY;
      card.style.transform = `translate(${dx}px, ${dy}px)`;
    });
    window.addEventListener('pointerup', (ev)=>{
      if(!isDown) return;
      isDown=false; card.style.cursor='grab';
      // animate back to center
      card.style.transition = 'transform .42s cubic-bezier(.2,.9,.3,1)';
      card.style.transform = '';
    });
  })();
})();
})();

});</script>
<!-- ==== GAME OVER (glass buttons, smooth log transition) ==== -->
<style>
  /* Overlay fade */
  #gameOverOverlay {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s ease;
  }
  #gameOverOverlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Card fade + scale */
  #gameOverOverlay .card {
    transform: scale(0.96);
    opacity: 0;
    transition: transform 0.35s ease, opacity 0.35s ease;
  }
  #gameOverOverlay.visible .card {
    transform: scale(1);
    opacity: 1;
  }

  /* Glass-style buttons */
  #gameOverOverlay .glass-btn {
    padding: 10px 16px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.25s ease, transform 0.2s ease;
  }
  #gameOverOverlay .glass-btn:hover {
    background: rgba(255, 255, 255, 0.18);
    transform: translateY(-1px);
  }
  #gameOverOverlay .glass-btn:active {
    transform: translateY(0);
  }

  /* Smooth log panel */
  #gameOverLog {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    background: rgba(255, 255, 255, 0.05);
    padding: 0 8px;
    border-radius: 8px;
    text-align: left;
    font-size: 14px;
    line-height: 1.4em;
    transition: max-height 0.35s ease, opacity 0.35s ease, padding 0.35s ease;
  }
  #gameOverLog.open {
    max-height: 200px;
    opacity: 1;
    padding: 6px 8px;
    overflow-y: auto;
  }
  /* Light mode adjustments for glass buttons in Game Over popup */
body.light-mode #gameOverOverlay .glass-btn {
  color: #1b1b1b; /* Dark text for visibility */
  border-color: rgba(0,0,0,0.25);
  background: rgba(255,255,255,0.4);
}
body.light-mode #gameOverOverlay .glass-btn:hover {
  background: rgba(255,255,255,0.55);
}
</style>
<div class="overlay" id="gameOverOverlay" inert="" style="display:flex;align-items:center;justify-content:center;">
<div class="card" style="max-width:520px;width:92%;text-align:center;">
<div style="font-size:26px;font-weight:800;color:var(--accent-a);margin-bottom:12px;">
      Game Over
    </div>
<div id="gameOverMessage" style="margin-bottom:12px;font-size:18px;font-weight:700;">
      Your reign has ended.
    </div>
<div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:8px;margin-top:8px;">
<button class="glass-btn" id="toggleGameOverLog" style="width:100%;margin-bottom:6px;">Show Log</button>
<div id="gameOverLog"><i>No log available.</i></div>
</div>
<div style="display:flex;gap:8px;margin-top:12px;justify-content:center;flex-wrap:wrap;">
<button class="glass-btn" id="restartGameOver" style="flex:1;min-width:120px;">Restart</button>
<button class="glass-btn" id="dismissGameOver" style="flex:1;min-width:120px;">Dismiss</button>
</div>
</div>
</div>
<script>
(function () {
  const overlay     = document.getElementById('gameOverOverlay');
  const msgEl       = document.getElementById('gameOverMessage');
  const logEl       = document.getElementById('gameOverLog');
  const toggleBtn   = document.getElementById('toggleGameOverLog');
  const restartBtn  = document.getElementById('restartGameOver');
  const dismissBtn  = document.getElementById('dismissGameOver');

  let storedLogHTML = '<i>No log available.</i>';

  function show(reason) {
    // Run achievements check first
    if (typeof window.checkAchievements === 'function') {
      window.checkAchievements();
    }

    msgEl.textContent = reason || 'Your reign has ended.';

    requestAnimationFrame(() => {
      let liveLog = document.querySelector('#log') || document.querySelector('.log');
      if (liveLog && liveLog.innerHTML.trim() !== '') {
        storedLogHTML = liveLog.innerHTML;
      } else {
        storedLogHTML = '<i>No log available.</i>';
      }

      logEl.classList.remove('open'); // ensure log is closed
      toggleBtn.textContent = 'Show Log';

      overlay.classList.add('visible');
      overlay.removeAttribute('inert'); // âœ… allow interaction again
      document.body.style.overflow = 'hidden';

      // âœ… move focus for accessibility
      dismissBtn.focus();
    });
  }

  function hide() {
    overlay.classList.remove('visible');
    overlay.setAttribute('inert', ''); // âœ… disable focus/interaction
    document.body.style.overflow = '';
  }

  toggleBtn.addEventListener('click', () => {
    const willOpen = !logEl.classList.contains('open');
    if (willOpen) {
      logEl.innerHTML = storedLogHTML;
      logEl.classList.add('open');
    } else {
      logEl.classList.remove('open');
    }
    toggleBtn.textContent = willOpen ? 'Hide Log' : 'Show Log';
  });

  restartBtn.addEventListener('click', () => {
    hide(); // close the game over overlay

    if (typeof showNameOverlay === 'function') {
      showNameOverlay();
    } else {
      const nameOverlay = document.getElementById('nameOverlay');
      if (nameOverlay) {
        nameOverlay.style.display = 'flex';
        nameOverlay.removeAttribute('inert'); // âœ… also switch here
      }
    }
  });

  dismissBtn.addEventListener('click', hide);

  window.showGameOverOverlay = show;
  window.hideGameOverOverlay = hide;
  window.triggerGameOver = (msg) => show(msg || 'Debug trigger');
})();

</script>
<!-- === Heir Minigame Popup === -->
<!-- Floating Test Button 
<button id="testHeirBtn">Test Heir Minigame</button>

<style>
  #testHeirBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 2147483647; /* MAX z-index to stay above everything */
    background: #444;
    color: #fff;
    border: none;
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-family: sans-serif;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    cursor: pointer;
  }
  #testHeirBtn:active {
    transform: scale(0.95); /* press effect */
  }
</style>

<script>
  // Attach event after DOM loads
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("testHeirBtn");
    if (btn) {
      btn.addEventListener("click", () => {
        if (typeof startHeirMinigame === "function") {
          startHeirMinigame();
        } else {
          alert("âŒ startHeirMinigame() not loaded yet.");
        }
      });
    }
  });
</script>
-->
<script>
// âœ… Define pool first
const essencePool = [
  { k: "Population", icon: "ðŸ‘¥" },
  { k: "Money", icon: "ðŸ’°" },
  { k: "Strength", icon: "ðŸ—¡ï¸" },
  { k: "Religion", icon: "âœï¸" },
  { k: "Culture", icon: "ðŸŽ­" },
  { k: "Education", icon: "ðŸŽ“" },
  { k: "Control", icon: "ðŸ›ï¸" }
];

// Utility: get consistent card size for scenario/finale cards
function getCardSize() {
  const sample = document.querySelector(".heir-card");
  if (sample) {
    return {
      width: sample.offsetWidth + "px",
      height: sample.offsetHeight + "px"
    };
  }
  // fallback default
  return { width: "300px", height: "400px" };
}

function startHeirMinigame() {
  // --- Intro Cards (no effect on relationship) ---
  const introCards = [
    {
      text: "<span class='heir-intro-headline'>You've entered a Mini Game!</span><br><i>Direction: Swipe left to accept, swipe right to decline.</i>",
      acceptCaption: "Accept",
      declineCaption: "Decline"
    },
    {
      text: "âš”ï¸ Born of immortal blood, your heir will only live ten short years. Every decision matters.",
      acceptCaption: "I understand",
      declineCaption: "Move on"
    },
    {
      text: "ðŸŒ™ The candles flicker. Tonight marks the first of many choicesâ€¦ what path will your heir take?",
      acceptCaption: "Begin",
      declineCaption: "Not Ready"
    }
  ];

  // --- Scenario Cards (affect relationship bar) ---
  const scenarios = [
    {
      text: "Your heir grips a wooden sword, arms trembling. The training yard watches in silence. 'I want to be remembered,' they whisper, eyes blazing with fragile resolve.",
      acceptCaption: "Let them push through",
      declineCaption: "Teach them to pace their strength",
      effects: { accept: +5, decline: +10 }
    },
    {
      text: "At the royal feast, your heir slips bread into a servantâ€™s sleeve. Later, nobles mock the gesture as sentimental weakness. The servant bows, eyes wet.",
      acceptCaption: "Praise their heart",
      declineCaption: "Teach the cost of kindness",
      effects: { accept: +10, decline: -5 }
    },
    {
      text: "By candlelight, your heir asks, 'Can immortals love without fear?' Their voice is steady, but their hand tremblesâ€”afraid of being forgotten by those who endure.",
      acceptCaption: "Say love transcends time",
      declineCaption: "Say love fears time most of all",
      effects: { accept: -5, decline: +10 }
    },
    {
      text: "A sparrow lies broken in the courtyard. Your heir refuses to leave its side, whispering stories to keep it alive. The bird does not stir.",
      acceptCaption: "Stay and help them hope",
      declineCaption: "Teach the mercy of release",
      effects: { accept: +5, decline: +5 }
    },
    {
      text: "The court murmurs: a short-lived heir is a tragedy, not a legacy. One noble asks if you regret their birth.",
      acceptCaption: "Defend them with fire",
      declineCaption: "Let silence speak for you",
      effects: { accept: +5, decline: 0 }
    },
    {
      text: "In the great hall, your heir challenges a seasoned noble on justice. Their words are sharp, but their voice cracks. The noble smiles, amused.",
      acceptCaption: "Stand beside them",
      declineCaption: "Counsel restraint",
      effects: { accept: +10, decline: -5 }
    },
    {
      text: "You find your heir sketching maps of lands beyond the palace. 'If I run far enough,' they say, 'maybe time wonâ€™t find me.'",
      acceptCaption: "Let them dream of escape",
      declineCaption: "Anchor them in duty",
      effects: { accept: -5, decline: +10 }
    },
    {
      text: "In the marketplace, your heir gives away their only toy to a sobbing child. That night, they stare at the empty shelf, silent.",
      acceptCaption: "Celebrate their generosity",
      declineCaption: "Teach the value of self-preservation",
      effects: { accept: +5, decline: +5 }
    },
    {
      text: "After overhearing whispers of their fate, your heir asks, 'Will I vanish like a story no one finishes?'",
      acceptCaption: "Speak the truth, however cruel",
      declineCaption: "Wrap them in comforting lies",
      effects: { accept: -5, decline: +10 }
    },
    {
      text: "The Queen holds your heir close, her tears soaking into their tunic. She does not speak, but her grief is a storm barely contained.",
      acceptCaption: "Hold her through the silence",
      declineCaption: "Leave her to mourn alone",
      effects: { accept: +10, decline: -5 }
    }
  ];

  // Combine â†’ intros first, then scenarios
  const allCards = [...introCards, ...scenarios];
  const introCount = introCards.length;

  // --- Overlay + UI ---
  let current = 0;          // index of FRONT card inside allCards
  let nextIndex = 3;        // next card to spawn as BACK (0,1,2 are on screen)
  let relationship = 50;

  const overlay = document.createElement("div");
  overlay.className = "heir-overlay show";
  document.body.appendChild(overlay);

  // Cards container
  const cardsContainer = document.createElement("div");
  cardsContainer.className = "heir-cards-container";
  overlay.appendChild(cardsContainer);

  // === Relationship Bar ===
  const relWrapper = document.createElement("div");
  relWrapper.className = "heir-rel-wrapper";
  overlay.appendChild(relWrapper);

  const relBar = document.createElement("div");
  relBar.className = "heir-relationship-bar";
  relWrapper.appendChild(relBar);

  let essencesRow; // keep reference for updates

  // âœ… Use the main gameâ€™s difficulty value
  setupRelationshipBar(difficulty);
  updateBar();

// Build the minigame relationship bar with the SAME segment count as main game
function setupRelationshipBar() {
  let segments = 5; // default
  
  // 1) Try DOM â†’ main game's essences list
  const list = document.getElementById('essencesList');
  if (list) {
    const count = list.querySelectorAll('.ess').length;
    if (count > 0) segments = count;
  } 
  // 2) Fallback to game state object
  else if (window.state && state.essences) {
    const count = Object.keys(state.essences).length;
    if (count > 0) segments = count;
  } 
  // 3) Fallback to difficulty flag
  else if (window.state && state.difficulty) {
    segments = state.difficulty === 'easy' ? 5 : 7;
  }

  // --- Clear old ---
  relBar.innerHTML = '';
  if (typeof essencesRow !== 'undefined' && essencesRow && essencesRow.parentElement) {
    essencesRow.remove();
  }

  // --- Segments row ---
  for (let i = 0; i < segments; i++) {
    const seg = document.createElement('div');
    seg.className = 'heir-bar-segment';
    const fill = document.createElement('div');
    fill.className = 'heir-bar-fill';
    seg.appendChild(fill);
    relBar.appendChild(seg);
  }

  // --- Essence icons row (emoji instead of plain circles) ---
  essencesRow = document.createElement('div');
  essencesRow.className = 'heir-essences';
  for (let i = 0; i < segments; i++) {
    const icon = document.createElement('div');
    icon.className = 'essence';
    icon.textContent = essencePool[i].icon; // âœ… show emoji
    essencesRow.appendChild(icon);
  }
  relWrapper.appendChild(essencesRow);
}

// === Update Relationship Bar ===
// Fills like one continuous bar & triggers essence pop
function updateBar(value = relationship) {
  const segments = relBar.querySelectorAll(".heir-bar-segment");
  const essences = essencesRow.querySelectorAll(".essence");
  const total = segments.length;
  const filled = (value / 100) * total;

  segments.forEach((seg, i) => {
    const fill = seg.querySelector(".heir-bar-fill");

    if (filled >= i + 1) {
      // fully filled
      fill.style.width = "100%";
      if (!essences[i].classList.contains("active")) {
        essences[i].classList.add("active", "pop");
        setTimeout(() => essences[i].classList.remove("pop"), 400);
      }
    } else if (filled > i) {
      // partially filled
      const percent = (filled - i) * 100;
      fill.style.width = percent + "%";
      essences[i].classList.remove("active");
    } else {
      // empty
      fill.style.width = "0%";
      essences[i].classList.remove("active");
    }
  });
}

// === Update Relationship Bar ===
// Makes the fill *fluid* like one continuous bar
function updateBar(value = relationship) {
  const segments = relBar.querySelectorAll(".heir-bar-segment");
  const essences = essencesRow.querySelectorAll(".essence");
  const total = segments.length;
  const filled = (value / 100) * total; // how many "segment units" are filled

  segments.forEach((seg, i) => {
    const fill = seg.querySelector(".heir-bar-fill");

    if (filled >= i + 1) {
      // completely filled
      fill.style.width = "100%";
      essences[i].classList.add("active");
    } else if (filled > i) {
      // partially filled
      const percent = (filled - i) * 100;
      fill.style.width = percent + "%";
      essences[i].classList.add("active");
    } else {
      // empty
      fill.style.width = "0%";
      essences[i].classList.remove("active");
    }
  });
}

// === Animate Relationship from 0 â†’ target ===
function animateRelationship(target = 50, duration = 2000) {
  const start = performance.now();
  const initial = 0;

  function step(now) {
    const progress = Math.min((now - start) / duration, 1);
    relationship = initial + (target - initial) * progress;
    updateBar(relationship);

    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// === Initialize ===
relationship = 0;
setupRelationshipBar("easy");
updateBar(0);
animateRelationship(50, 2000);

  // Helpers
  const isIntro = (idx) => idx < introCount;

// === Configurable sizes ===
const CARD_SIZES = {
  desktop: { width: "380px", height: "55vh" },
  mobile:  { width: "80%",   height: "45vh" }
};

// Helper to pick based on viewport
function getCardSize() {
  return window.innerWidth <= 768 ? CARD_SIZES.mobile : CARD_SIZES.desktop;
}

// --- inside buildCard() ---
function buildCard(cardData, roleClass, enterDelay = 0) {
  const { width, height } = getCardSize();

  const el = document.createElement("div");
  el.className = "heir-card enter " + (roleClass || "");
  el.style.width = width;
  el.style.height = height;

  el.innerHTML = `
    <div class="heir-text">${cardData.text}</div>
    <div class="heir-tint"></div>
    <div class="heir-label accept">${cardData.acceptCaption || "ACCEPT"}</div>
    <div class="heir-label decline">${cardData.declineCaption || "DECLINE"}</div>
  `;

  cardsContainer.appendChild(el);

  // Slide-up entrance
  requestAnimationFrame(() => {
    setTimeout(() => {
      el.classList.remove("enter");
    }, enterDelay);    
  });

  return el;
}

function enableSwipe(card) {
  let startX = 0, currentX = 0, dragging = false;
  const acceptLabel = card.querySelector(".heir-label.accept");
  const declineLabel = card.querySelector(".heir-label.decline");
  const tint = card.querySelector(".heir-tint");

  const onDown = (e) => {
    dragging = true;
    startX = e.touches ? e.touches[0].clientX : e.clientX;
    card.style.transition = "none";
  };

  const onMove = (e) => {
    if (!dragging) return;
    currentX = (e.touches ? e.touches[0].clientX : e.clientX) - startX;
    card.style.transform = `translateX(${currentX}px) rotate(${currentX/20}deg)`;

    const strength = Math.min(Math.abs(currentX) / 150, 1);

    if (currentX < 0) { // â¬…ï¸ ACCEPT
      tint.style.background = `rgba(0,255,153,${0.35 * strength})`;
      acceptLabel.style.opacity = strength;
      declineLabel.style.opacity = 0;
      acceptLabel.style.right = "20px";
      acceptLabel.style.left = "auto";
    } else if (currentX > 0) { // âž¡ï¸ DECLINE
      tint.style.background = `rgba(255,68,68,${0.35 * strength})`;
      declineLabel.style.opacity = strength;
      acceptLabel.style.opacity = 0;
      declineLabel.style.left = "20px";
      declineLabel.style.right = "auto";
    } else {
      tint.style.background = "transparent";
      acceptLabel.style.opacity = 0;
      declineLabel.style.opacity = 0;
    }
  };

  const onUp = () => {
    if (!dragging) return;
    dragging = false;

    if (currentX < -100) { // left = ACCEPT
      if (!isIntro(current)) { relationship = Math.min(100, relationship + 10); updateBar(); }
      card.classList.add("swipe-left");  // outgoing anim
      // ðŸš« donâ€™t reset tint/labels here â†’ let them move with card
      advanceStack("left");
    } else if (currentX > 100) { // right = DECLINE
      if (!isIntro(current)) { relationship = Math.max(0, relationship - 10); updateBar(); }
      card.classList.add("swipe-right");
      advanceStack("right");
    } else {
      // reset only if not past threshold
      card.style.transition = "transform 0.3s ease";
      card.style.transform = "translateX(0) rotate(0)";
      tint.style.background = "transparent";
      acceptLabel.style.opacity = 0;
      declineLabel.style.opacity = 0;
    }
  };

  card.addEventListener("mousedown", onDown);
  card.addEventListener("mousemove", onMove);
  card.addEventListener("mouseup", onUp);
  card.addEventListener("mouseleave", onUp);
  card.addEventListener("touchstart", onDown, { passive: true });
  card.addEventListener("touchmove", onMove, { passive: true });
  card.addEventListener("touchend", onUp);
}

let frontEl = null, middleEl = null, backEl = null;

// Initial stack (intro/tutorial or scenarios)
function setupInitialStack() {
  // FRONT
  if (allCards[0]) {
    frontEl = buildCard(allCards[0], "heir-front", 0);
    enableSwipe(frontEl);
  }
  // MIDDLE
  if (allCards[1]) {
    middleEl = buildCard(allCards[1], "heir-middle", 150);
  }
  // BACK
  if (allCards[2]) {
    backEl = buildCard(allCards[2], "heir-back", 300);
  }
}

function advanceStack(dir) {
  const outgoing = frontEl;
  outgoing.style.zIndex = 99;
  outgoing.classList.add(dir === "right" ? "swipe-right" : "swipe-left");

  outgoing.addEventListener("animationend", () => {
    outgoing.remove();
    current++;

    // âœ… End of deck â†’ show finale card
    if (current >= allCards.length) {
      showFinaleCard(relationship, overlay);
      return;
    }

    // Promote MIDDLE â†’ FRONT
    if (middleEl) {
      middleEl.classList.remove("heir-middle");
      void middleEl.offsetWidth; // reflow
      middleEl.classList.add("heir-front");
    }

    // Promote BACK â†’ MIDDLE
    if (backEl) {
      backEl.classList.remove("heir-back");
      void backEl.offsetWidth;
      backEl.classList.add("heir-middle");
    }

    // Update references
    frontEl  = middleEl || null;
    middleEl = backEl || null;
    backEl   = null;

    // Spawn a new BACK card
    if (nextIndex < allCards.length) {
      backEl = buildCard(allCards[nextIndex++], "heir-back fade-in");
      backEl.addEventListener(
        "animationend",
        () => backEl.classList.remove("fade-in"),
        { once: true }
      );
    }

    // Enable swipe on the new front card
    if (frontEl) {
      frontEl.style.transform = "";
      enableSwipe(frontEl);
    }
  }, { once: true });
}

setupInitialStack();
} 

function showFinaleCard(finalValue, overlay) {
  const { width, height } = getCardSize(); 

  // --- Find last active essence ---
  const activeEssences = overlay.querySelectorAll(".heir-essences .essence.active");
  const lastEssence = activeEssences[activeEssences.length - 1];

  let essenceEmoji = "âŒ";
  let title = "Legacy";
  let storyText = "Your heirâ€™s journey has forged a unique destiny.";
  let perk = "";

  // --- Special case: 0% relationship (no essences at all) ---
  if (!lastEssence && finalValue === 0) {
    essenceEmoji = "ðŸ’”";
    title = "Forgotten Heir";
    storyText = "You shared no bond with your heir. Their short life passed quietly, unmarked by memory or song. History will not remember them.";
    perk = "No Perk Gained";
  } 
  // --- Normal essence finales ---
  else if (lastEssence) {
    essenceEmoji = lastEssence.textContent.trim();
    switch (essenceEmoji) {
      case "ðŸ‘¥":
        title = "Voice of the People";
        storyText = "Your heir spent their short life among the common folk, lifting voices no ruler dared hear. In their memory, the people rally at your side.";
        perk = "+5 Population Perk";
        break;
      case "ðŸ’°":
        title = "Heirâ€™s Treasury";
        storyText = "Though they lived shortly, your heir left behind careful notes and small treasures. Merchants bring you gifts in their name.";
        perk = "+5 Money Perk";
        break;
      case "ðŸ—¡ï¸":
        title = "Inherited Valor";
        storyText = "The childâ€™s spirit burns on in your army. They become a symbol of courage, etched into banners and war cries.";
        perk = "+5 Strength Perk";
        break;
      case "âœï¸":
        title = "Blessed Memory";
        storyText = "Priests claim your heir was a saint in mortal form, their fleeting life proof of divine design.";
        perk = "+5 Religion Perk";
        break;
      case "ðŸŽ­":
        title = "Immortalized in Song";
        storyText = "Bards immortalize your heirâ€™s deeds in verse and theater, their short story spreading across the realm.";
        perk = "+5 Culture Perk";
        break;
      case "ðŸŽ“":
        title = "Written Legacy";
        storyText = "Your heirâ€™s scribbles and journals are compiled into tomes that scholars now study, inspiring generations to come.";
        perk = "+5 Education Perk";
        break;
      case "ðŸ›ï¸":
        title = "Symbol of Authority";
        storyText = "Even in death, your heirâ€™s legacy legitimizes your dynasty. Nobles fall in line, unwilling to betray one marked by destiny.";
        perk = "+5 Control Perk";
        break;}
  
  // --- Finale Card ---
  const card = document.createElement("div");
  card.className = "heir-card finale-card entering";
  Object.assign(card.style, {
    width: "var(--finale-card-width, auto)",
    height: "var(--finale-card-height, auto)",
    marginTop: "var(--finale-card-top-space, auto)"
  });

  card.innerHTML = `
    <div class="heir-text">
      <p>${title}</p>
      <p>Your bond with your heir has reached <b>${finalValue}%</b>.</p>
      <p>${storyText}</p>
      <p><i>${perk}</i></p>
      <button class="heir-continue">Continue</button>
    </div>
  `;

  overlay.querySelector(".heir-cards-container").appendChild(card);

  requestAnimationFrame(() => card.classList.add("entering"));

  // Animate fly-in essence ONLY if one exists
  if (lastEssence) {
    // your flyIcon animation logic stays here...
  }

  card.querySelector(".heir-continue").addEventListener("click", () => {
    overlay.remove();
  });
}

/* âœ… Simple utility finale text card */
function buildFinaleCard(finalRelationship, overlay) {
  const { width, height } = getCardSize();

  const card = document.createElement("div");
  card.className = "heir-card finale-card";
  Object.assign(card.style, {
    width: "var(--finale-card-width, auto)",
    height: "var(--finale-card-height, auto)",
    marginTop: "var(--finale-card-top-space, auto)",
    opacity: "0"
  });

  requestAnimationFrame(() => {
    card.style.transition = "all 0.6s ease";
    card.style.opacity = "1";
  });

  card.querySelector(".heir-continue").addEventListener("click", () => {
    overlay.remove();
  });

  return card;
}

/* Utility: find the dominant essence */
function getDominantEssence() {
  const segments = relBar.querySelectorAll(".heir-bar-segment .heir-bar-fill");
  let filledRatio = 0;
  let dominantIndex = 0;

  segments.forEach((fill, i) => {
    const width = parseFloat(fill.style.width) || 0;
    if (width > filledRatio) {
      filledRatio = width;
      dominantIndex = i;
    }
  });

  return essencePool[dominantIndex]; // {k, icon}
}
 
  // --- Finale Card ---
  const card = document.createElement("div");
  card.className = "heir-card finale-card entering";
  Object.assign(card.style, {
    width: "var(--finale-card-width, auto)",
    height: "var(--finale-card-height, auto)",
    marginTop: "var(--finale-card-top-space, auto)"
  });

  card.innerHTML = `
    <div class="heir-text">
      <h2>${title}</h2>
      <p>Your bond with your heir has reached <b>${finalValue}%</b>.</p>
      <p>${storyText}</p>
      <p><i>${perk}</i></p>
      <button class="heir-continue">Continue</button>
    </div>
  `;

  overlay.querySelector(".heir-cards-container").appendChild(card);

  // Animate card in
  requestAnimationFrame(() => card.classList.add("entering"));
  
  // --- Essence fly animation ---
  if (lastEssence) {
    const rectFrom = lastEssence.getBoundingClientRect();

    // Create a clone for the fly animation
    const flyIcon = lastEssence.cloneNode(true);
    Object.assign(flyIcon.style, {
      position: "fixed",
      left: rectFrom.left + "px",
      top: rectFrom.top + "px",
      width: rectFrom.width + "px",
      height: rectFrom.height + "px",
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      fontSize: "24px",
      lineHeight: "1",
      zIndex: "10000",
      transition: "all 0.9s cubic-bezier(0.22, 1, 0.36, 1)"
    });
    document.body.appendChild(flyIcon);

    // Fade out the original
    lastEssence.style.transition = "opacity 0.1s ease";
    lastEssence.style.opacity = "0";

    // Animate the clone
    requestAnimationFrame(() => {
      const cardRect = card.getBoundingClientRect();
      const header = document.querySelector(".finale-essence-header");
      let targetX, targetY;

      if (header) {
        const rootStyles = getComputedStyle(document.documentElement);
        const isLandscape = window.innerWidth > window.innerHeight;

        const topVar = isLandscape
          ? rootStyles.getPropertyValue("--emoji-top-landscape").trim()
          : rootStyles.getPropertyValue("--emoji-top-portrait").trim();

        const leftVar = isLandscape
          ? rootStyles.getPropertyValue("--emoji-left-landscape").trim()
          : rootStyles.getPropertyValue("--emoji-left-portrait").trim();

        if (topVar && leftVar) {
          // âœ… Manual override from CSS variables
          targetX = leftVar.endsWith("%")
            ? (window.innerWidth * parseFloat(leftVar)) / 100
            : parseFloat(leftVar);

          targetY = topVar.endsWith("%")
            ? (window.innerHeight * parseFloat(topVar)) / 100
            : parseFloat(topVar);
        } else {
          // Fallback â†’ center of header
          const hr = header.getBoundingClientRect();
          targetX = hr.left + (hr.width - rectFrom.width) / 2;
          targetY = hr.top + (hr.height - rectFrom.height) / 2;
        }
      } else if (window.innerWidth > window.innerHeight) {
        // Landscape fallback â†’ left of card
        targetX = cardRect.left - rectFrom.width - 20;
        targetY = cardRect.top + cardRect.height / 1.4 - rectFrom.height / 2;
      } else {
        // Portrait fallback â†’ above card
        targetX = cardRect.left + cardRect.width / 1.92 - rectFrom.width / 2;
        targetY = cardRect.top - rectFrom.height - 20;
      }

      flyIcon.style.left = targetX + "px";
      flyIcon.style.top = targetY + "px";
      flyIcon.style.fontSize = "40px";
      flyIcon.style.transform = "scale(2)";
    });

    // Hide original essence
    setTimeout(() => {
      lastEssence.style.visibility = "hidden";
    }, 150);
  }
  
  // Continue button â†’ close overlay
  card.querySelector(".heir-continue").addEventListener("click", () => {
    overlay.remove();
  });
}

</script>

<style> 
/* === Relationship Bar Wrapper (fixed top HUD) === */
.heir-rel-wrapper {
  position: absolute;
  top: 20px;              
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 500px;
  z-index: 20000;

  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;   /* ðŸ”¥ extra space between bar and circles */
}

/* Relationship bar */
.heir-relationship-bar {
  display: flex;
  gap: 6px;
  width: 100%;
  height: 18px;
}

/* Each segment */
.heir-bar-segment {
  flex: 1;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.heir-bar-fill {
  height: 100%;
  width: 0%;
  transition: width 0.4s ease;
  border-radius: 6px;
  background: currentColor;   /* âœ… now the bar fill is colored */
}

/* Essences row mirrors the bar layout */
.heir-essences {
  display: flex;
  gap: 6px;
  width: 100%;
  justify-content: space-between; /* align with bar segments */
}

.essence {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;     /* emoji size */
  opacity: 0.5;
  transition: opacity 0.3s ease, transform 0.3s ease, filter 0.3s ease;
}

.essence.active {
  opacity: 1;
  transform: scale(1.2);
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.7));
}

/* ðŸŒˆ Different colors per essence (first 7) */
.essence:nth-child(1),
.heir-bar-segment:nth-child(1) .heir-bar-fill { color: #ff5555; }
.essence:nth-child(2),
.heir-bar-segment:nth-child(2) .heir-bar-fill { color: #ffaa33; }
.essence:nth-child(3),
.heir-bar-segment:nth-child(3) .heir-bar-fill { color: #ffee33; }
.essence:nth-child(4),
.heir-bar-segment:nth-child(4) .heir-bar-fill { color: #44dd44; }
.essence:nth-child(5),
.heir-bar-segment:nth-child(5) .heir-bar-fill { color: #33bbff; }
.essence:nth-child(6),
.heir-bar-segment:nth-child(6) .heir-bar-fill { color: #aa66ff; }
.essence:nth-child(7),
.heir-bar-segment:nth-child(7) .heir-bar-fill { color: #ff66cc; }

/* Wrapper fade-in */
.heir-rel-wrapper {
  position: absolute;
  top: 20px;              
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 500px;
  z-index: 20000;

  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;

  opacity: 0;
  animation: fadeInRel 1s ease forwards;
}

@keyframes fadeInRel {
  to { opacity: 1; }
}

/* ðŸš€ Start offscreen bottom */
.heir-card.enter {
  transform: translateY(100vh) scale(1);
}

/* Entrance transition: extra slow settle */
.heir-card {
  transition: transform 2.5s cubic-bezier(0.85, 0, 0.15, 1), opacity 2s ease;
  /* cubic-bezier = very slow ease-in-out, drags at the end */
  will-change: transform, opacity;
}

/* Back card fade-in (keep this if you want that effect only for spawns) */
.heir-card.fade-in {
  opacity: 0;
  transform: translateY(60px) scale(0.9);
  animation: heir-card-fade-in 0.35s ease-out forwards;
}
@keyframes heir-card-fade-in {
  to { opacity: 0.8; transform: translateY(40px) scale(0.94); }
}

.heir-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);  
  backdrop-filter: blur(0px);
  -webkit-backdrop-filter: blur(0px);

  display: flex;
  align-items: center;
  justify-content: center;

  opacity: 0;
  transition: opacity 0.8s ease; /* only opacity here */
  z-index: 9999;

  /* Lock background UI */
  pointer-events: auto;
  touch-action: none;
  overscroll-behavior: contain;
}

body:has(.heir-overlay.show) {
  overflow: hidden;
}

.heir-overlay.show {
  opacity: 1;
  animation: overlay-blur-in 1.2s ease forwards;
}

.heir-overlay.hide {
  opacity: 0;
  animation: overlay-blur-out 1.2s ease forwards;
}

@keyframes overlay-blur-in {
  from { backdrop-filter: blur(1px); -webkit-backdrop-filter: blur(0px); }
  to   { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(10px); }
}

@keyframes overlay-blur-out {
  from { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(10px); }
  to   { backdrop-filter: blur(1px); -webkit-backdrop-filter: blur(0px); }
}

.heir-cards-container {
  position: absolute;
  top: 55%;              
  left: 50%;
  transform: translate(-50%, -50%); 
  width: 90%;
  max-width: 420px;
  height: 60vh;          
  display: flex;
  align-items: center;
  justify-content: center;
  align-items: flex-start; /* ðŸ‘ˆ align items from the top instead of centering */
  padding-top: var(--finale-card-top-space, 20px);
}

.heir-card {
  position: absolute;
  top: 0; left: 0; right: 0;
  margin: auto;
  padding: 20px;
  border-radius: 16px;
  background: #2e3a59;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  color: #fff;
  text-align: center;
  font-size: 1em;
  user-select: none;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: transform 0.35s ease, opacity 0.35s ease;
  will-change: transform, opacity;
}

/* Stack positions */
.heir-front   { z-index: 3; transform: translateY(0) scale(1);    opacity: 1;   }
.heir-middle  { z-index: 2; transform: translateY(20px) scale(0.97); opacity: 1; }
.heir-back    { z-index: 1; transform: translateY(40px) scale(0.94); opacity: 0.8; }

/* Outgoing swipe animations */
.heir-card.swipe-right { animation: heir-card-out-right 0.35s forwards ease-in; }
.heir-card.swipe-left  { animation: heir-card-out-left  0.35s forwards ease-in; }

@keyframes heir-card-out-right {
  to { transform: translateX(100vw) rotate(20deg); opacity: 0; }
}
@keyframes heir-card-out-left {
  to { transform: translateX(-100vw) rotate(-20deg); opacity: 0; }
}

/* Fade-in for new back card */
.heir-card.fade-in {
  opacity: 0;
  transform: translateY(60px) scale(0.9);
  animation: heir-card-fade-in 0.4s ease-out forwards;
}
@keyframes heir-card-fade-in {
  to { opacity: 0.8; transform: translateY(40px) scale(0.94); }
}

.heir-tint {
  position: absolute;
  inset: 0;
  border-radius: 16px;
  background: transparent;
  pointer-events: none;
  z-index: 1;
}

:root {
  --heir-label-font-size: 1.2em;   /* default (mobile portrait) */
}

.heir-label.accept { 
  right: 12px; 
  text-align: right; 
  color: #00ff18; 
}

.heir-label.decline { 
  left: 12px; 
  text-align: left; 
  color: #cf0009; 
}

.heir-label {
  position: absolute;
  top: 20px;   
  max-width: 70%;
  white-space: normal;
  word-break: break-word;
  font-weight: bold;
  padding: 6px 12px;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.10s ease-in; /* âš¡ faster fade */
  pointer-events: none;
  z-index: 10;

  font-size: var(--heir-label-font-size);
  line-height: 1.2;
}

/* Intro headline */
.heir-intro-headline {
  display: block;
  font-size: 1.8em;
  font-weight: 1000;
  margin-bottom: 10px;
  text-align: center;
  color: #ffffff; 
}

.heir-card.finale {
  max-height: 80%;
  padding: 9px;
  box-sizing: border-box;
  overflow-wrap: break-word;
}

.finale-card {
  width: var(--finale-card-width, auto);
  height: var(--finale-card-height, auto);
  margin-top: var(--finale-card-top-space, 0);

  max-width: 90vw;
  max-height: 80vh;

  font-size: clamp(0.9em, 1vw + 0.5em, 1.3em);
  padding: 1em;
  box-sizing: border-box;

  display: flex;
  flex-direction: column;
  justify-content: center;   /* center contents vertically */
  align-items: center;       /* center contents horizontally */  
  text-align: center;
  overflow: hidden;          /* prevent spill */
}

/* Entrance animation */
.finale-card.entering {
  animation: finaleDealIn 0.7s ease forwards;
}
@keyframes finaleDealIn {
  from { transform: translateY(-80px) scale(0.95); opacity: 0; }
  to   { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
}

/* Finale text */
.finale-card .heir-text {
  flex: 1 1 auto;            /* expand but allow shrink */
  max-height: 100%;          /* never overflow vertically */
  max-width: 100%;           /* never overflow horizontally */
  overflow-y: auto;          /* scroll if too tall */
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;   /* center inside available space */
  align-items: center;
  gap: 0.6em;
  padding: 0.5em;
  box-sizing: border-box;
}

.finale-card h2 { font-size: 1.3em; margin: 0.4em 0; }
.finale-card p  { font-size: 1em;   margin: 0.3em 0; }
.finale-card p i { font-size: 0.9em; opacity: 0.85; }

/* Continue button */
.finale-card .heir-continue {
  font-size: 1em;
  margin-top: 1em;           /* spacing from text */
  align-self: center;        /* center horizontally */
  flex-shrink: 0;            /* donâ€™t shrink below usable size */
  max-width: 100%;
  padding: 8px 16px;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  background: #444;
  color: white;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.2s ease;
}
.finale-card .heir-continue:hover {
  background: #666;
  transform: scale(1.05);
}

/* ================================
   ðŸ”¹ ROOT VARIABLES
   ================================ */
:root {
  --heir-label-font-size: 1em;
}

/* ================================
   ðŸ”¹ LABELS
   ================================ */
.heir-label {
  position: absolute;
  top: 20px;
  max-width: 70%;
  white-space: normal;
  word-break: break-word;
  font-weight: bold;
  padding: 6px 12px;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.10s ease-in;
  pointer-events: none;
  z-index: 10;

  font-size: var(--heir-label-font-size);
  line-height: 1.2;
}
.heir-label.accept  { right: 12px; text-align: right; color: #00ff18; }
.heir-label.decline { left: 12px;  text-align: left;  color: #ff0a00; }

/* ================================
   ðŸ”¹ MEDIA QUERIES
   ================================ */

/* ðŸ“± Mobile portrait */
@media (orientation: portrait) {
  .heir-cards-container { height: 35vh;} 

  .finale-card {
    --finale-card-width: 85%;
    --finale-card-height: 40vh;
    --finale-card-top-space: 40px;

    overflow-y: auto;
    font-size: clamp(0.9em, 2vw, 1.1em);
  }

  :root {
    --heir-label-font-size: 1.4em; /* portrait label size */
  }
}

/* ðŸ’» Landscape (small-height devices) */
@media (max-height: 500px) {
  .heir-cards-container {
    height: 35vh;
    width: 95%;
    max-width: 420px;
    top: 46%; 
  }
  
  .heir-intro-headline {
  font-size: 1.6em;
  font-weight: 1000;
}

  .heir-label {
  max-width: 90%;
  padding-top: 5px;
  font-size: 20px;
  line-height: 1.2;
} 

  .heir-card {
    font-size: 0.9em;
    padding: 15px;
  }

  .finale-card {
    --finale-card-width: 370px;
    --finale-card-height: 60vh;
    --finale-card-top-space: 10px;
    font-size: 14px;
}

  .finale-card .heir-text {
    max-height: 90%;
  }

  .finale-card .heir-continue {
    margin-top: 0.7em;
    align-self: center;
    flex-shrink: 0;
    max-width: 100%;
  }
}

/* ðŸ–¥ï¸ Extra-large displays */
@media (min-width: 1600px) {
  .finale-card {
    --finale-card-width: 1200px;
    --finale-card-height: 70vh;
  }

  :root {
    --heir-label-font-size: 2em;
  }
}

</style>

<style>
/* âœ… Make body a flex container to center the UI always */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: top;
  justify-content: center;
}

/* ðŸ“º Landscape mode (phones/tablets under 1024px wide) */
@media screen and (orientation: landscape) and (max-height: 500px) {
  .container {
    display: grid;
    grid-template-columns: 1fr 380px; /* same as PC */
    gap: 18px;
    max-width: 1180px;
    margin: 0 auto;              /* center horizontally */
    justify-content: center;     /* ensure center if smaller */
  }

  .scene {
    margin-top: 0;
  }

  .choices {
    flex-direction: row;
    justify-content: center;
    gap: 12px;
  }

  #sceneCard {
    font-size: 16px; /* slightly smaller for landscape */
    line-height: 1.35;
  }

  .card {
    padding: 14px;
  }

  html, body {
    overflow-y: auto; /* vertical scroll allowed */
    overflow-x: hidden;
    display: flex;            /* center main app */
    justify-content: center;
  }

  /* Scale whole app to fit */
  .app {
    transform: scale(0.92);   /* shrink just a little */
    transform-origin: top center;
  }
}

/* ðŸ”‘ Global override: shrink everything on very small portrait screens */
@media (max-width: 420px) {
  html, body {
    font-size: 16px !important;
    zoom: 0.97; /* compress overall UI */
  }
}

@media (max-width: 320px) {
  html, body {
    zoom: 0.8; /* compress overall UI */    
  }
}

/* ðŸ”‘ Force zoom-out & keep centered when rotated to landscape */
@media (orientation: landscape) and (max-height: 500px) {
  html, body {
    font-size: 17px !important;
    zoom: 0.989 !important;
  }
}
</style>

</body>
</html>
